<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-BR" xml:lang="pt-BR"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.36">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nathalia">

<title>Case Olist</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="script__python_files/libs/clipboard/clipboard.min.js"></script>
<script src="script__python_files/libs/quarto-html/quarto.js"></script>
<script src="script__python_files/libs/quarto-html/popper.min.js"></script>
<script src="script__python_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="script__python_files/libs/quarto-html/anchor.min.js"></script>
<link href="script__python_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="script__python_files/libs/quarto-html/quarto-syntax-highlighting-01c78b5cd655e4cd89133cf59d535862.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="script__python_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="script__python_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="script__python_files/libs/bootstrap/bootstrap-933a14f46f0e4d1503cecf416b5e09b4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="script__python_files/libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">

<script src="script__python_files/libs/tabwid-1.1.3/tabwid.js"></script>

<script src="script__python_files/libs/kePrint-0.0.1/kePrint.js"></script>

<link href="script__python_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tópicos</h2>
   
  <ul>
  <li><a href="#processamento-e-tratamento-de-dados" id="toc-processamento-e-tratamento-de-dados" class="nav-link active" data-scroll-target="#processamento-e-tratamento-de-dados"><span class="header-section-number">1</span> Processamento e tratamento de dados</a>
  <ul class="collapse">
  <li><a href="#resumo-dados-nulos" id="toc-resumo-dados-nulos" class="nav-link" data-scroll-target="#resumo-dados-nulos"><span class="header-section-number">1.1</span> Resumo dados nulos</a></li>
  </ul></li>
  <li><a href="#descritiva" id="toc-descritiva" class="nav-link" data-scroll-target="#descritiva"><span class="header-section-number">2</span> Descritiva</a>
  <ul class="collapse">
  <li><a href="#teste-de-hipótese" id="toc-teste-de-hipótese" class="nav-link" data-scroll-target="#teste-de-hipótese"><span class="header-section-number">2.1</span> Teste de Hipótese</a>
  <ul class="collapse">
  <li><a href="#qual-categoria-está-contribuindo-mais-para-o-valor-gasto-do-cliente" id="toc-qual-categoria-está-contribuindo-mais-para-o-valor-gasto-do-cliente" class="nav-link" data-scroll-target="#qual-categoria-está-contribuindo-mais-para-o-valor-gasto-do-cliente"><span class="header-section-number">2.1.1</span> Qual categoria está contribuindo mais para o valor gasto do cliente?</a></li>
  </ul></li>
  <li><a href="#outras-análises-mais-diretas" id="toc-outras-análises-mais-diretas" class="nav-link" data-scroll-target="#outras-análises-mais-diretas"><span class="header-section-number">2.2</span> Outras análises mais diretas:</a>
  <ul class="collapse">
  <li><a href="#sec-gasto_ava" id="toc-sec-gasto_ava" class="nav-link" data-scroll-target="#sec-gasto_ava"><span class="header-section-number">2.2.1</span> Gasto vs Avaliação</a></li>
  <li><a href="#gasto-vs-primeira-compra" id="toc-gasto-vs-primeira-compra" class="nav-link" data-scroll-target="#gasto-vs-primeira-compra"><span class="header-section-number">2.2.2</span> Gasto vs Primeira compra</a></li>
  <li><a href="#gasto-vs-região" id="toc-gasto-vs-região" class="nav-link" data-scroll-target="#gasto-vs-região"><span class="header-section-number">2.2.3</span> Gasto vs Região</a></li>
  <li><a href="#gasto-vs-dia-da-compra" id="toc-gasto-vs-dia-da-compra" class="nav-link" data-scroll-target="#gasto-vs-dia-da-compra"><span class="header-section-number">2.2.4</span> Gasto vs Dia da compra</a></li>
  <li><a href="#gasto-vs-forma-de-pagamento" id="toc-gasto-vs-forma-de-pagamento" class="nav-link" data-scroll-target="#gasto-vs-forma-de-pagamento"><span class="header-section-number">2.2.5</span> Gasto vs Forma de pagamento</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#componenentes-principais-para-o-cliente" id="toc-componenentes-principais-para-o-cliente" class="nav-link" data-scroll-target="#componenentes-principais-para-o-cliente"><span class="header-section-number">3</span> Componenentes Principais para o Cliente</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Case Olist</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Código</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Autor</div>
    <div class="quarto-title-meta-contents">
             <p>Nathalia </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Data de Publicação</div>
    <div class="quarto-title-meta-contents">
      <p class="date">25/11/2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="processamento-e-tratamento-de-dados" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Processamento e tratamento de dados</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">#globals().clear() # limpa ambiente</span></span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="im">from</span> plotnine <span class="im">import</span> ggplot, aes, geom_point, labs, geom_boxplot</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co"># ANOVA</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="im">import</span> researchpy <span class="im">as</span> rp</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="im">from</span> statsmodels.formula.api <span class="im">import</span> ols</span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a>pd.set_option(<span class="st">"display.max_columns"</span>, <span class="va">None</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="do">## carregando funções auxiliares</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="fu">source</span>(<span class="st">"_src/src.R"</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Leitura dos dados</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>df_pagamentos <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_order_payments_dataset.csv"</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a>pag_menos_freq <span class="op">=</span> df_pagamentos[<span class="st">"payment_type"</span>].value_counts().idxmin()</span>
<span id="cb3-4"><a href="#cb3-4"></a>pag_mais_freq <span class="op">=</span> df_pagamentos[<span class="st">"payment_type"</span>].value_counts().idxmax()</span>
<span id="cb3-5"><a href="#cb3-5"></a>df_pagamentos[<span class="st">"payment_type"</span>] <span class="op">=</span> df_pagamentos[<span class="st">"payment_type"</span>].replace(pag_menos_freq, pag_mais_freq)</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># para descritiva</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>df_tipo_pagamento <span class="op">=</span> (df_pagamentos</span>
<span id="cb3-9"><a href="#cb3-9"></a>    .groupby(<span class="st">"payment_type"</span>)</span>
<span id="cb3-10"><a href="#cb3-10"></a>    .agg(</span>
<span id="cb3-11"><a href="#cb3-11"></a>        n<span class="op">=</span>(<span class="st">"payment_type"</span>,<span class="st">"count"</span>),</span>
<span id="cb3-12"><a href="#cb3-12"></a>        log_valor_pago<span class="op">=</span>(<span class="st">"payment_value"</span>, <span class="kw">lambda</span> x: np.log(x.<span class="bu">sum</span>()<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb3-13"><a href="#cb3-13"></a>    )</span>
<span id="cb3-14"><a href="#cb3-14"></a>    .reset_index()</span>
<span id="cb3-15"><a href="#cb3-15"></a>)</span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co"># Forma de pagamento</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>df_forma_pag <span class="op">=</span> (df_pagamentos</span>
<span id="cb3-20"><a href="#cb3-20"></a>    .groupby([<span class="st">"order_id"</span>, <span class="st">"payment_type"</span>])</span>
<span id="cb3-21"><a href="#cb3-21"></a>    .size()</span>
<span id="cb3-22"><a href="#cb3-22"></a>    .reset_index(name<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb3-23"><a href="#cb3-23"></a>    .pivot(index<span class="op">=</span><span class="st">"order_id"</span>, columns<span class="op">=</span><span class="st">"payment_type"</span>, values<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb3-24"><a href="#cb3-24"></a>    .fillna(<span class="dv">0</span>)</span>
<span id="cb3-25"><a href="#cb3-25"></a>    .reset_index()</span>
<span id="cb3-26"><a href="#cb3-26"></a>    .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-27"><a href="#cb3-27"></a>)</span>
<span id="cb3-28"><a href="#cb3-28"></a>df_forma_pag[<span class="st">"soma_tipos_pagamentos"</span>] <span class="op">=</span> df_forma_pag.<span class="bu">filter</span>(like<span class="op">=</span><span class="st">"_card"</span>).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-29"><a href="#cb3-29"></a></span>
<span id="cb3-30"><a href="#cb3-30"></a><span class="co"># Registro de pagamento</span></span>
<span id="cb3-31"><a href="#cb3-31"></a>df_registro <span class="op">=</span> (df_pagamentos</span>
<span id="cb3-32"><a href="#cb3-32"></a>    .groupby(<span class="st">"order_id"</span>)</span>
<span id="cb3-33"><a href="#cb3-33"></a>    .agg(</span>
<span id="cb3-34"><a href="#cb3-34"></a>        ex_pago_escala_original<span class="op">=</span>(<span class="st">"payment_value"</span>,<span class="st">"sum"</span>),</span>
<span id="cb3-35"><a href="#cb3-35"></a>        log_valor_pago<span class="op">=</span>(<span class="st">"payment_value"</span>, <span class="kw">lambda</span> x: np.log(x.<span class="bu">sum</span>()<span class="op">+</span><span class="dv">1</span>)),</span>
<span id="cb3-36"><a href="#cb3-36"></a>        pago_a_vista<span class="op">=</span>(<span class="st">"payment_sequential"</span>, <span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x.<span class="bu">max</span>() <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span>),</span>
<span id="cb3-37"><a href="#cb3-37"></a>        log_valor_medio_parcela<span class="op">=</span>(<span class="st">"payment_value"</span>, <span class="kw">lambda</span> x: np.log(x.mean()<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb3-38"><a href="#cb3-38"></a>    )</span>
<span id="cb3-39"><a href="#cb3-39"></a>    .reset_index()</span>
<span id="cb3-40"><a href="#cb3-40"></a>)</span>
<span id="cb3-41"><a href="#cb3-41"></a></span>
<span id="cb3-42"><a href="#cb3-42"></a>df_log_exemplo <span class="op">=</span> df_registro[[<span class="st">'order_id'</span>,<span class="st">'ex_pago_escala_original'</span>, <span class="st">'log_valor_pago'</span>]] <span class="co"># auxiliar</span></span>
<span id="cb3-43"><a href="#cb3-43"></a>df_log <span class="op">=</span> df_log_exemplo.melt(id_vars<span class="op">=</span>[<span class="st">'order_id'</span>], var_name<span class="op">=</span><span class="st">'variavel'</span>, value_name<span class="op">=</span><span class="st">'valor'</span>)</span>
<span id="cb3-44"><a href="#cb3-44"></a></span>
<span id="cb3-45"><a href="#cb3-45"></a><span class="co"># Dados dos pedidos</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>df_pedidos <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_orders_dataset.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">"order_purchase_timestamp"</span>, <span class="st">"order_approved_at"</span>, <span class="st">"order_delivered_customer_date"</span>, <span class="st">"order_estimated_delivery_date"</span>])</span>
<span id="cb3-47"><a href="#cb3-47"></a>data_atual <span class="op">=</span> pd.to_datetime(<span class="st">"2018-05-31"</span>)</span>
<span id="cb3-48"><a href="#cb3-48"></a></span>
<span id="cb3-49"><a href="#cb3-49"></a>df_pedidos[<span class="st">"dia_pedido"</span>] <span class="op">=</span> df_pedidos[<span class="st">"order_purchase_timestamp"</span>].dt.day_name()</span>
<span id="cb3-50"><a href="#cb3-50"></a>df_pedidos[<span class="st">"tempo_conf_pedido"</span>] <span class="op">=</span> np.where(</span>
<span id="cb3-51"><a href="#cb3-51"></a>    df_pedidos[<span class="st">"order_approved_at"</span>].isna(),</span>
<span id="cb3-52"><a href="#cb3-52"></a>    (data_atual <span class="op">-</span> df_pedidos[<span class="st">"order_purchase_timestamp"</span>]).dt.days,</span>
<span id="cb3-53"><a href="#cb3-53"></a>    (df_pedidos[<span class="st">"order_approved_at"</span>] <span class="op">-</span> df_pedidos[<span class="st">"order_purchase_timestamp"</span>]).dt.days</span>
<span id="cb3-54"><a href="#cb3-54"></a>)</span>
<span id="cb3-55"><a href="#cb3-55"></a>df_pedidos[<span class="st">"atraso_prev_entrega"</span>] <span class="op">=</span> np.where(</span>
<span id="cb3-56"><a href="#cb3-56"></a>    (df_pedidos[<span class="st">"order_estimated_delivery_date"</span>].isna()) <span class="op">&amp;</span></span>
<span id="cb3-57"><a href="#cb3-57"></a>    ((data_atual <span class="op">-</span> df_pedidos[<span class="st">"order_delivered_customer_date"</span>]).dt.days <span class="op">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb3-58"><a href="#cb3-58"></a>    <span class="dv">1</span>,</span>
<span id="cb3-59"><a href="#cb3-59"></a>    np.where(</span>
<span id="cb3-60"><a href="#cb3-60"></a>        (<span class="op">~</span>df_pedidos[<span class="st">"order_estimated_delivery_date"</span>].isna()) <span class="op">&amp;</span></span>
<span id="cb3-61"><a href="#cb3-61"></a>        ((df_pedidos[<span class="st">"order_estimated_delivery_date"</span>] <span class="op">-</span> df_pedidos[<span class="st">"order_delivered_customer_date"</span>]).dt.days <span class="op">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb3-62"><a href="#cb3-62"></a>        <span class="dv">1</span>,</span>
<span id="cb3-63"><a href="#cb3-63"></a>        <span class="dv">0</span></span>
<span id="cb3-64"><a href="#cb3-64"></a>    )</span>
<span id="cb3-65"><a href="#cb3-65"></a>)</span>
<span id="cb3-66"><a href="#cb3-66"></a></span>
<span id="cb3-67"><a href="#cb3-67"></a><span class="co"># Dados dos clientes</span></span>
<span id="cb3-68"><a href="#cb3-68"></a>df_cliente <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_customers_dataset.csv"</span>)</span>
<span id="cb3-69"><a href="#cb3-69"></a>df_cliente[<span class="st">"regiao_cliente"</span>] <span class="op">=</span> np.select(</span>
<span id="cb3-70"><a href="#cb3-70"></a>    [</span>
<span id="cb3-71"><a href="#cb3-71"></a>        df_cliente[<span class="st">"customer_state"</span>].isin([<span class="st">"SP"</span>]),</span>
<span id="cb3-72"><a href="#cb3-72"></a>        df_cliente[<span class="st">"customer_state"</span>].isin([<span class="st">"MG"</span>, <span class="st">"RJ"</span>, <span class="st">"ES"</span>]),</span>
<span id="cb3-73"><a href="#cb3-73"></a>        df_cliente[<span class="st">"customer_state"</span>].isin([<span class="st">"PR"</span>, <span class="st">"RS"</span>, <span class="st">"MS"</span>]),</span>
<span id="cb3-74"><a href="#cb3-74"></a>        df_cliente[<span class="st">"customer_state"</span>].isin([<span class="st">"DF"</span>, <span class="st">"GO"</span>, <span class="st">"MT"</span>])</span>
<span id="cb3-75"><a href="#cb3-75"></a>    ],</span>
<span id="cb3-76"><a href="#cb3-76"></a>    [<span class="st">"SP"</span>, <span class="st">"Sudeste_SP"</span>, <span class="st">"Sul"</span>, <span class="st">"Centro_Oeste"</span>],</span>
<span id="cb3-77"><a href="#cb3-77"></a>    default<span class="op">=</span><span class="st">"NorteNordeste"</span></span>
<span id="cb3-78"><a href="#cb3-78"></a>)</span>
<span id="cb3-79"><a href="#cb3-79"></a></span>
<span id="cb3-80"><a href="#cb3-80"></a><span class="co"># Dados das avaliações</span></span>
<span id="cb3-81"><a href="#cb3-81"></a>df_avalia <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_order_reviews_dataset.csv"</span>)</span>
<span id="cb3-82"><a href="#cb3-82"></a>df_avalia[<span class="st">"len_titulo"</span>] <span class="op">=</span> df_avalia[<span class="st">"review_comment_title"</span>].<span class="bu">str</span>.<span class="bu">len</span>().fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb3-83"><a href="#cb3-83"></a>df_avalia[<span class="st">"len_comentario"</span>] <span class="op">=</span> df_avalia[<span class="st">"review_comment_message"</span>].<span class="bu">str</span>.<span class="bu">len</span>().fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb3-84"><a href="#cb3-84"></a>df_avalia[<span class="st">"comentario_exc"</span>] <span class="op">=</span> df_avalia[<span class="st">"review_comment_message"</span>].<span class="bu">str</span>.count(<span class="st">"!"</span>).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb3-85"><a href="#cb3-85"></a>df_avalia[<span class="st">"colocou_titulo"</span>] <span class="op">=</span> np.where(df_avalia[<span class="st">"len_titulo"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb3-86"><a href="#cb3-86"></a>df_avalia[<span class="st">"colocou_exc"</span>] <span class="op">=</span> np.where(df_avalia[<span class="st">"comentario_exc"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb3-87"><a href="#cb3-87"></a></span>
<span id="cb3-88"><a href="#cb3-88"></a><span class="co"># União das tabelas</span></span>
<span id="cb3-89"><a href="#cb3-89"></a>df_ordem_compra <span class="op">=</span> (</span>
<span id="cb3-90"><a href="#cb3-90"></a>    df_forma_pag</span>
<span id="cb3-91"><a href="#cb3-91"></a>    .merge(df_registro, on<span class="op">=</span><span class="st">"order_id"</span>)</span>
<span id="cb3-92"><a href="#cb3-92"></a>    .merge(df_pedidos, on<span class="op">=</span><span class="st">"order_id"</span>)</span>
<span id="cb3-93"><a href="#cb3-93"></a>    .merge(df_avalia, on<span class="op">=</span><span class="st">"order_id"</span>)</span>
<span id="cb3-94"><a href="#cb3-94"></a>    .merge(df_cliente, on<span class="op">=</span><span class="st">"customer_id"</span>)</span>
<span id="cb3-95"><a href="#cb3-95"></a>)</span>
<span id="cb3-96"><a href="#cb3-96"></a></span>
<span id="cb3-97"><a href="#cb3-97"></a><span class="co"># Análise da primeira compra</span></span>
<span id="cb3-98"><a href="#cb3-98"></a>df_ordem_primeira_compra <span class="op">=</span> (df_ordem_compra</span>
<span id="cb3-99"><a href="#cb3-99"></a>    .groupby(<span class="st">"customer_unique_id"</span>)</span>
<span id="cb3-100"><a href="#cb3-100"></a>    .agg(</span>
<span id="cb3-101"><a href="#cb3-101"></a>        data_prim_compra<span class="op">=</span>(<span class="st">"order_purchase_timestamp"</span>, <span class="st">"min"</span>),</span>
<span id="cb3-102"><a href="#cb3-102"></a>        data_ultima_compra<span class="op">=</span>(<span class="st">"order_purchase_timestamp"</span>, <span class="st">"max"</span>),</span>
<span id="cb3-103"><a href="#cb3-103"></a>        primeira_compra_cliente<span class="op">=</span>(<span class="st">"order_id"</span>, <span class="kw">lambda</span> x: <span class="dv">0</span> <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">1</span>)</span>
<span id="cb3-104"><a href="#cb3-104"></a>    )</span>
<span id="cb3-105"><a href="#cb3-105"></a>    .reset_index()</span>
<span id="cb3-106"><a href="#cb3-106"></a>)</span>
<span id="cb3-107"><a href="#cb3-107"></a></span>
<span id="cb3-108"><a href="#cb3-108"></a>df_ordem_compra_fim <span class="op">=</span> (</span>
<span id="cb3-109"><a href="#cb3-109"></a>    df_ordem_compra</span>
<span id="cb3-110"><a href="#cb3-110"></a>    .merge(df_ordem_primeira_compra, on<span class="op">=</span><span class="st">"customer_unique_id"</span>)</span>
<span id="cb3-111"><a href="#cb3-111"></a>    .assign(</span>
<span id="cb3-112"><a href="#cb3-112"></a>        primeira_ordem_por_cliente<span class="op">=</span><span class="kw">lambda</span> x: np.where(</span>
<span id="cb3-113"><a href="#cb3-113"></a>            x[<span class="st">"data_prim_compra"</span>] <span class="op">==</span> x[<span class="st">"order_purchase_timestamp"</span>],</span>
<span id="cb3-114"><a href="#cb3-114"></a>            <span class="st">"Primeira"</span>,</span>
<span id="cb3-115"><a href="#cb3-115"></a>            np.where(</span>
<span id="cb3-116"><a href="#cb3-116"></a>                x[<span class="st">"data_ultima_compra"</span>] <span class="op">==</span> x[<span class="st">"order_purchase_timestamp"</span>],</span>
<span id="cb3-117"><a href="#cb3-117"></a>                <span class="st">"Ultima"</span>,</span>
<span id="cb3-118"><a href="#cb3-118"></a>                <span class="st">"2oumais"</span></span>
<span id="cb3-119"><a href="#cb3-119"></a>            )</span>
<span id="cb3-120"><a href="#cb3-120"></a>        )</span>
<span id="cb3-121"><a href="#cb3-121"></a>    )</span>
<span id="cb3-122"><a href="#cb3-122"></a>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>Comentários:</p>
</blockquote>
<ul>
<li>Deixei o formato comprido (wider) para conseguir representar informações categoricas como numeral de forma mais eficiente e para destrinchar informações das ordens para agrupar por cliente</li>
<li>Tipo de pagamento indefinido foi usado o tipo mais frequente (Menos frequente: not_defined e Mais frquente: credit_card)</li>
<li>Pedidos cancelados ou coisas do tipo foram mantidos pois guardam informação parcial de que o cliente ‘estava disposto a comprar tal item’</li>
<li>Tranformou-se os dados de precificação em log-escala para normalizar os dados:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_log</span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> valor, <span class="at">fill =</span> variavel)) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span>  </span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Valor"</span>, <span class="at">y =</span> <span class="st">"Densidade"</span>) <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"ex_pago_escala_original"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"log_valor_pago"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">100</span>)) <span class="sc">+</span>  </span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="fu">theme_minimal</span>() </span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="script__python_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Densidade por tipo de dado</figcaption>
</figure>
</div>
</div>
</div>
<ul>
<li>Por haver poucos clientes que compraram mais de uma vez, e ainda menos que compraram mais de 2 vezes. Algumas vezes optei por tratar como binário: ter sido ou não primeira compra, por exemplo</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">#########################</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"># Itens e produtos</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>df_items <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_order_items_dataset.csv"</span>)</span>
<span id="cb5-4"><a href="#cb5-4"></a>df_items[<span class="st">"log_price"</span>] <span class="op">=</span> np.log(df_items[<span class="st">"price"</span>])</span>
<span id="cb5-5"><a href="#cb5-5"></a>df_items[<span class="st">"log_frete"</span>] <span class="op">=</span> np.log(df_items[<span class="st">"freight_value"</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb5-6"><a href="#cb5-6"></a>df_items_agg <span class="op">=</span> (df_items</span>
<span id="cb5-7"><a href="#cb5-7"></a>    .groupby(<span class="st">"order_id"</span>)  </span>
<span id="cb5-8"><a href="#cb5-8"></a>    .agg(</span>
<span id="cb5-9"><a href="#cb5-9"></a>        produtos_por_pedido<span class="op">=</span>(<span class="st">"order_item_id"</span>, <span class="st">"count"</span>),  </span>
<span id="cb5-10"><a href="#cb5-10"></a>        log_price_pedido<span class="op">=</span>(<span class="st">"log_price"</span>, <span class="st">"sum"</span>),          </span>
<span id="cb5-11"><a href="#cb5-11"></a>        log_frete_pedido<span class="op">=</span>(<span class="st">"log_frete"</span>, <span class="st">"sum"</span>),          </span>
<span id="cb5-12"><a href="#cb5-12"></a>        log_price_medio_pedido<span class="op">=</span>(<span class="st">"log_price"</span>, <span class="st">"mean"</span>)    </span>
<span id="cb5-13"><a href="#cb5-13"></a>    )</span>
<span id="cb5-14"><a href="#cb5-14"></a>    .reset_index()</span>
<span id="cb5-15"><a href="#cb5-15"></a>)</span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co"># Produtos</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>df_prod <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_products_dataset.csv"</span>)</span>
<span id="cb5-19"><a href="#cb5-19"></a></span>
<span id="cb5-20"><a href="#cb5-20"></a>n_categoria_incial <span class="op">=</span> <span class="bu">len</span>(df_prod.product_category_name.unique()) <span class="co"># auxiliar tabela</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>n_categoria_incial_nula <span class="op">=</span> df_prod.product_category_name.isnull().<span class="bu">sum</span>() <span class="co"># auxiliar tabela</span></span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a>df_prod[<span class="st">'categorias_novas_produtos'</span>] <span class="op">=</span> np.where(</span>
<span id="cb5-24"><a href="#cb5-24"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"ferramentas"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"CONSTRUCAO_FERRAMENTAS"</span>, </span>
<span id="cb5-25"><a href="#cb5-25"></a>    np.where(</span>
<span id="cb5-26"><a href="#cb5-26"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"fashion_"</span>, na<span class="op">=</span><span class="va">False</span>),<span class="st">"FASHION"</span>,</span>
<span id="cb5-27"><a href="#cb5-27"></a>    np.where(</span>
<span id="cb5-28"><a href="#cb5-28"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"moveis_"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"MOVEIS"</span>,</span>
<span id="cb5-29"><a href="#cb5-29"></a>    np.where(</span>
<span id="cb5-30"><a href="#cb5-30"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"eletrodomesticos"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"ELETRODOMESTICOS"</span>,</span>
<span id="cb5-31"><a href="#cb5-31"></a>    np.where(</span>
<span id="cb5-32"><a href="#cb5-32"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"dvd"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"MIDIA_MUSICA"</span>,</span>
<span id="cb5-33"><a href="#cb5-33"></a>    np.where(</span>
<span id="cb5-34"><a href="#cb5-34"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"pc"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"INFORMATICA_ACESSORIOS"</span>,</span>
<span id="cb5-35"><a href="#cb5-35"></a>    np.where(</span>
<span id="cb5-36"><a href="#cb5-36"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"industria"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"INDUSTRIA"</span>,</span>
<span id="cb5-37"><a href="#cb5-37"></a>    np.where(</span>
<span id="cb5-38"><a href="#cb5-38"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"musica"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"MIDIA_MUSICA"</span>,</span>
<span id="cb5-39"><a href="#cb5-39"></a>    np.where(</span>
<span id="cb5-40"><a href="#cb5-40"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"portateis"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"PORTATEIS"</span>,</span>
<span id="cb5-41"><a href="#cb5-41"></a>    np.where(</span>
<span id="cb5-42"><a href="#cb5-42"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"livros"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"PAPELARIA"</span>,</span>
<span id="cb5-43"><a href="#cb5-43"></a>    np.where(</span>
<span id="cb5-44"><a href="#cb5-44"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"telefonia"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"TELEFONIA"</span>,</span>
<span id="cb5-45"><a href="#cb5-45"></a>    np.where(</span>
<span id="cb5-46"><a href="#cb5-46"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"artigo"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"EVENTO"</span>,</span>
<span id="cb5-47"><a href="#cb5-47"></a>    np.where(</span>
<span id="cb5-48"><a href="#cb5-48"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"casa"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"CASA"</span>,</span>
<span id="cb5-49"><a href="#cb5-49"></a>    np.where(</span>
<span id="cb5-50"><a href="#cb5-50"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"artes"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"ARTESANATO_LEGAL"</span>,</span>
<span id="cb5-51"><a href="#cb5-51"></a>    np.where(</span>
<span id="cb5-52"><a href="#cb5-52"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"segur"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"SEGURANCA"</span>,</span>
<span id="cb5-53"><a href="#cb5-53"></a>    np.where(</span>
<span id="cb5-54"><a href="#cb5-54"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"bebida"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"ALIMENTO"</span>,</span>
<span id="cb5-55"><a href="#cb5-55"></a>    df_prod[<span class="st">'product_category_name'</span>]</span>
<span id="cb5-56"><a href="#cb5-56"></a>))))))))))))))))</span>
<span id="cb5-57"><a href="#cb5-57"></a></span>
<span id="cb5-58"><a href="#cb5-58"></a>df_prod[<span class="st">'categorias_novas_produtos'</span>] <span class="op">=</span> df_prod[<span class="st">'categorias_novas_produtos'</span>].replace(</span>
<span id="cb5-59"><a href="#cb5-59"></a>  {<span class="st">"papelaria"</span>: <span class="st">'PAPELARIA'</span></span>
<span id="cb5-60"><a href="#cb5-60"></a>  ,<span class="st">'cine_foto'</span>: <span class="st">"MIDIA_MUSICA"</span></span>
<span id="cb5-61"><a href="#cb5-61"></a>  ,<span class="st">'fraldas_higiene'</span>: <span class="st">'bebes'</span></span>
<span id="cb5-62"><a href="#cb5-62"></a>  ,<span class="st">'audio'</span>: <span class="st">"MIDIA_MUSICA"</span></span>
<span id="cb5-63"><a href="#cb5-63"></a>  ,<span class="st">'consoles_games'</span>: <span class="st">"PC"</span></span>
<span id="cb5-64"><a href="#cb5-64"></a>  ,<span class="st">'alimentos'</span>: <span class="st">"ALIMENTO"</span></span>
<span id="cb5-65"><a href="#cb5-65"></a>  ,<span class="st">'flores'</span>: <span class="st">"ALIMENTO"</span></span>
<span id="cb5-66"><a href="#cb5-66"></a>  ,<span class="st">'casa_construcao'</span>: <span class="st">"CONSTRUCAO_FERRAMENTAS"</span></span>
<span id="cb5-67"><a href="#cb5-67"></a>  ,<span class="st">'eletroportateis'</span>: <span class="st">"PORTATEIS"</span></span>
<span id="cb5-68"><a href="#cb5-68"></a>  ,<span class="st">'utilidades_domesticas'</span>: <span class="st">"CASA"</span></span>
<span id="cb5-69"><a href="#cb5-69"></a>  ,<span class="st">'cama_mesa_banho'</span>: <span class="st">"CASA"</span></span>
<span id="cb5-70"><a href="#cb5-70"></a>  ,<span class="st">'climatizacao'</span>: <span class="st">"CASA"</span></span>
<span id="cb5-71"><a href="#cb5-71"></a>  ,<span class="st">'la_cuisine'</span>: <span class="st">"CASA"</span></span>
<span id="cb5-72"><a href="#cb5-72"></a>  ,<span class="st">'eletronicos'</span>: <span class="st">"INFORMATICA_ACESSORIOS"</span></span>
<span id="cb5-73"><a href="#cb5-73"></a>  ,<span class="st">'tablets_impressao_imagem'</span>: <span class="st">"INFORMATICA_ACESSORIOS"</span></span>
<span id="cb5-74"><a href="#cb5-74"></a>  ,<span class="st">'cool_stuff'</span>: <span class="st">"ARTESANATO_LEGAL"</span>}</span>
<span id="cb5-75"><a href="#cb5-75"></a>)</span>
<span id="cb5-76"><a href="#cb5-76"></a></span>
<span id="cb5-77"><a href="#cb5-77"></a>df_prod.categorias_novas_produtos <span class="op">=</span> df_prod.categorias_novas_produtos.<span class="bu">str</span>.upper()</span>
<span id="cb5-78"><a href="#cb5-78"></a></span>
<span id="cb5-79"><a href="#cb5-79"></a><span class="co"># tabela auxiliar</span></span>
<span id="cb5-80"><a href="#cb5-80"></a>tab_freq_cat <span class="op">=</span> (df_prod.groupby(<span class="st">'categorias_novas_produtos'</span>).size()</span>
<span id="cb5-81"><a href="#cb5-81"></a>    .sort_values(ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>).reset_index())</span>
<span id="cb5-82"><a href="#cb5-82"></a>tab_freq_cat.columns <span class="op">=</span> [<span class="st">'categorias'</span>, <span class="st">'Antes'</span>]</span>
<span id="cb5-83"><a href="#cb5-83"></a></span>
<span id="cb5-84"><a href="#cb5-84"></a><span class="co">#--------- Tratamento categorias nulas</span></span>
<span id="cb5-85"><a href="#cb5-85"></a><span class="co"># uma linnha de bebe tinha medidas nulas. Vamos susbituir pela media</span></span>
<span id="cb5-86"><a href="#cb5-86"></a>df_bb_nulo <span class="op">=</span> df_prod[(df_prod[<span class="st">'product_weight_g'</span>].isnull()) <span class="op">&amp;</span> (df_prod[<span class="st">'categorias_novas_produtos'</span>] <span class="op">==</span> <span class="st">'BEBES'</span>)]</span>
<span id="cb5-87"><a href="#cb5-87"></a>indice <span class="op">=</span> df_bb_nulo.index</span>
<span id="cb5-88"><a href="#cb5-88"></a>tamanho <span class="op">=</span> df_bb_nulo.product_name_lenght.iloc[<span class="dv">0</span>]</span>
<span id="cb5-89"><a href="#cb5-89"></a>desc <span class="op">=</span> df_bb_nulo.product_description_lenght.iloc[<span class="dv">0</span>]</span>
<span id="cb5-90"><a href="#cb5-90"></a>quant <span class="op">=</span> df_bb_nulo.product_photos_qty.iloc[<span class="dv">0</span>]</span>
<span id="cb5-91"><a href="#cb5-91"></a></span>
<span id="cb5-92"><a href="#cb5-92"></a>df_prod_bb <span class="op">=</span> df_prod[</span>
<span id="cb5-93"><a href="#cb5-93"></a>  (df_prod[<span class="st">'categorias_novas_produtos'</span>] <span class="op">==</span> <span class="st">'BEBES'</span>) <span class="op">&amp;</span> </span>
<span id="cb5-94"><a href="#cb5-94"></a>  (df_prod[<span class="st">'product_name_lenght'</span>] <span class="op">&gt;=</span> tamanho) <span class="op">&amp;</span> </span>
<span id="cb5-95"><a href="#cb5-95"></a>  (df_prod[<span class="st">'product_description_lenght'</span>] <span class="op">&gt;=</span> desc) <span class="op">&amp;</span> </span>
<span id="cb5-96"><a href="#cb5-96"></a>  (df_prod[<span class="st">'product_photos_qty'</span>] <span class="op">&gt;=</span> quant)</span>
<span id="cb5-97"><a href="#cb5-97"></a>]</span>
<span id="cb5-98"><a href="#cb5-98"></a></span>
<span id="cb5-99"><a href="#cb5-99"></a>nomes_colunas_substituicao<span class="op">=</span>[<span class="st">'product_weight_g'</span>,<span class="st">'product_length_cm'</span>,<span class="st">'product_height_cm'</span>,<span class="st">'product_width_cm'</span>]</span>
<span id="cb5-100"><a href="#cb5-100"></a>valores_estimados <span class="op">=</span> df_prod_bb[nomes_colunas_substituicao].mean()</span>
<span id="cb5-101"><a href="#cb5-101"></a><span class="cf">for</span> coluna <span class="kw">in</span> nomes_colunas_substituicao:</span>
<span id="cb5-102"><a href="#cb5-102"></a>  df_prod.loc[indice,coluna] <span class="op">=</span> valores_estimados[coluna]</span>
<span id="cb5-103"><a href="#cb5-103"></a></span>
<span id="cb5-104"><a href="#cb5-104"></a><span class="co"># segundo tratamento ***</span></span>
<span id="cb5-105"><a href="#cb5-105"></a><span class="co">#df_prod[df_prod['product_weight_g'].isnull()]</span></span>
<span id="cb5-106"><a href="#cb5-106"></a></span>
<span id="cb5-107"><a href="#cb5-107"></a><span class="co"># terceiro tratamento - trazendo info de avaliacao (existe associacao entre avaliacao e num de carac)</span></span>
<span id="cb5-108"><a href="#cb5-108"></a>df_reg<span class="op">=</span> df_items.merge(df_prod, on<span class="op">=</span><span class="st">"product_id"</span>).merge(df_avalia, on<span class="op">=</span><span class="st">"order_id"</span>)</span>
<span id="cb5-109"><a href="#cb5-109"></a>colunas_reg <span class="op">=</span> [</span>
<span id="cb5-110"><a href="#cb5-110"></a>  <span class="st">"product_id"</span>,<span class="st">'categorias_novas_produtos'</span>,</span>
<span id="cb5-111"><a href="#cb5-111"></a>  <span class="co"># info produto</span></span>
<span id="cb5-112"><a href="#cb5-112"></a>  <span class="st">'product_name_lenght'</span>,<span class="st">'product_description_lenght'</span>, <span class="st">'product_photos_qty'</span>, <span class="st">'product_weight_g'</span>,<span class="st">'product_length_cm'</span>, <span class="st">'product_height_cm'</span>, <span class="st">'product_width_cm'</span>,</span>
<span id="cb5-113"><a href="#cb5-113"></a>  <span class="co"># info preco</span></span>
<span id="cb5-114"><a href="#cb5-114"></a>  <span class="st">'log_price'</span>,<span class="st">'log_frete'</span>,</span>
<span id="cb5-115"><a href="#cb5-115"></a>  <span class="co"># avalicao</span></span>
<span id="cb5-116"><a href="#cb5-116"></a>  <span class="st">'review_score'</span>,<span class="st">'len_titulo'</span>, <span class="st">'len_comentario'</span>,<span class="st">'comentario_exc'</span>, <span class="st">'colocou_titulo'</span>, <span class="st">'colocou_exc'</span></span>
<span id="cb5-117"><a href="#cb5-117"></a>  ]</span>
<span id="cb5-118"><a href="#cb5-118"></a></span>
<span id="cb5-119"><a href="#cb5-119"></a>df_reg <span class="op">=</span> df_reg[colunas_reg]</span>
<span id="cb5-120"><a href="#cb5-120"></a>df_reg_dummy <span class="op">=</span> pd.get_dummies(<span class="st">'nota'</span> <span class="op">+</span> df_reg[<span class="st">'review_score'</span>].astype(<span class="bu">str</span>), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb5-121"><a href="#cb5-121"></a>df_reg <span class="op">=</span> pd.concat([df_reg.drop(<span class="st">'review_score'</span>, axis<span class="op">=</span><span class="dv">1</span>), df_reg_dummy], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-122"><a href="#cb5-122"></a></span>
<span id="cb5-123"><a href="#cb5-123"></a><span class="co"># imputacao do restante das variaveis numericas quem nao tem categoria definida</span></span>
<span id="cb5-124"><a href="#cb5-124"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb5-125"><a href="#cb5-125"></a>inpute <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">'mean'</span>)</span>
<span id="cb5-126"><a href="#cb5-126"></a>df_reg.loc[:, [<span class="st">'product_name_lenght'</span>, <span class="st">'product_description_lenght'</span>,<span class="st">'product_photos_qty'</span>]] <span class="op">=</span> inpute.fit_transform(df_reg[[<span class="st">'product_name_lenght'</span>, <span class="st">'product_description_lenght'</span>,<span class="st">'product_photos_qty'</span>]])</span>
<span id="cb5-127"><a href="#cb5-127"></a></span>
<span id="cb5-128"><a href="#cb5-128"></a>df_class <span class="op">=</span> df_reg.dropna() <span class="co"># antes era df_prod</span></span>
<span id="cb5-129"><a href="#cb5-129"></a>df_faltante <span class="op">=</span> df_reg[df_reg.isnull().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb5-130"><a href="#cb5-130"></a></span>
<span id="cb5-131"><a href="#cb5-131"></a><span class="co"># Corrigindo o agrupamento e ordenação</span></span>
<span id="cb5-132"><a href="#cb5-132"></a>df_faltante <span class="op">=</span> (</span>
<span id="cb5-133"><a href="#cb5-133"></a>    df_faltante.groupby(<span class="st">'product_id'</span>).agg(</span>
<span id="cb5-134"><a href="#cb5-134"></a>        product_name_lenght<span class="op">=</span>(<span class="st">"product_name_lenght"</span>, <span class="st">"mean"</span>),  </span>
<span id="cb5-135"><a href="#cb5-135"></a>        product_description_lenght<span class="op">=</span>(<span class="st">"product_description_lenght"</span>, <span class="st">"mean"</span>),          </span>
<span id="cb5-136"><a href="#cb5-136"></a>        product_photos_qty<span class="op">=</span>(<span class="st">"product_photos_qty"</span>, <span class="st">"mean"</span>),          </span>
<span id="cb5-137"><a href="#cb5-137"></a>        product_weight_g<span class="op">=</span>(<span class="st">"product_weight_g"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-138"><a href="#cb5-138"></a>        product_length_cm<span class="op">=</span>(<span class="st">"product_length_cm"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-139"><a href="#cb5-139"></a>        product_height_cm<span class="op">=</span>(<span class="st">"product_height_cm"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-140"><a href="#cb5-140"></a>        product_width_cm<span class="op">=</span>(<span class="st">"product_width_cm"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-141"><a href="#cb5-141"></a>        log_price<span class="op">=</span>(<span class="st">"log_price"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-142"><a href="#cb5-142"></a>        log_frete<span class="op">=</span>(<span class="st">"log_frete"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-143"><a href="#cb5-143"></a>        len_titulo<span class="op">=</span>(<span class="st">"len_titulo"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-144"><a href="#cb5-144"></a>        len_comentario<span class="op">=</span>(<span class="st">"len_comentario"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-145"><a href="#cb5-145"></a>        comentario_exc<span class="op">=</span>(<span class="st">"comentario_exc"</span>, <span class="st">"max"</span>),</span>
<span id="cb5-146"><a href="#cb5-146"></a>        colocou_titulo<span class="op">=</span>(<span class="st">"colocou_titulo"</span>, <span class="st">"max"</span>),  <span class="co"># Binária: max captura se há algum 1</span></span>
<span id="cb5-147"><a href="#cb5-147"></a>        colocou_exc<span class="op">=</span>(<span class="st">"colocou_exc"</span>, <span class="st">"max"</span>),</span>
<span id="cb5-148"><a href="#cb5-148"></a>        nota1<span class="op">=</span>(<span class="st">"nota1"</span>, <span class="st">"max"</span>),  <span class="co"># Assumindo que as notas sejam binárias ou escalares</span></span>
<span id="cb5-149"><a href="#cb5-149"></a>        nota2<span class="op">=</span>(<span class="st">"nota2"</span>, <span class="st">"max"</span>),</span>
<span id="cb5-150"><a href="#cb5-150"></a>        nota3<span class="op">=</span>(<span class="st">"nota3"</span>, <span class="st">"max"</span>),</span>
<span id="cb5-151"><a href="#cb5-151"></a>        nota4<span class="op">=</span>(<span class="st">"nota4"</span>, <span class="st">"max"</span>),</span>
<span id="cb5-152"><a href="#cb5-152"></a>        nota5<span class="op">=</span>(<span class="st">"nota5"</span>, <span class="st">"max"</span>)</span>
<span id="cb5-153"><a href="#cb5-153"></a>    ).reset_index()  <span class="co"># Garante que 'product_id' volte como coluna</span></span>
<span id="cb5-154"><a href="#cb5-154"></a>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Foi usado imputação de dados em alguns momentos para não perder informação</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># - imputacao categorica</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split </span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="im">from</span> sklearn <span class="im">import</span> metrics </span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co"># Processo de Classificacao Dummy </span></span>
<span id="cb6-9"><a href="#cb6-9"></a>codigos <span class="op">=</span> pd.factorize(df_class.categorias_novas_produtos) <span class="co"># atribui indices as classes</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>df_class[<span class="st">'numero_categorias_novas_produtos'</span>] <span class="op">=</span> codigos[<span class="dv">0</span>]</span>
<span id="cb6-11"><a href="#cb6-11"></a>categorias <span class="op">=</span> codigos[<span class="dv">1</span>]</span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a>y <span class="op">=</span> df_class[<span class="st">'numero_categorias_novas_produtos'</span>]</span>
<span id="cb6-14"><a href="#cb6-14"></a>x <span class="op">=</span> df_class.drop([<span class="st">'numero_categorias_novas_produtos'</span>,<span class="st">'categorias_novas_produtos'</span>,<span class="st">'product_id'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-15"><a href="#cb6-15"></a></span>
<span id="cb6-16"><a href="#cb6-16"></a>x_treino, x_teste, y_treino, y_teste <span class="op">=</span> train_test_split(x, y, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-17"><a href="#cb6-17"></a></span>
<span id="cb6-18"><a href="#cb6-18"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb6-19"><a href="#cb6-19"></a>x_treino <span class="op">=</span> scaler.fit_transform(x_treino)</span>
<span id="cb6-20"><a href="#cb6-20"></a>x_teste <span class="op">=</span> scaler.transform(x_teste)</span>
<span id="cb6-21"><a href="#cb6-21"></a></span>
<span id="cb6-22"><a href="#cb6-22"></a>classificador_arvoredecisao <span class="op">=</span> RandomForestClassifier(n_estimators <span class="op">=</span> <span class="dv">10</span>, criterion <span class="op">=</span> <span class="st">'entropy'</span>, random_state <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb6-23"><a href="#cb6-23"></a>classificador_arvoredecisao.fit(x_treino, y_treino)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>RandomForestClassifier(criterion='entropy', n_estimators=10, random_state=1)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked=""><label for="sk-estimator-id-1" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;&nbsp;RandomForestClassifier<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.ensemble.RandomForestClassifier.html">?<span>Documentation for RandomForestClassifier</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>RandomForestClassifier(criterion='entropy', n_estimators=10, random_state=1)</pre></div> </div></div></div></div>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a></span>
<span id="cb7-2"><a href="#cb7-2"></a>y_pred <span class="op">=</span> classificador_arvoredecisao.predict(x_teste)</span>
<span id="cb7-3"><a href="#cb7-3"></a>categoria_nominal_prevista <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(<span class="bu">range</span>(<span class="bu">len</span>(categorias)<span class="op">+</span><span class="dv">1</span>),categorias))</span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co"># Matriz de confusao</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>y_teste_resposta <span class="op">=</span> np.vectorize(categoria_nominal_prevista.get)(y_teste)</span>
<span id="cb7-7"><a href="#cb7-7"></a>y_pred <span class="op">=</span> np.vectorize(categoria_nominal_prevista.get)(y_pred)</span>
<span id="cb7-8"><a href="#cb7-8"></a>matriz <span class="op">=</span> pd.crosstab(y_teste_resposta, y_pred, rownames<span class="op">=</span>[<span class="st">'Real'</span>], colnames<span class="op">=</span>[<span class="st">'Predito'</span>])</span>
<span id="cb7-9"><a href="#cb7-9"></a>acuracia <span class="op">=</span> np.trace(matriz) <span class="op">/</span> np.<span class="bu">sum</span>(matriz.values)</span>
<span id="cb7-10"><a href="#cb7-10"></a></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="co"># Substituicao</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>new_x <span class="op">=</span> df_faltante.drop(<span class="st">'product_id'</span>, axis<span class="op">=</span><span class="dv">1</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb7-13"><a href="#cb7-13"></a>new_y_pred <span class="op">=</span> classificador_arvoredecisao.predict(</span>
<span id="cb7-14"><a href="#cb7-14"></a>  scaler.fit_transform(new_x)</span>
<span id="cb7-15"><a href="#cb7-15"></a>)</span>
<span id="cb7-16"><a href="#cb7-16"></a></span>
<span id="cb7-17"><a href="#cb7-17"></a>df_faltante[<span class="st">'categorias_novas_produtos'</span>] <span class="op">=</span> np.vectorize(categoria_nominal_prevista.get)(new_y_pred)</span>
<span id="cb7-18"><a href="#cb7-18"></a></span>
<span id="cb7-19"><a href="#cb7-19"></a>df_prod_final <span class="op">=</span> pd.concat(</span>
<span id="cb7-20"><a href="#cb7-20"></a>    [df_prod[df_prod.isnull().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>].drop(<span class="st">'product_category_name'</span>,axis<span class="op">=</span><span class="dv">1</span>), </span>
<span id="cb7-21"><a href="#cb7-21"></a>     df_faltante[df_prod.drop(<span class="st">'product_category_name'</span>,axis<span class="op">=</span><span class="dv">1</span>).columns]],  <span class="co"># Dado nulo estimado</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>    ignore_index<span class="op">=</span><span class="va">True</span>  </span>
<span id="cb7-23"><a href="#cb7-23"></a>)</span>
<span id="cb7-24"><a href="#cb7-24"></a></span>
<span id="cb7-25"><a href="#cb7-25"></a>df_prod_final[<span class="st">'volume_prod'</span>] <span class="op">=</span> (</span>
<span id="cb7-26"><a href="#cb7-26"></a>    df_prod_final.product_length_cm.fillna(<span class="dv">0</span>) <span class="op">*</span> </span>
<span id="cb7-27"><a href="#cb7-27"></a>    df_prod_final.product_height_cm.fillna(<span class="dv">0</span>) <span class="op">*</span> </span>
<span id="cb7-28"><a href="#cb7-28"></a>    df_prod_final.product_width_cm.fillna(<span class="dv">0</span>)</span>
<span id="cb7-29"><a href="#cb7-29"></a>)</span>
<span id="cb7-30"><a href="#cb7-30"></a></span>
<span id="cb7-31"><a href="#cb7-31"></a></span>
<span id="cb7-32"><a href="#cb7-32"></a>df_compra <span class="op">=</span> df_items.merge(df_prod_final, on<span class="op">=</span><span class="st">"product_id"</span>).drop(</span>
<span id="cb7-33"><a href="#cb7-33"></a>  [<span class="st">'product_id'</span>,<span class="st">'seller_id'</span>,<span class="st">'shipping_limit_date'</span>,<span class="st">'price'</span>,<span class="st">'freight_value'</span>],axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-34"><a href="#cb7-34"></a>  </span>
<span id="cb7-35"><a href="#cb7-35"></a>df_dummy_compra <span class="op">=</span> pd.get_dummies(df_compra.categorias_novas_produtos, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb7-36"><a href="#cb7-36"></a>df_compra_final <span class="op">=</span> pd.concat([df_compra, df_dummy_compra], axis<span class="op">=</span><span class="dv">1</span>).drop(<span class="st">'categorias_novas_produtos'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-37"><a href="#cb7-37"></a></span>
<span id="cb7-38"><a href="#cb7-38"></a></span>
<span id="cb7-39"><a href="#cb7-39"></a><span class="co">## compras e ordens</span></span>
<span id="cb7-40"><a href="#cb7-40"></a>df_compra_ordem <span class="op">=</span> df_compra.merge(df_ordem_compra_fim, on <span class="op">=</span> <span class="st">'order_id'</span>)</span>
<span id="cb7-41"><a href="#cb7-41"></a></span>
<span id="cb7-42"><a href="#cb7-42"></a><span class="co"># Valores auxiliares</span></span>
<span id="cb7-43"><a href="#cb7-43"></a>n_categoria_final <span class="op">=</span> <span class="bu">len</span>(df_prod_final.categorias_novas_produtos.unique())</span>
<span id="cb7-44"><a href="#cb7-44"></a>n_categoria_final_nula <span class="op">=</span> df_prod_final.categorias_novas_produtos.isnull().<span class="bu">sum</span>() <span class="co"># auxiliar tabela</span></span>
<span id="cb7-45"><a href="#cb7-45"></a><span class="co"># tabela auxiliar</span></span>
<span id="cb7-46"><a href="#cb7-46"></a>tab_freq_cat_dp <span class="op">=</span> (df_prod_final.groupby(<span class="st">'categorias_novas_produtos'</span>).size()</span>
<span id="cb7-47"><a href="#cb7-47"></a>    .sort_values(ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>).reset_index())</span>
<span id="cb7-48"><a href="#cb7-48"></a>tab_freq_cat_dp.columns <span class="op">=</span> [<span class="st">'categorias'</span>, <span class="st">'Depois'</span>]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<table class="caption-top table">
<colgroup>
<col style="width: 41%">
<col style="width: 25%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Descrição</th>
<th>Antes</th>
<th>Depois</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Categorias de produtos</td>
<td><code>{python} n_categoria_incial</code></td>
<td><code>{python} n_categoria_final</code></td>
</tr>
<tr class="even">
<td>Categorias de produtos nulas</td>
<td><code>{python} n_categoria_incial_nula</code></td>
<td><code>{python} n_categoria_final_nula</code></td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p>Resumo do que foi usado aqui para prever as classes:</p>
</blockquote>
<ul>
<li>Método: Floresta Aleatória para classificação</li>
<li>Acurácia: <code>{ round(acuracia*100, 2) }</code>%</li>
<li>Ideia aqui foi usar os dados de avaliação dos produtos para ajudar a melhorar a categorização de qual categoria pertenceria o valores de dimensão do produto (peso, altura, comprimento…)</li>
<li>Para os dados numéricos que faltavam de informações do anúncio do produto (tamanho do título, quantidade de fotos e tamanho da descrição), usou-se a média. Esses dados entraram na Árvore</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># União final - quase modelo</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>df <span class="op">=</span> df_ordem_compra_fim.merge(df_compra_final, on<span class="op">=</span><span class="st">"order_id"</span>).drop(</span>
<span id="cb8-3"><a href="#cb8-3"></a>  [<span class="st">'review_comment_title'</span>, <span class="st">'review_comment_message'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-4"><a href="#cb8-4"></a></span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a>colunas_finais <span class="op">=</span> [<span class="st">'order_id'</span>, <span class="st">'boleto'</span>, <span class="st">'credit_card'</span>, <span class="st">'debit_card'</span>, <span class="st">'voucher'</span>,</span>
<span id="cb8-7"><a href="#cb8-7"></a>       <span class="st">'soma_tipos_pagamentos'</span>, <span class="st">'log_valor_pago'</span>, <span class="st">'pago_a_vista'</span>,</span>
<span id="cb8-8"><a href="#cb8-8"></a>       <span class="st">'log_valor_medio_parcela'</span>, <span class="st">'customer_id'</span>,</span>
<span id="cb8-9"><a href="#cb8-9"></a>       <span class="st">'order_purchase_timestamp'</span>, </span>
<span id="cb8-10"><a href="#cb8-10"></a>       <span class="st">'dia_pedido'</span>, <span class="st">'tempo_conf_pedido'</span>,</span>
<span id="cb8-11"><a href="#cb8-11"></a>       <span class="st">'atraso_prev_entrega'</span>, <span class="st">'review_score'</span>,</span>
<span id="cb8-12"><a href="#cb8-12"></a>       <span class="st">'review_creation_date'</span>, <span class="st">'len_titulo'</span>,</span>
<span id="cb8-13"><a href="#cb8-13"></a>       <span class="st">'len_comentario'</span>, <span class="st">'comentario_exc'</span>, <span class="st">'colocou_titulo'</span>, <span class="st">'colocou_exc'</span>,</span>
<span id="cb8-14"><a href="#cb8-14"></a>       <span class="st">'customer_unique_id'</span>, <span class="st">'customer_city'</span>,</span>
<span id="cb8-15"><a href="#cb8-15"></a>       <span class="st">'customer_state'</span>, <span class="st">'regiao_cliente'</span>, <span class="st">'data_prim_compra'</span>,</span>
<span id="cb8-16"><a href="#cb8-16"></a>       <span class="st">'data_ultima_compra'</span>, <span class="st">'primeira_compra_cliente'</span>,</span>
<span id="cb8-17"><a href="#cb8-17"></a>       <span class="st">'primeira_ordem_por_cliente'</span>, <span class="st">'log_price'</span>, <span class="st">'log_frete'</span>,</span>
<span id="cb8-18"><a href="#cb8-18"></a>       <span class="st">'product_name_lenght'</span>, <span class="st">'product_description_lenght'</span>,</span>
<span id="cb8-19"><a href="#cb8-19"></a>       <span class="st">'product_photos_qty'</span>, <span class="st">'product_weight_g'</span>, <span class="st">'product_length_cm'</span>,</span>
<span id="cb8-20"><a href="#cb8-20"></a>       <span class="st">'product_height_cm'</span>, <span class="st">'product_width_cm'</span>, <span class="st">'volume_prod'</span>, <span class="st">'ALIMENTO'</span>,</span>
<span id="cb8-21"><a href="#cb8-21"></a>       <span class="st">'ARTESANATO_LEGAL'</span>, <span class="st">'AUTOMOTIVO'</span>, <span class="st">'BEBES'</span>, <span class="st">'BELEZA_SAUDE'</span>, <span class="st">'BRINQUEDOS'</span>,</span>
<span id="cb8-22"><a href="#cb8-22"></a>       <span class="st">'CASA'</span>, <span class="st">'CONSTRUCAO_FERRAMENTAS'</span>, <span class="st">'ELETRODOMESTICOS'</span>, <span class="st">'ESPORTE_LAZER'</span>,</span>
<span id="cb8-23"><a href="#cb8-23"></a>       <span class="st">'EVENTO'</span>, <span class="st">'FASHION'</span>, <span class="st">'INDUSTRIA'</span>, <span class="st">'INFORMATICA_ACESSORIOS'</span>,</span>
<span id="cb8-24"><a href="#cb8-24"></a>       <span class="st">'MALAS_ACESSORIOS'</span>, <span class="st">'MARKET_PLACE'</span>, <span class="st">'MIDIA_MUSICA'</span>, <span class="st">'MOVEIS'</span>,</span>
<span id="cb8-25"><a href="#cb8-25"></a>       <span class="st">'PAPELARIA'</span>, <span class="st">'PC'</span>, <span class="st">'PERFUMARIA'</span>, <span class="st">'PET_SHOP'</span>, <span class="st">'PORTATEIS'</span>,</span>
<span id="cb8-26"><a href="#cb8-26"></a>       <span class="st">'RELOGIOS_PRESENTES'</span>, <span class="st">'SEGURANCA'</span>, <span class="st">'TELEFONIA'</span>]</span>
<span id="cb8-27"><a href="#cb8-27"></a></span>
<span id="cb8-28"><a href="#cb8-28"></a>df_final <span class="op">=</span> df[colunas_finais]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="resumo-dados-nulos" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="resumo-dados-nulos"><span class="header-section-number">1.1</span> Resumo dados nulos</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>df_nulo_fim <span class="op">=</span> pd.DataFrame(</span>
<span id="cb9-2"><a href="#cb9-2"></a>  df_final.isnull().<span class="bu">sum</span>()[df_final.isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb9-3"><a href="#cb9-3"></a>  )</span>
<span id="cb9-4"><a href="#cb9-4"></a>df_nulo_fim.columns <span class="op">=</span> [<span class="st">'nome_coluna_quantidade_nula'</span>]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># data = py$tab_freq_cat_final</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co"># </span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co"># ggplot(data = data) +</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co">#   geom_histogram(aes(x = n, fill = categorias)) + </span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co">#   facet_wrap(~ tipo)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="descritiva" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Descritiva</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>pd.DataFrame(df_final.describe().<span class="bu">round</span>(<span class="dv">2</span>))</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         boleto  credit_card  debit_card    voucher  soma_tipos_pagamentos  \
count  112369.0    112369.00   112369.00  112369.00              112369.00   
mean        0.2         0.77        0.02       0.06                   0.79   
min         0.0         0.00        0.00       0.00                   0.00   
25%         0.0         1.00        0.00       0.00                   1.00   
50%         0.0         1.00        0.00       0.00                   1.00   
75%         0.0         1.00        0.00       0.00                   1.00   
max         1.0         2.00        2.00      29.00                   2.00   
std         0.4         0.43        0.12       0.42                   0.42   

       log_valor_pago  pago_a_vista  log_valor_medio_parcela  \
count       112369.00     112369.00                112369.00   
mean             4.79          0.97                     4.76   
min              2.36          0.00                     1.01   
25%              4.20          1.00                     4.18   
50%              4.75          1.00                     4.73   
75%              5.28          1.00                     5.27   
max              9.52          1.00                     9.52   
std              0.83          0.17                     0.84   

            order_purchase_timestamp  tempo_conf_pedido  atraso_prev_entrega  \
count                         112369          112369.00            112369.00   
mean   2017-12-31 19:19:20.240484096               0.34                 0.09   
min              2016-09-04 21:15:19               0.00                 0.00   
25%              2017-09-13 15:04:22               0.00                 0.00   
50%              2018-01-19 18:07:37               0.00                 0.00   
75%              2018-05-04 15:20:52               0.00                 0.00   
max              2018-09-03 09:06:57             496.00                 1.00   
std                              NaN               5.49                 0.29   

       review_score  len_titulo  len_comentario  comentario_exc  \
count     112369.00   112369.00       112369.00       112369.00   
mean           4.03        1.46           29.77            0.11   
min            1.00        0.00            0.00            0.00   
25%            4.00        0.00            0.00            0.00   
50%            5.00        0.00            0.00            0.00   
75%            5.00        0.00           44.00            0.00   
max            5.00       26.00          208.00          153.00   
std            1.39        4.52           49.65            0.75   

       colocou_titulo  colocou_exc               data_prim_compra  \
count       112369.00    112369.00                         112369   
mean             0.12         0.06  2017-12-28 17:04:14.461710848   
min              0.00         0.00            2016-09-04 21:15:19   
25%              0.00         0.00            2017-09-08 19:49:51   
50%              0.00         0.00            2018-01-16 16:56:35   
75%              0.00         0.00            2018-05-02 14:49:23   
max              1.00         1.00            2018-08-29 15:00:37   
std              0.32         0.23                            NaN   

                  data_ultima_compra  primeira_compra_cliente  log_price  \
count                         112369                112369.00  112369.00   
mean   2018-01-03 21:15:03.979727360                     0.93       4.32   
min              2016-09-04 21:15:19                     0.00      -0.16   
25%              2017-09-18 09:12:24                     1.00       3.69   
50%              2018-01-23 14:09:13                     1.00       4.32   
75%              2018-05-07 15:01:24                     1.00       4.90   
max              2018-10-16 20:16:02                     1.00       8.82   
std                              NaN                     0.26       0.92   

       log_frete  product_name_lenght  product_description_lenght  \
count  112369.00            112369.00                   112369.00   
mean        2.89                48.78                      786.79   
min         0.00                 5.00                        4.00   
25%         2.64                43.00                      348.00   
50%         2.85                51.00                      608.00   
75%         3.10                57.00                      978.00   
max         6.02                76.00                     3992.00   
std         0.53                 9.95                      646.97   

       product_photos_qty  product_weight_g  product_length_cm  \
count           112369.00         112352.00          112352.00   
mean                 2.21           2090.65              30.15   
min                  1.00              0.00               7.00   
25%                  1.00            300.00              18.00   
50%                  2.00            700.00              25.00   
75%                  3.00           1800.00              38.00   
max                 20.00          40425.00             105.00   
std                  1.71           3748.64              16.14   

       product_height_cm  product_width_cm  volume_prod   ALIMENTO  \
count          112352.00         112352.00    112369.00  112369.00   
mean               16.58             23.00     15216.82       0.01   
min                 2.00              6.00         0.00       0.00   
25%                 8.00             15.00      2852.00       0.00   
50%                13.00             20.00      6460.00       0.00   
75%                20.00             30.00     18150.00       0.00   
max               105.00            118.00    296208.00       1.00   
std                13.44             11.71     23352.74       0.10   

       ARTESANATO_LEGAL  AUTOMOTIVO      BEBES  BELEZA_SAUDE  BRINQUEDOS  \
count         112369.00   112369.00  112369.00     112369.00   112369.00   
mean               0.04        0.04       0.03          0.09        0.04   
min                0.00        0.00       0.00          0.00        0.00   
25%                0.00        0.00       0.00          0.00        0.00   
50%                0.00        0.00       0.00          0.00        0.00   
75%                0.00        0.00       0.00          0.00        0.00   
max                1.00        1.00       1.00          1.00        1.00   
std                0.19        0.19       0.16          0.28        0.19   

            CASA  CONSTRUCAO_FERRAMENTAS  ELETRODOMESTICOS  ESPORTE_LAZER  \
count  112369.00               112369.00         112369.00      112369.00   
mean        0.18                    0.06              0.01           0.08   
min         0.00                    0.00              0.00           0.00   
25%         0.00                    0.00              0.00           0.00   
50%         0.00                    0.00              0.00           0.00   
75%         0.00                    0.00              0.00           0.00   
max         1.00                    1.00              1.00           1.00   
std         0.38                    0.23              0.10           0.27   

          EVENTO    FASHION  INDUSTRIA  INFORMATICA_ACESSORIOS  \
count  112369.00  112369.00  112369.00                112369.0   
mean        0.00       0.02       0.00                     0.1   
min         0.00       0.00       0.00                     0.0   
25%         0.00       0.00       0.00                     0.0   
50%         0.00       0.00       0.00                     0.0   
75%         0.00       0.00       0.00                     0.0   
max         1.00       1.00       1.00                     1.0   
std         0.04       0.15       0.07                     0.3   

       MALAS_ACESSORIOS  MARKET_PLACE  MIDIA_MUSICA    MOVEIS  PAPELARIA  \
count         112369.00     112369.00     112369.00  112369.0  112369.00   
mean               0.01          0.00          0.01       0.1       0.03   
min                0.00          0.00          0.00       0.0       0.00   
25%                0.00          0.00          0.00       0.0       0.00   
50%                0.00          0.00          0.00       0.0       0.00   
75%                0.00          0.00          0.00       0.0       0.00   
max                1.00          1.00          1.00       1.0       1.00   
std                0.10          0.05          0.10       0.3       0.17   

              PC  PERFUMARIA   PET_SHOP  PORTATEIS  RELOGIOS_PRESENTES  \
count  112369.00   112369.00  112369.00  112369.00           112369.00   
mean        0.01        0.03       0.02       0.01                0.05   
min         0.00        0.00       0.00       0.00                0.00   
25%         0.00        0.00       0.00       0.00                0.00   
50%         0.00        0.00       0.00       0.00                0.00   
75%         0.00        0.00       0.00       0.00                0.00   
max         1.00        1.00       1.00       1.00                1.00   
std         0.10        0.18       0.13       0.08                0.23   

       SEGURANCA  TELEFONIA  
count  112369.00  112369.00  
mean        0.00       0.04  
min         0.00       0.00  
25%         0.00       0.00  
50%         0.00       0.00  
75%         0.00       0.00  
max         1.00       1.00  
std         0.04       0.20  </code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>Pagamento do cliente:</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># | fig-cap: "Número de Transações e Log do Valor Pago por Tipo de Pagamento"</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_tipo_pagamento</span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a>data<span class="sc">$</span>payment_type <span class="ot">&lt;-</span> <span class="fu">reorder</span>(data<span class="sc">$</span>payment_type, <span class="sc">-</span>data<span class="sc">$</span>n)</span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> payment_type)) <span class="sc">+</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">y =</span> n<span class="sc">/</span><span class="dv">1000</span>, <span class="at">fill =</span> payment_type), <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_valor_pago, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb13-9"><a href="#cb13-9"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_valor_pago), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span>  </span>
<span id="cb13-10"><a href="#cb13-10"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">"Número de pagamentos (em milhares)"</span>, <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span>.<span class="sc">/</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">"Log do Valor Pago"</span>)) <span class="sc">+</span> </span>
<span id="cb13-11"><a href="#cb13-11"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Tipo de Pagamento"</span>) <span class="sc">+</span></span>
<span id="cb13-12"><a href="#cb13-12"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb13-13"><a href="#cb13-13"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="script__python_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_registro</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="fu">ggplot</span>(<span class="at">data=</span> data) <span class="sc">+</span> </span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_valor_medio_parcela, <span class="at">fill =</span> <span class="fu">as.factor</span>(pago_a_vista))) <span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">'log da parcela mensal'</span>, <span class="at">fill =</span> <span class="st">'Pagamento a vista'</span>) <span class="sc">+</span> </span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="script__python_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_final</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="fu">ggplot</span>(<span class="at">data=</span>data)<span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> soma_tipos_pagamentos)) <span class="sc">+</span> </span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>primeira_compra_cliente)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="script__python_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Aqui parece haver uma possível mudança de comportamento do preço de compra entre a primeira e a segunda compra</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_compra_ordem</span>
<span id="cb16-2"><a href="#cb16-2"></a></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="fu">ggplot</span>(<span class="at">data=</span> data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="sc">-</span>log_price))<span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_price, <span class="at">x =</span> categorias_novas_produtos)) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">mean</span>(data<span class="sc">$</span>log_price), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>primeira_compra_cliente) <span class="sc">+</span> </span>
<span id="cb16-7"><a href="#cb16-7"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="script__python_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>interpreta_ANOVA <span class="ot">&lt;-</span> <span class="cf">function</span>(mod, <span class="at">alpha =</span> <span class="fl">0.05</span>){</span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">library</span>(flextable)</span>
<span id="cb17-3"><a href="#cb17-3"></a>  <span class="co"># Realiza a análise de variância e converte para tibble</span></span>
<span id="cb17-4"><a href="#cb17-4"></a>  tab <span class="ot">&lt;-</span> mod <span class="sc">%&gt;%</span> <span class="fu">anova</span>()</span>
<span id="cb17-5"><a href="#cb17-5"></a>  tabela <span class="ot">&lt;-</span> tab <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">3</span>)</span>
<span id="cb17-6"><a href="#cb17-6"></a>  </span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="co"># Prepara a tabela</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>  tabela <span class="ot">&lt;-</span> tabela <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb17-9"><a href="#cb17-9"></a>    <span class="st">`</span><span class="at">Covariável</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">row.names</span>(tab) <span class="sc">%&gt;%</span> </span>
<span id="cb17-10"><a href="#cb17-10"></a>      <span class="fu">str_replace_all</span>(<span class="st">"(?&lt;=[a-z])(?=[A-Z0-9])"</span>, <span class="st">" "</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-11"><a href="#cb17-11"></a>      <span class="fu">str_to_title</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb17-12"><a href="#cb17-12"></a>      <span class="fu">str_replace_all</span>(<span class="st">":"</span>, <span class="st">" : "</span>),</span>
<span id="cb17-13"><a href="#cb17-13"></a>    <span class="at">sig =</span> <span class="fu">case_when</span>(</span>
<span id="cb17-14"><a href="#cb17-14"></a>      <span class="fu">is.na</span>(<span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>) <span class="sc">~</span> <span class="st">" "</span>,</span>
<span id="cb17-15"><a href="#cb17-15"></a>      <span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.001</span> <span class="sc">~</span> <span class="st">"&lt;0.001*"</span>,</span>
<span id="cb17-16"><a href="#cb17-16"></a>      <span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span> <span class="sc">&lt;=</span> alpha <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"*"</span>),</span>
<span id="cb17-17"><a href="#cb17-17"></a>      <span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span> <span class="sc">&lt;=</span> (alpha <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"."</span>),</span>
<span id="cb17-18"><a href="#cb17-18"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>))</span>
<span id="cb17-19"><a href="#cb17-19"></a>    )</span>
<span id="cb17-20"><a href="#cb17-20"></a>  )</span>
<span id="cb17-21"><a href="#cb17-21"></a>  </span>
<span id="cb17-22"><a href="#cb17-22"></a>  tabela <span class="ot">&lt;-</span> tabela <span class="sc">%&gt;%</span></span>
<span id="cb17-23"><a href="#cb17-23"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="st">`</span><span class="at">Covariável</span><span class="st">`</span>, Df, <span class="st">`</span><span class="at">Sum Sq</span><span class="st">`</span>, <span class="st">`</span><span class="at">Mean Sq</span><span class="st">`</span>, <span class="st">`</span><span class="at">F value</span><span class="st">`</span>, sig) <span class="sc">%&gt;%</span></span>
<span id="cb17-24"><a href="#cb17-24"></a>    <span class="fu">rename</span>(</span>
<span id="cb17-25"><a href="#cb17-25"></a>      <span class="st">`</span><span class="at">gl</span><span class="st">`</span> <span class="ot">=</span> Df, <span class="at">SQ =</span> <span class="st">`</span><span class="at">Sum Sq</span><span class="st">`</span>, <span class="at">MQ =</span> <span class="st">`</span><span class="at">Mean Sq</span><span class="st">`</span>,</span>
<span id="cb17-26"><a href="#cb17-26"></a>      <span class="st">"F"</span> <span class="ot">=</span> <span class="st">`</span><span class="at">F value</span><span class="st">`</span>, <span class="st">"Pvalor"</span> <span class="ot">=</span> sig</span>
<span id="cb17-27"><a href="#cb17-27"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb17-28"><a href="#cb17-28"></a>    <span class="fu">mutate_all</span>(<span class="sc">~</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(.), <span class="st">""</span>, .)) <span class="co"># Tirando NA da saída</span></span>
<span id="cb17-29"><a href="#cb17-29"></a>  </span>
<span id="cb17-30"><a href="#cb17-30"></a>  <span class="co"># Criar um objeto flextable</span></span>
<span id="cb17-31"><a href="#cb17-31"></a>  ft <span class="ot">&lt;-</span> <span class="fu">flextable</span>(tabela)</span>
<span id="cb17-32"><a href="#cb17-32"></a>  </span>
<span id="cb17-33"><a href="#cb17-33"></a>  <span class="co"># Adicionar estilo</span></span>
<span id="cb17-34"><a href="#cb17-34"></a>  ft <span class="ot">&lt;-</span> <span class="fu">set_table_properties</span>(ft, <span class="at">layout =</span> <span class="st">"autofit"</span>)</span>
<span id="cb17-35"><a href="#cb17-35"></a></span>
<span id="cb17-36"><a href="#cb17-36"></a>  <span class="co"># Adicionar rodapé</span></span>
<span id="cb17-37"><a href="#cb17-37"></a>  ft <span class="ot">&lt;-</span> <span class="fu">add_footer_lines</span>(ft, <span class="at">values =</span> <span class="fu">paste0</span>(<span class="st">"Significativo a "</span>, (alpha <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb17-38"><a href="#cb17-38"></a>                                              <span class="st">"% de significância e '.' significativo a "</span>, (<span class="dv">2</span> <span class="sc">*</span> alpha <span class="sc">*</span> <span class="dv">100</span>), <span class="st">"%"</span>))</span>
<span id="cb17-39"><a href="#cb17-39"></a></span>
<span id="cb17-40"><a href="#cb17-40"></a>  <span class="co"># Destacar cabeçalhos e a primeira coluna</span></span>
<span id="cb17-41"><a href="#cb17-41"></a>  ft <span class="ot">&lt;-</span> <span class="fu">bold</span>(ft, <span class="at">bold =</span> <span class="cn">TRUE</span>, <span class="at">part =</span> <span class="st">"header"</span>)</span>
<span id="cb17-42"><a href="#cb17-42"></a>  ft <span class="ot">&lt;-</span> <span class="fu">bold</span>(ft, <span class="at">bold =</span> <span class="cn">TRUE</span>, <span class="at">j =</span> <span class="dv">1</span>)</span>
<span id="cb17-43"><a href="#cb17-43"></a></span>
<span id="cb17-44"><a href="#cb17-44"></a>  <span class="fu">return</span>(ft)</span>
<span id="cb17-45"><a href="#cb17-45"></a>}</span>
<span id="cb17-46"><a href="#cb17-46"></a></span>
<span id="cb17-47"><a href="#cb17-47"></a>Arruma_CompMult <span class="ot">&lt;-</span> <span class="cf">function</span>(comparacao){</span>
<span id="cb17-48"><a href="#cb17-48"></a>  <span class="co"># Funcao para interacaoes de Tukey de ordem ate ^2</span></span>
<span id="cb17-49"><a href="#cb17-49"></a>  </span>
<span id="cb17-50"><a href="#cb17-50"></a>  AjeitaLista <span class="ot">&lt;-</span> <span class="cf">function</span>(lista, <span class="at">alpha =</span> <span class="fl">0.05</span>){</span>
<span id="cb17-51"><a href="#cb17-51"></a>    tabela <span class="ot">&lt;-</span> lista <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-52"><a href="#cb17-52"></a>      <span class="fu">mutate</span>(<span class="at">Comparacoes =</span> <span class="fu">rownames</span>(lista)) <span class="sc">%&gt;%</span> <span class="co"># nomes das comparacoes</span></span>
<span id="cb17-53"><a href="#cb17-53"></a>      <span class="co"># pegando apenas significativas</span></span>
<span id="cb17-54"><a href="#cb17-54"></a>      <span class="fu">filter</span>(<span class="st">`</span><span class="at">p adj</span><span class="st">`</span> <span class="sc">&lt;=</span> alpha<span class="sc">*</span><span class="dv">2</span>)</span>
<span id="cb17-55"><a href="#cb17-55"></a>    <span class="cf">if</span>(tabela <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">!=</span> <span class="dv">0</span>){</span>
<span id="cb17-56"><a href="#cb17-56"></a>      tabela <span class="ot">&lt;-</span> tabela <span class="sc">%&gt;%</span> </span>
<span id="cb17-57"><a href="#cb17-57"></a>        <span class="co"># reagrupa num novo formato</span></span>
<span id="cb17-58"><a href="#cb17-58"></a>        <span class="fu">separate</span>(Comparacoes, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"G1"</span>, <span class="st">"G2"</span>), <span class="at">sep =</span> <span class="st">"-"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-59"><a href="#cb17-59"></a>        <span class="fu">separate</span>(G1, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"G1.1"</span>, <span class="st">"G1.2"</span>), <span class="at">sep =</span> <span class="st">":"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-60"><a href="#cb17-60"></a>        <span class="fu">separate</span>(G2, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"G2.1"</span>, <span class="st">"G2.2"</span>), <span class="at">sep =</span> <span class="st">":"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-61"><a href="#cb17-61"></a>        <span class="fu">unite</span>(<span class="at">col =</span> Fator1, G1<span class="fl">.1</span>,G2<span class="fl">.1</span>, <span class="at">sep =</span> <span class="st">" - "</span>, <span class="at">remove =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb17-62"><a href="#cb17-62"></a>        <span class="fu">unite</span>(<span class="at">col =</span> Fator2, G1<span class="fl">.2</span>,G2<span class="fl">.2</span>, <span class="at">sep =</span> <span class="st">" : "</span>, <span class="at">remove =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb17-63"><a href="#cb17-63"></a>        <span class="co"># mudando forma de mostrar pvalor</span></span>
<span id="cb17-64"><a href="#cb17-64"></a>        <span class="fu">mutate</span>(<span class="at">Pvalor =</span> <span class="fu">case_when</span>(</span>
<span id="cb17-65"><a href="#cb17-65"></a>        <span class="st">`</span><span class="at">p adj</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.001</span> <span class="sc">~</span> <span class="st">"&lt;0.001*"</span>,</span>
<span id="cb17-66"><a href="#cb17-66"></a>        <span class="st">`</span><span class="at">p adj</span><span class="st">`</span> <span class="sc">&lt;=</span> alpha <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">p adj</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"*"</span>),</span>
<span id="cb17-67"><a href="#cb17-67"></a>        <span class="st">`</span><span class="at">p adj</span><span class="st">`</span> <span class="sc">&lt;=</span> (alpha<span class="sc">*</span><span class="dv">2</span>) <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">p adj</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"."</span>),</span>
<span id="cb17-68"><a href="#cb17-68"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">p adj</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>))) <span class="co"># Caso padrão</span></span>
<span id="cb17-69"><a href="#cb17-69"></a>          )<span class="sc">%&gt;%</span></span>
<span id="cb17-70"><a href="#cb17-70"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(Fator1, Fator2, <span class="fu">everything</span>(), <span class="sc">-</span>lwr, <span class="sc">-</span>upr, <span class="sc">-</span><span class="st">`</span><span class="at">p adj</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-71"><a href="#cb17-71"></a>        <span class="fu">rename</span>(<span class="st">`</span><span class="at">Diferença</span><span class="st">`</span><span class="ot">=</span> diff)</span>
<span id="cb17-72"><a href="#cb17-72"></a>      </span>
<span id="cb17-73"><a href="#cb17-73"></a>        <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">"NA"</span>, tabela<span class="sc">$</span>Fator2) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() ){</span>
<span id="cb17-74"><a href="#cb17-74"></a>        <span class="fu">return</span>(tabela <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Fator2)) <span class="co">#caso nao tenha fator 2</span></span>
<span id="cb17-75"><a href="#cb17-75"></a>        }<span class="cf">else</span>{<span class="fu">return</span>(tabela)}</span>
<span id="cb17-76"><a href="#cb17-76"></a>    }</span>
<span id="cb17-77"><a href="#cb17-77"></a>    }</span>
<span id="cb17-78"><a href="#cb17-78"></a>  </span>
<span id="cb17-79"><a href="#cb17-79"></a>  <span class="fu">return</span>( <span class="fu">lapply</span>(comparacao, AjeitaLista) )</span>
<span id="cb17-80"><a href="#cb17-80"></a>}</span>
<span id="cb17-81"><a href="#cb17-81"></a></span>
<span id="cb17-82"><a href="#cb17-82"></a>CompMult_visual <span class="ot">&lt;-</span> <span class="cf">function</span>(CompMultArrumado, <span class="at">alpha=</span><span class="fl">0.05</span>){</span>
<span id="cb17-83"><a href="#cb17-83"></a>  <span class="fu">library</span>(kableExtra)</span>
<span id="cb17-84"><a href="#cb17-84"></a>  nome_objeto <span class="ot">&lt;-</span> <span class="fu">deparse</span>(<span class="fu">substitute</span>(CompMultArrumado))</span>
<span id="cb17-85"><a href="#cb17-85"></a>  nome_obj_split <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(<span class="fu">gsub</span>(<span class="st">"[`]"</span>, <span class="st">""</span>, nome_objeto), <span class="st">":"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb17-86"><a href="#cb17-86"></a>  fator2_nome <span class="ot">&lt;-</span> nome_obj_split[<span class="dv">2</span>] <span class="co">#quando for 1 fator, isso sera NA</span></span>
<span id="cb17-87"><a href="#cb17-87"></a>  posicao_cifrao <span class="ot">&lt;-</span> <span class="fu">str_locate</span>(nome_obj_split, <span class="st">"</span><span class="sc">\\</span><span class="st">$"</span>)[<span class="dv">1</span>]</span>
<span id="cb17-88"><a href="#cb17-88"></a>  fator1_nome <span class="ot">&lt;-</span> <span class="fu">str_sub</span>(nome_obj_split[<span class="dv">1</span>], posicao_cifrao <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb17-89"><a href="#cb17-89"></a>    </span>
<span id="cb17-90"><a href="#cb17-90"></a>  <span class="cf">if</span>(<span class="sc">!</span>CompMultArrumado <span class="sc">%&gt;%</span> <span class="fu">is.null</span>()){</span>
<span id="cb17-91"><a href="#cb17-91"></a>    tabela <span class="ot">&lt;-</span> CompMultArrumado <span class="sc">%&gt;%</span> </span>
<span id="cb17-92"><a href="#cb17-92"></a>      <span class="fu">arrange</span>(Fator1) <span class="sc">%&gt;%</span> </span>
<span id="cb17-93"><a href="#cb17-93"></a>      <span class="fu">kbl</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">booktabs =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb17-94"><a href="#cb17-94"></a>      <span class="co"># estilo</span></span>
<span id="cb17-95"><a href="#cb17-95"></a>      <span class="fu">row_spec</span>(<span class="dv">0</span>, <span class="at">bold =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb17-96"><a href="#cb17-96"></a>      <span class="fu">kable_classic_2</span>(<span class="at">full_width =</span> F, <span class="at">html_font =</span> <span class="st">"Arial"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-97"><a href="#cb17-97"></a>      <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"responsive"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-98"><a href="#cb17-98"></a>      <span class="fu">kable_paper</span>(<span class="at">full_width =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb17-99"><a href="#cb17-99"></a>      <span class="co"># agrupar linhas</span></span>
<span id="cb17-100"><a href="#cb17-100"></a>      <span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">"middle"</span>) <span class="co"># isso tira o formato tabela bonito igual da anova</span></span>
<span id="cb17-101"><a href="#cb17-101"></a>    </span>
<span id="cb17-102"><a href="#cb17-102"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(fator2_nome)){ <span class="co"># implica que so tem um fator no ajuste</span></span>
<span id="cb17-103"><a href="#cb17-103"></a>      tabela <span class="sc">%&gt;%</span> </span>
<span id="cb17-104"><a href="#cb17-104"></a>        <span class="fu">footnote</span>( <span class="co"># rodape</span></span>
<span id="cb17-105"><a href="#cb17-105"></a>      <span class="at">symbol =</span> <span class="fu">paste0</span>(<span class="st">"significativo a "</span>, (alpha<span class="sc">*</span><span class="dv">100</span>),</span>
<span id="cb17-106"><a href="#cb17-106"></a>                      <span class="st">"% de significância e '.' significativo a "</span>, (<span class="dv">2</span><span class="sc">*</span>alpha<span class="sc">*</span><span class="dv">100</span>),<span class="st">"%"</span>),</span>
<span id="cb17-107"><a href="#cb17-107"></a>      <span class="at">general =</span> <span class="fu">paste0</span>(<span class="st">"Fator1 refere a "</span>, fator1_nome),</span>
<span id="cb17-108"><a href="#cb17-108"></a>      <span class="at">general_title =</span> <span class="st">"Nota: "</span>,<span class="at">footnote_as_chunk =</span> T,</span>
<span id="cb17-109"><a href="#cb17-109"></a>      )</span>
<span id="cb17-110"><a href="#cb17-110"></a>    }<span class="cf">else</span>{ <span class="co"># implica ter mais de um fator no ajuste</span></span>
<span id="cb17-111"><a href="#cb17-111"></a>      tabela <span class="sc">%&gt;%</span> </span>
<span id="cb17-112"><a href="#cb17-112"></a>        <span class="fu">footnote</span>(<span class="co"># rodape</span></span>
<span id="cb17-113"><a href="#cb17-113"></a>        <span class="at">symbol =</span> <span class="fu">paste0</span>(<span class="st">"significativo a "</span>, (alpha<span class="sc">*</span><span class="dv">100</span>),</span>
<span id="cb17-114"><a href="#cb17-114"></a>                        <span class="st">"% de significância e '.' significativo a "</span>, (<span class="dv">2</span><span class="sc">*</span>alpha<span class="sc">*</span><span class="dv">100</span>),<span class="st">"%"</span>),</span>
<span id="cb17-115"><a href="#cb17-115"></a>        <span class="at">general =</span> <span class="fu">paste0</span>(<span class="st">"Fator1 refere a "</span>, fator1_nome, <span class="st">" e Fator2 a "</span>, fator2_nome),</span>
<span id="cb17-116"><a href="#cb17-116"></a>        <span class="at">general_title =</span> <span class="st">"Nota: "</span>,<span class="at">footnote_as_chunk =</span> T,</span>
<span id="cb17-117"><a href="#cb17-117"></a>        )</span>
<span id="cb17-118"><a href="#cb17-118"></a>      }</span>
<span id="cb17-119"><a href="#cb17-119"></a>  }</span>
<span id="cb17-120"><a href="#cb17-120"></a>}</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_compra_ordem</span>
<span id="cb18-2"><a href="#cb18-2"></a>data <span class="ot">=</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="at">review_score =</span> <span class="fu">as.factor</span>(review_score)</span>
<span id="cb18-4"><a href="#cb18-4"></a>)</span>
<span id="cb18-5"><a href="#cb18-5"></a></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="fu">ggplot</span>(<span class="at">data=</span> data)<span class="sc">+</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_price, <span class="at">x =</span> review_score, <span class="at">fill =</span> <span class="fu">as.factor</span>(primeira_compra_cliente)))</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="script__python_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_compra</span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="fu">ggplot</span>(<span class="at">data=</span> data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="sc">-</span>log_price))<span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_price, <span class="at">x =</span> categorias_novas_produtos)) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">mean</span>(data<span class="sc">$</span>log_price), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb19-8"><a href="#cb19-8"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">'Log-Preço'</span>, <span class="at">x =</span> <span class="st">'categoria'</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="script__python_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># | fig-cap: 'Proporção de pedidos por dia da semana'</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>tab_perc_dia <span class="op">=</span> (</span>
<span id="cb20-3"><a href="#cb20-3"></a>    df_ordem_compra_fim</span>
<span id="cb20-4"><a href="#cb20-4"></a>    .groupby([<span class="st">"dia_pedido"</span>, <span class="st">"primeira_compra_cliente"</span>])</span>
<span id="cb20-5"><a href="#cb20-5"></a>    .size()</span>
<span id="cb20-6"><a href="#cb20-6"></a>    .reset_index(name<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb20-7"><a href="#cb20-7"></a>    .pivot(index<span class="op">=</span><span class="st">"dia_pedido"</span>, columns<span class="op">=</span><span class="st">"primeira_compra_cliente"</span>, values<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb20-8"><a href="#cb20-8"></a>    .fillna(<span class="dv">0</span>)</span>
<span id="cb20-9"><a href="#cb20-9"></a>    .reset_index()</span>
<span id="cb20-10"><a href="#cb20-10"></a>    .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-11"><a href="#cb20-11"></a>)</span>
<span id="cb20-12"><a href="#cb20-12"></a></span>
<span id="cb20-13"><a href="#cb20-13"></a>total_dia <span class="op">=</span> tab_perc_dia.drop(columns<span class="op">=</span>[<span class="st">"dia_pedido"</span>]).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-14"><a href="#cb20-14"></a></span>
<span id="cb20-15"><a href="#cb20-15"></a><span class="cf">for</span> col <span class="kw">in</span> tab_perc_dia.columns[<span class="dv">1</span>:]:  <span class="co"># Ignora a coluna 'dia_pedido'</span></span>
<span id="cb20-16"><a href="#cb20-16"></a>    tab_perc_dia[col] <span class="op">=</span> <span class="bu">round</span>((tab_perc_dia[col] <span class="op">/</span> total_dia[col]) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>)</span>
<span id="cb20-17"><a href="#cb20-17"></a></span>
<span id="cb20-18"><a href="#cb20-18"></a>tab_perc_dia.columns <span class="op">=</span> [<span class="st">'Dia do Pedido'</span>, <span class="st">'Cliente Novo'</span>, <span class="st">'Cliente Recorrente'</span>]</span>
<span id="cb20-19"><a href="#cb20-19"></a>tab_perc_dia</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Dia do Pedido  Cliente Novo  Cliente Recorrente
0        Friday         14.26               14.23
1        Monday         16.19               16.27
2      Saturday         11.12               10.91
3        Sunday         12.24               12.03
4      Thursday         15.28               14.82
5       Tuesday         15.38               16.10
6     Wednesday         15.53               15.64</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>py<span class="sc">$</span>df_ordem_compra <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> len_comentario, <span class="at">x =</span> <span class="fu">as_factor</span>(review_score), <span class="at">fill =</span> colocou_titulo)) <span class="sc">+</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>    <span class="fu">geom_boxplot</span>()</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="script__python_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a>df_resultado <span class="op">=</span> (df_compra.groupby([<span class="st">'order_id'</span>, <span class="st">'categorias_novas_produtos'</span>])</span>
<span id="cb23-2"><a href="#cb23-2"></a>  .size()</span>
<span id="cb23-3"><a href="#cb23-3"></a>  .reset_index(name<span class="op">=</span><span class="st">'n'</span>)</span>
<span id="cb23-4"><a href="#cb23-4"></a>  .pivot(index<span class="op">=</span><span class="st">"order_id"</span>, columns<span class="op">=</span><span class="st">"categorias_novas_produtos"</span>, values<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb23-5"><a href="#cb23-5"></a>  .fillna(<span class="dv">0</span>)</span>
<span id="cb23-6"><a href="#cb23-6"></a>  .reset_index()</span>
<span id="cb23-7"><a href="#cb23-7"></a>  .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-8"><a href="#cb23-8"></a>)</span>
<span id="cb23-9"><a href="#cb23-9"></a>df_resultado[<span class="st">'itens_por_ordem'</span>] <span class="op">=</span> df_resultado.drop({<span class="st">'order_id'</span>}, axis <span class="op">=</span> <span class="st">'columns'</span>).<span class="bu">sum</span>(axis <span class="op">=</span> <span class="st">'columns'</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="teste-de-hipótese" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="teste-de-hipótese"><span class="header-section-number">2.1</span> Teste de Hipótese</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Ponto alvo
</div>
</div>
<div class="callout-body-container callout-body">
<p>Variáveis que contribuiem para o aumento do valor de compra dos clientes</p>
</div>
</div>
<ul>
<li>Conclusão aqui é que oferecer voucher não gera efeito significativo no aumento do valor que o cliente gasta na <strong>Olist</strong>.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_compra_ordem</span>
<span id="cb24-2"><a href="#cb24-2"></a>data <span class="ot">=</span> data <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3"></a>  <span class="fu">select</span>(log_price, log_frete, soma_tipos_pagamentos, boleto, credit_card, debit_card,</span>
<span id="cb24-4"><a href="#cb24-4"></a>         pago_a_vista, dia_pedido, regiao_cliente, len_titulo, volume_prod,</span>
<span id="cb24-5"><a href="#cb24-5"></a>         categorias_novas_produtos, review_score, primeira_compra_cliente, voucher) <span class="sc">%&gt;%</span></span>
<span id="cb24-6"><a href="#cb24-6"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb24-7"><a href="#cb24-7"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-8"><a href="#cb24-8"></a>    <span class="at">review_score =</span> <span class="fu">as.factor</span>(review_score),</span>
<span id="cb24-9"><a href="#cb24-9"></a>    <span class="at">boleto =</span> <span class="fu">as.factor</span>(boleto),</span>
<span id="cb24-10"><a href="#cb24-10"></a>    <span class="at">credit_card =</span> <span class="fu">as.factor</span>(credit_card),</span>
<span id="cb24-11"><a href="#cb24-11"></a>    <span class="at">debit_card =</span> <span class="fu">as.factor</span>(debit_card),</span>
<span id="cb24-12"><a href="#cb24-12"></a>    <span class="at">pago_a_vista =</span> <span class="fu">as.factor</span>(pago_a_vista),</span>
<span id="cb24-13"><a href="#cb24-13"></a>    <span class="at">primeira_compra_cliente =</span> <span class="fu">as.factor</span>(primeira_compra_cliente)</span>
<span id="cb24-14"><a href="#cb24-14"></a>  )</span>
<span id="cb24-15"><a href="#cb24-15"></a></span>
<span id="cb24-16"><a href="#cb24-16"></a>fit <span class="ot">=</span> <span class="fu">aov</span>(<span class="at">formula =</span> log_price <span class="sc">~</span> </span>
<span id="cb24-17"><a href="#cb24-17"></a>            log_frete <span class="sc">+</span> soma_tipos_pagamentos <span class="sc">+</span> boleto <span class="sc">+</span> credit_card <span class="sc">+</span> debit_card <span class="sc">+</span></span>
<span id="cb24-18"><a href="#cb24-18"></a>            pago_a_vista<span class="sc">+</span>dia_pedido<span class="sc">+</span>regiao_cliente<span class="sc">+</span>len_titulo<span class="sc">+</span>volume_prod <span class="sc">+</span></span>
<span id="cb24-19"><a href="#cb24-19"></a>            categorias_novas_produtos  <span class="sc">+</span> review_score <span class="sc">+</span></span>
<span id="cb24-20"><a href="#cb24-20"></a>            primeira_compra_cliente<span class="sc">*</span>categorias_novas_produtos <span class="sc">+</span>voucher, <span class="at">data =</span> data)</span>
<span id="cb24-21"><a href="#cb24-21"></a><span class="fu">interpreta_ANOVA</span>(fit)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="tabwid"><style>.cl-227b5034{table-layout:auto;}.cl-226a859c{font-family:'Arial';font-size:11pt;font-weight:bold;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-226a85ce{font-family:'Arial';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-226f2d0e{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-226f2d18{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-226f53a6{background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-226f53b0{background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-226f53b1{background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-226f53ba{background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-226f53bb{background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-226f53c4{background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-226f53c5{background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing="true" class="cl-227b5034"><thead><tr style="overflow-wrap:break-word;"><th class="cl-226f53a6"><p class="cl-226f2d0e"><span class="cl-226a859c">Covariável</span></p></th><th class="cl-226f53b0"><p class="cl-226f2d18"><span class="cl-226a859c">gl</span></p></th><th class="cl-226f53b0"><p class="cl-226f2d18"><span class="cl-226a859c">SQ</span></p></th><th class="cl-226f53b0"><p class="cl-226f2d18"><span class="cl-226a859c">MQ</span></p></th><th class="cl-226f53a6"><p class="cl-226f2d0e"><span class="cl-226a859c">F</span></p></th><th class="cl-226f53a6"><p class="cl-226f2d0e"><span class="cl-226a859c">Pvalor</span></p></th></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Log_frete</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">1</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">16,941.942</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">16,941.942</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">27825.176</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Soma_tipos_pagamentos</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">1</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">550.725</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">550.725</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">904.502</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Boleto</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">1</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">82.508</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">82.508</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">135.509</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Credit_card</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">2</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">24.910</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">12.455</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">20.456</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Debit_card</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">1</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">1.423</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">1.423</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">2.338</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce"> 0.126</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Pago_a_vista</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">1</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">15.592</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">15.592</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">25.608</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Dia_pedido</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">6</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">19.166</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">3.194</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">5.246</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Regiao_cliente</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">4</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">924.780</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">231.195</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">379.711</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Len_titulo</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">1</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">6.834</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">6.834</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">11.224</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce"> 0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Volume_prod</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">1</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">2,454.738</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">2,454.738</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">4031.623</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Categorias_novas_produtos</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">25</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">6,331.268</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">253.251</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">415.935</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Review_score</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">4</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">35.919</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">8.980</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">14.748</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Primeira_compra_cliente</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">1</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">24.559</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">24.559</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">40.336</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Voucher</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">1</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">0.978</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">0.978</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">1.607</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce"> 0.205</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a859c">Categorias_novas_produtos : Primeira_compra_cliente</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">25</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">164.906</span></p></td><td class="cl-226f53ba"><p class="cl-226f2d18"><span class="cl-226a85ce">6.596</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">10.834</span></p></td><td class="cl-226f53b1"><p class="cl-226f2d0e"><span class="cl-226a85ce">&lt;0.001*</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-226f53bb"><p class="cl-226f2d0e"><span class="cl-226a859c">Residuals</span></p></td><td class="cl-226f53c4"><p class="cl-226f2d18"><span class="cl-226a85ce">112,293</span></p></td><td class="cl-226f53c4"><p class="cl-226f2d18"><span class="cl-226a85ce">68,371.949</span></p></td><td class="cl-226f53c4"><p class="cl-226f2d18"><span class="cl-226a85ce">0.609</span></p></td><td class="cl-226f53bb"><p class="cl-226f2d0e"><span class="cl-226a85ce"></span></p></td><td class="cl-226f53bb"><p class="cl-226f2d0e"><span class="cl-226a85ce"> </span></p></td></tr></tbody><tfoot><tr style="overflow-wrap:break-word;"><td colspan="6" class="cl-226f53c5"><p class="cl-226f2d0e"><span class="cl-226a85ce">Significativo a 5% de significância e '.' significativo a 10%</span></p></td></tr></tfoot></table></div>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">anova</span>(fit, <span class="fu">update</span>(fit, <span class="sc">~</span>. <span class="sc">-</span>voucher))</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Model 1: log_price ~ log_frete + soma_tipos_pagamentos + boleto + credit_card + 
    debit_card + pago_a_vista + dia_pedido + regiao_cliente + 
    len_titulo + volume_prod + categorias_novas_produtos + review_score + 
    primeira_compra_cliente * categorias_novas_produtos + voucher
Model 2: log_price ~ log_frete + soma_tipos_pagamentos + boleto + credit_card + 
    debit_card + pago_a_vista + dia_pedido + regiao_cliente + 
    len_titulo + volume_prod + categorias_novas_produtos + review_score + 
    primeira_compra_cliente + categorias_novas_produtos:primeira_compra_cliente
  Res.Df   RSS Df Sum of Sq      F Pr(&gt;F)
1 112293 68372                           
2 112294 68373 -1  -0.92483 1.5189 0.2178</code></pre>
</div>
</div>
<section id="qual-categoria-está-contribuindo-mais-para-o-valor-gasto-do-cliente" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="qual-categoria-está-contribuindo-mais-para-o-valor-gasto-do-cliente"><span class="header-section-number">2.1.1</span> Qual categoria está contribuindo mais para o valor gasto do cliente?</h3>
<blockquote class="blockquote">
<p>Quando compara-se <strong>TER COMPRADO ANTERIORMENTO VS CATEGORIA DE PRODUTO</strong> (fiz um recorte para <em>pet-shop</em>)</p>
</blockquote>
<ul>
<li><p>Alimento e pet-shop, se a primeira compra gasta-se mais com pet-shop, a próxima será com alimentação e vice-versa. Caso ambas estejam na mesma compra, gasta-se mais com alimentação</p></li>
<li><p>Artesanato supera pet-shop sempre, exceto quando ambos são comprados em compras futuras, aí são iguais na contribuição do gasto do cliente na loja</p></li>
<li><p>Itens de casa se sobressaem dos itens de pet-shop na primeira compra. Quando se gasta mais em pet-shop, parece implicar que a pessoa passa a gastar menos com itens de casa. Algo similar é concluído para eletrodomésticos, acessórios de informática e PC’s.</p></li>
<li><p>Pet-shop supera itens de telefonia em todos os casos de compra</p></li>
<li><p>Pet-shop perde para portáteis em todos os casos de compra, ou seja, o gasto com portáteis supera esse item tanto na primeira quanto na segunda compra.</p></li>
<li><p>Pet-shop só se sobressai de itens de beleza e saúde quando já foi comprado anteriormente</p></li>
<li><p>Pet-shop sempre perde para itens de fashion (roupas), exceto quando já se tenha comprado anteriormente</p></li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Dica
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Possíveis Estratégias para vender mais itens de Pet-Shop:</strong></p>
<ul>
<li>Parece que o cliente alvo para os itens de pet-shop, gasta mais com esses itens depois que estão com seus itens básicos já adquiridos em suas primeiras compras. Depois de garantir seus itens básicos e gastar com seus pets, esse cliente está mais apto a gastar mais com artesanato, ‘coisas legais’ e itens de viagem, por exemplo.</li>
</ul>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># So categoricas aqui</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>data_aov <span class="ot">=</span>  data <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">select</span>(</span>
<span id="cb27-4"><a href="#cb27-4"></a>    log_price,  <span class="co"># Inclui log_price sempre</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>    <span class="fu">where</span>(<span class="sc">~</span> <span class="fu">is.factor</span>(.) <span class="sc">|</span> <span class="fu">is.character</span>(.))  <span class="co"># Seleciona as colunas categóricas</span></span>
<span id="cb27-6"><a href="#cb27-6"></a>  )</span>
<span id="cb27-7"><a href="#cb27-7"></a></span>
<span id="cb27-8"><a href="#cb27-8"></a>fit_final <span class="ot">=</span> fit <span class="ot">=</span> <span class="fu">aov</span>(<span class="at">formula =</span> log_price <span class="sc">~</span> </span>
<span id="cb27-9"><a href="#cb27-9"></a>            boleto <span class="sc">+</span> credit_card <span class="sc">+</span> debit_card <span class="sc">+</span></span>
<span id="cb27-10"><a href="#cb27-10"></a>            pago_a_vista<span class="sc">+</span>dia_pedido<span class="sc">+</span>regiao_cliente<span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11"></a>            categorias_novas_produtos  <span class="sc">+</span> review_score <span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12"></a>            primeira_compra_cliente<span class="sc">*</span>categorias_novas_produtos, <span class="at">data =</span> data_aov)</span>
<span id="cb27-13"><a href="#cb27-13"></a></span>
<span id="cb27-14"><a href="#cb27-14"></a>tukey_result_teste <span class="ot">&lt;-</span> <span class="fu">TukeyHSD</span>(fit_final)</span>
<span id="cb27-15"><a href="#cb27-15"></a>tukey_result <span class="ot">&lt;-</span> <span class="fu">Arruma_CompMult</span>(tukey_result_teste)</span>
<span id="cb27-16"><a href="#cb27-16"></a></span>
<span id="cb27-17"><a href="#cb27-17"></a>tukey_amostra <span class="ot">&lt;-</span> tukey_result<span class="sc">$</span><span class="st">`</span><span class="at">categorias_novas_produtos:primeira_compra_cliente</span><span class="st">`</span> <span class="sc">%&gt;%</span></span>
<span id="cb27-18"><a href="#cb27-18"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"PET_SHOP"</span>, Fator1))</span>
<span id="cb27-19"><a href="#cb27-19"></a></span>
<span id="cb27-20"><a href="#cb27-20"></a><span class="fu">CompMult_visual</span>(tukey_amostra)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="lightable-classic-2 table lightable-paper caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Fator1</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Fator2</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Diferença</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Pvalor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ALIMENTO - PET_SHOP</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">-0.531</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">ARTESANATO_LEGAL - PET_SHOP</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.385</td>
<td style="text-align: center;">0.002*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">EVENTO - PET_SHOP</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">-0.597</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">INDUSTRIA - PET_SHOP</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.554</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td rowspan="3" style="text-align: center; vertical-align: middle !important;">PET_SHOP - ALIMENTO</td>
<td style="text-align: center;">0 : 0</td>
<td style="text-align: center;">0.631</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.670</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">0.570</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td rowspan="2" style="text-align: center; vertical-align: middle !important;">PET_SHOP - ARTESANATO_LEGAL</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">-0.271</td>
<td style="text-align: center;">0.091.</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">-0.346</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - BELEZA_SAUDE</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.191</td>
<td style="text-align: center;">0.003*</td>
</tr>
<tr class="odd">
<td rowspan="2" style="text-align: center; vertical-align: middle !important;">PET_SHOP - CASA</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.173</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">0.107</td>
<td style="text-align: center;">0.001*</td>
</tr>
<tr class="odd">
<td rowspan="3" style="text-align: center; vertical-align: middle !important;">PET_SHOP - ELETRODOMESTICOS</td>
<td style="text-align: center;">0 : 0</td>
<td style="text-align: center;">0.510</td>
<td style="text-align: center;">0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.549</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">-0.144</td>
<td style="text-align: center;">0.070.</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - EVENTO</td>
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">0.635</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td rowspan="3" style="text-align: center; vertical-align: middle !important;">PET_SHOP - FASHION</td>
<td style="text-align: center;">0 : 0</td>
<td style="text-align: center;">0.461</td>
<td style="text-align: center;">0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.500</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">0.314</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - INDUSTRIA</td>
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">-0.515</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PET_SHOP - INFORMATICA_ACESSORIOS</td>
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">0.207</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - MALAS_ACESSORIOS</td>
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">-0.261</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PET_SHOP - MARKET_PLACE</td>
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">0.220</td>
<td style="text-align: center;">0.060.</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - MIDIA_MUSICA</td>
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">-0.224</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PET_SHOP - MOVEIS</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.188</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td rowspan="2" style="text-align: center; vertical-align: middle !important;">PET_SHOP - PAPELARIA</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.380</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">0.183</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - PC</td>
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">0.142</td>
<td style="text-align: center;">0.024*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PET_SHOP - PORTATEIS</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">-0.799</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - RELOGIOS_PRESENTES</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">-0.249</td>
<td style="text-align: center;">0.002*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PET_SHOP - TELEFONIA</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.698</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td rowspan="3" style="text-align: center; vertical-align: middle !important;">PORTATEIS - PET_SHOP</td>
<td style="text-align: center;">0 : 0</td>
<td style="text-align: center;">0.838</td>
<td style="text-align: center;">0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.567</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">0.528</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td rowspan="2" style="text-align: center; vertical-align: middle !important;">RELOGIOS_PRESENTES - PET_SHOP</td>
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">0.526</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">0.487</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td rowspan="3" style="text-align: center; vertical-align: middle !important;">TELEFONIA - PET_SHOP</td>
<td style="text-align: center;">0 : 0</td>
<td style="text-align: center;">-0.659</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">1 : 0</td>
<td style="text-align: center;">-0.646</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1 : 1</td>
<td style="text-align: center;">-0.685</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: center; padding: 0;"><span style="font-style: italic;">Nota: </span> <sup></sup> Fator1 refere a NA</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center; padding: 0;"><sup>*</sup> significativo a 5% de significância e '.' significativo a 10%</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tfoot>

</table>
</div>


</div>
</div>
<p><strong>Abaixo será feita uma análise marginal de pet-shop, ou seja, desconsiderando a ordem da compra:</strong></p>
<p>Aqui vemos uma análise mais direta do que já foi concluído acima:</p>
<ul>
<li>Gasta-se mais com Pet-shop em relação a itens de consumo domésticos</li>
<li>Gasta-se menos com Pet-shop em relação a itens de desejo, como artigos de viagem e artesanato</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb28-2"><a href="#cb28-2"></a>  tukey_result<span class="sc">$</span>categorias_novas_produtos<span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"PET_SHOP"</span>, Fator1))</span>
<span id="cb28-4"><a href="#cb28-4"></a>  )</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="lightable-classic-2 table lightable-paper caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Fator1</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Diferença</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Pvalor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">PET_SHOP - ALIMENTO</td>
<td style="text-align: center;">0.576</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - ARTESANATO_LEGAL</td>
<td style="text-align: center;">-0.345</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PET_SHOP - CASA</td>
<td style="text-align: center;">0.110</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - EVENTO</td>
<td style="text-align: center;">0.655</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PET_SHOP - FASHION</td>
<td style="text-align: center;">0.336</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - INDUSTRIA</td>
<td style="text-align: center;">-0.489</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PET_SHOP - INFORMATICA_ACESSORIOS</td>
<td style="text-align: center;">0.187</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - MALAS_ACESSORIOS</td>
<td style="text-align: center;">-0.263</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PET_SHOP - MARKET_PLACE</td>
<td style="text-align: center;">0.218</td>
<td style="text-align: center;">0.015*</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - MIDIA_MUSICA</td>
<td style="text-align: center;">-0.203</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PET_SHOP - PAPELARIA</td>
<td style="text-align: center;">0.190</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">PET_SHOP - PC</td>
<td style="text-align: center;">0.131</td>
<td style="text-align: center;">0.018*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PORTATEIS - PET_SHOP</td>
<td style="text-align: center;">0.542</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">RELOGIOS_PRESENTES - PET_SHOP</td>
<td style="text-align: center;">0.476</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">TELEFONIA - PET_SHOP</td>
<td style="text-align: center;">-0.683</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: center; padding: 0;"><span style="font-style: italic;">Nota: </span> <sup></sup> Fator1 refere a categorias_novas_produtos %&gt;% filter(grepl("PET_SHOP",</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center; padding: 0;"><sup>*</sup> significativo a 5% de significância e '.' significativo a 10%</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tfoot>

</table>
</div>


</div>
</div>
</section>
</section>
<section id="outras-análises-mais-diretas" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="outras-análises-mais-diretas"><span class="header-section-number">2.2</span> Outras análises mais diretas:</h2>
<section id="sec-gasto_ava" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="sec-gasto_ava"><span class="header-section-number">2.2.1</span> Gasto vs Avaliação</h3>
<ul>
<li>Clientes que gastam mais ou em produtos mais caros tendem a gostar mais de sua experiência de compra</li>
<li><strong>Clientes que avaliam em nota máxima e mínima gastam de forma igual. Isso pode ser indicativo que há outras variáveis que se associam ao gasto e a satisfação do cliente</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb29-2"><a href="#cb29-2"></a>  tukey_result<span class="sc">$</span>review_score</span>
<span id="cb29-3"><a href="#cb29-3"></a>  )</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="lightable-classic-2 table lightable-paper caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Fator1</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Diferença</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Pvalor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">2 - 1</td>
<td style="text-align: center;">-0.041</td>
<td style="text-align: center;">0.074.</td>
</tr>
<tr class="even">
<td style="text-align: center;">3 - 1</td>
<td style="text-align: center;">-0.044</td>
<td style="text-align: center;">0.002*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4 - 2</td>
<td style="text-align: center;">0.040</td>
<td style="text-align: center;">0.075.</td>
</tr>
<tr class="even">
<td style="text-align: center;">4 - 3</td>
<td style="text-align: center;">0.042</td>
<td style="text-align: center;">0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5 - 2</td>
<td style="text-align: center;">0.040</td>
<td style="text-align: center;">0.050*</td>
</tr>
<tr class="even">
<td style="text-align: center;">5 - 3</td>
<td style="text-align: center;">0.042</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: center; padding: 0;"><span style="font-style: italic;">Nota: </span> <sup></sup> Fator1 refere a review_score</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center; padding: 0;"><sup>*</sup> significativo a 5% de significância e '.' significativo a 10%</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tfoot>

</table>
</div>


</div>
</div>
</section>
<section id="gasto-vs-primeira-compra" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="gasto-vs-primeira-compra"><span class="header-section-number">2.2.2</span> Gasto vs Primeira compra</h3>
<ul>
<li>De fato, gasta-se mais na primeira compra. Como a <a href="#sec-gasto_ava" class="quarto-xref">Seção&nbsp;2.2.1</a> mostrou que satisfação não está associada ao gasto, é importante garantir outros incentivos além da boa experiência para o cliente na sua compra.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb30-2"><a href="#cb30-2"></a>  tukey_result<span class="sc">$</span>primeira_compra_cliente</span>
<span id="cb30-3"><a href="#cb30-3"></a>  )</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="lightable-classic-2 table lightable-paper caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Fator1</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Diferença</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Pvalor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1 - 0</td>
<td style="text-align: center;">0.095</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: center; padding: 0;"><span style="font-style: italic;">Nota: </span> <sup></sup> Fator1 refere a primeira_compra_cliente</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center; padding: 0;"><sup>*</sup> significativo a 5% de significância e '.' significativo a 10%</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tfoot>

</table>
</div>


</div>
</div>
</section>
<section id="gasto-vs-região" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="gasto-vs-região"><span class="header-section-number">2.2.3</span> Gasto vs Região</h3>
<p>Em relação aos gastos:</p>
<p><span class="math display">\[NorteNordeste &gt;  Sudeste-SP = Centro-Oeste &gt; Sul &gt; SP\]</span></p>
<ul>
<li>Nesse caso, também indicou que <span class="math inline">\(Sudeste-SP = Sul\)</span> mas <span class="math inline">\(Centro-Oeste \neq Sul\)</span> o que é um pouco contraintuitivo, mas talvez numa amostra maior, ou considerando interações, seria possível afirmar em quais condições faz com que Centro-Oeste e Sul se diferenciem.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb31-2"><a href="#cb31-2"></a>  tukey_result<span class="sc">$</span>regiao_cliente</span>
<span id="cb31-3"><a href="#cb31-3"></a>  )</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="lightable-classic-2 table lightable-paper caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Fator1</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Diferença</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Pvalor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">NorteNordeste - Centro_Oeste</td>
<td style="text-align: center;">0.085</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">SP - Centro_Oeste</td>
<td style="text-align: center;">-0.142</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">SP - NorteNordeste</td>
<td style="text-align: center;">-0.228</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">Sudeste_SP - NorteNordeste</td>
<td style="text-align: center;">-0.111</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Sudeste_SP - SP</td>
<td style="text-align: center;">0.116</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">Sul - Centro_Oeste</td>
<td style="text-align: center;">-0.043</td>
<td style="text-align: center;">0.019*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Sul - NorteNordeste</td>
<td style="text-align: center;">-0.128</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">Sul - SP</td>
<td style="text-align: center;">0.099</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: center; padding: 0;"><span style="font-style: italic;">Nota: </span> <sup></sup> Fator1 refere a regiao_cliente</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center; padding: 0;"><sup>*</sup> significativo a 5% de significância e '.' significativo a 10%</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tfoot>

</table>
</div>


</div>
</div>
</section>
<section id="gasto-vs-dia-da-compra" class="level3" data-number="2.2.4">
<h3 data-number="2.2.4" class="anchored" data-anchor-id="gasto-vs-dia-da-compra"><span class="header-section-number">2.2.4</span> Gasto vs Dia da compra</h3>
<p>Domingo é o pior dia de compra, quando pensa-se em gasto médio, seguido por sábado.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb32-2"><a href="#cb32-2"></a>  tukey_result<span class="sc">$</span>dia_pedido</span>
<span id="cb32-3"><a href="#cb32-3"></a>  )</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="lightable-classic-2 table lightable-paper caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Fator1</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Diferença</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Pvalor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Sunday - Friday</td>
<td style="text-align: center;">-0.028</td>
<td style="text-align: center;">0.098.</td>
</tr>
<tr class="even">
<td style="text-align: center;">Sunday - Monday</td>
<td style="text-align: center;">-0.044</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Sunday - Saturday</td>
<td style="text-align: center;">-0.037</td>
<td style="text-align: center;">0.017*</td>
</tr>
<tr class="even">
<td style="text-align: center;">Thursday - Sunday</td>
<td style="text-align: center;">0.029</td>
<td style="text-align: center;">0.077.</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Tuesday - Sunday</td>
<td style="text-align: center;">0.032</td>
<td style="text-align: center;">0.022*</td>
</tr>
<tr class="even">
<td style="text-align: center;">Wednesday - Sunday</td>
<td style="text-align: center;">0.031</td>
<td style="text-align: center;">0.038*</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: center; padding: 0;"><span style="font-style: italic;">Nota: </span> <sup></sup> Fator1 refere a dia_pedido</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center; padding: 0;"><sup>*</sup> significativo a 5% de significância e '.' significativo a 10%</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tfoot>

</table>
</div>


</div>
</div>
</section>
<section id="gasto-vs-forma-de-pagamento" class="level3" data-number="2.2.5">
<h3 data-number="2.2.5" class="anchored" data-anchor-id="gasto-vs-forma-de-pagamento"><span class="header-section-number">2.2.5</span> Gasto vs Forma de pagamento</h3>
<ul>
<li>Pessoas que optam por boleto, gastam menos</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb33-2"><a href="#cb33-2"></a>  tukey_result<span class="sc">$</span>boleto</span>
<span id="cb33-3"><a href="#cb33-3"></a>  )</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="lightable-classic-2 table lightable-paper caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Fator1</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Diferença</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Pvalor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1 - 0</td>
<td style="text-align: center;">-0.152</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: center; padding: 0;"><span style="font-style: italic;">Nota: </span> <sup></sup> Fator1 refere a boleto</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center; padding: 0;"><sup>*</sup> significativo a 5% de significância e '.' significativo a 10%</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tfoot>

</table>
</div>


</div>
</div>
<ul>
<li>Pessoas que optam por cartão de crédito e a usam em mais parcelas, gastam mais</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb34-2"><a href="#cb34-2"></a>  tukey_result<span class="sc">$</span>credit_card</span>
<span id="cb34-3"><a href="#cb34-3"></a>  )</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="lightable-classic-2 table lightable-paper caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Fator1</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Diferença</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Pvalor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1 - 0</td>
<td style="text-align: center;">0.046</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="even">
<td style="text-align: center;">2 - 0</td>
<td style="text-align: center;">0.607</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2 - 1</td>
<td style="text-align: center;">0.560</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: center; padding: 0;"><span style="font-style: italic;">Nota: </span> <sup></sup> Fator1 refere a credit_card</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center; padding: 0;"><sup>*</sup> significativo a 5% de significância e '.' significativo a 10%</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tfoot>

</table>
</div>


</div>
</div>
<ul>
<li>Pessoas que optam por cartão de débito, gastam mais</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb35-2"><a href="#cb35-2"></a>  tukey_result<span class="sc">$</span>debit_card</span>
<span id="cb35-3"><a href="#cb35-3"></a>  )</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="lightable-classic-2 table lightable-paper caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Fator1</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Diferença</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;">Pvalor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1 - 0</td>
<td style="text-align: center;">0.119</td>
<td style="text-align: center;">&lt;0.001*</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: center; padding: 0;"><span style="font-style: italic;">Nota: </span> <sup></sup> Fator1 refere a debit_card</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center; padding: 0;"><sup>*</sup> significativo a 5% de significância e '.' significativo a 10%</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tfoot>

</table>
</div>


</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Dica
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Possíveis Estratégias para vender mais itens de Pet-Shop nas demais análises:</strong></p>
<ul>
<li>Incentivar o uso do cartão de crédito e parcelado poderia gerar mais oportunidade do cliente gastar mais na loja. Promoções no meio de semana são igualmente eficazes para aumentar o ticket-médio do cliente. Aproveitar a primeira compra do cliente para arrecadar mais em sua compra, mas também garantir que ele volte para gastar com itens de desejo ao invés de apenas artigos de necessidade-imediata refletirão de forma positiva no gasto do cliente na loja. Por fim, aumentar a exposição no mercado Norte-Nordeste parece gerar um crescimento mais significativo que nas demais regiões.</li>
</ul>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1"></a><span class="co"># (df_prod_final</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="co">#     .groupby(["categorias_novas_produtos"])</span></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="co">#     .size()</span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="co">#     .reset_index(name="n")</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="co">#     .pivot(index="product_id", columns="payment_type", values="n")</span></span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="co">#     .fillna(0)</span></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="co">#     .reset_index()</span></span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="co">#     .rename_axis(None, axis=1)</span></span>
<span id="cb36-9"><a href="#cb36-9"></a><span class="co"># )</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="componenentes-principais-para-o-cliente" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Componenentes Principais para o Cliente</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1"></a>df_pca_dummy <span class="op">=</span> pd.get_dummies(df_final[<span class="st">'regiao_cliente'</span>], dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb37-2"><a href="#cb37-2"></a>df_pca <span class="op">=</span> pd.concat([df_final.drop(<span class="st">'regiao_cliente'</span>, axis<span class="op">=</span><span class="dv">1</span>), df_pca_dummy], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-3"><a href="#cb37-3"></a></span>
<span id="cb37-4"><a href="#cb37-4"></a>colunas_pca <span class="op">=</span> [<span class="st">'boleto'</span>, <span class="st">'credit_card'</span>, <span class="st">'debit_card'</span>, <span class="st">'voucher'</span>,</span>
<span id="cb37-5"><a href="#cb37-5"></a>       <span class="st">'soma_tipos_pagamentos'</span>, <span class="st">'log_valor_pago'</span>, <span class="st">'pago_a_vista'</span>,</span>
<span id="cb37-6"><a href="#cb37-6"></a>       <span class="st">'log_valor_medio_parcela'</span>,<span class="st">'tempo_conf_pedido'</span>, <span class="st">'atraso_prev_entrega'</span>,</span>
<span id="cb37-7"><a href="#cb37-7"></a>       <span class="st">'review_score'</span>, <span class="st">'len_titulo'</span>, <span class="st">'len_comentario'</span>,<span class="st">'comentario_exc'</span>, <span class="st">'colocou_titulo'</span>,</span>
<span id="cb37-8"><a href="#cb37-8"></a>       <span class="st">'colocou_exc'</span>,<span class="st">'primeira_compra_cliente'</span>,<span class="st">'log_price'</span>, <span class="st">'log_frete'</span>,</span>
<span id="cb37-9"><a href="#cb37-9"></a>       <span class="st">'product_name_lenght'</span>, <span class="st">'product_description_lenght'</span>,</span>
<span id="cb37-10"><a href="#cb37-10"></a>       <span class="st">'product_photos_qty'</span>, <span class="st">'product_weight_g'</span>, <span class="st">'product_length_cm'</span>,</span>
<span id="cb37-11"><a href="#cb37-11"></a>       <span class="st">'product_height_cm'</span>, <span class="st">'product_width_cm'</span>, <span class="st">'volume_prod'</span>, <span class="st">'ALIMENTO'</span>,</span>
<span id="cb37-12"><a href="#cb37-12"></a>       <span class="st">'ARTESANATO_LEGAL'</span>, <span class="st">'AUTOMOTIVO'</span>, <span class="st">'BEBES'</span>, <span class="st">'BELEZA_SAUDE'</span>, <span class="st">'BRINQUEDOS'</span>,</span>
<span id="cb37-13"><a href="#cb37-13"></a>       <span class="st">'CASA'</span>, <span class="st">'CONSTRUCAO_FERRAMENTAS'</span>, <span class="st">'ELETRODOMESTICOS'</span>, <span class="st">'ESPORTE_LAZER'</span>,</span>
<span id="cb37-14"><a href="#cb37-14"></a>       <span class="st">'EVENTO'</span>, <span class="st">'FASHION'</span>, <span class="st">'INDUSTRIA'</span>, <span class="st">'INFORMATICA_ACESSORIOS'</span>,</span>
<span id="cb37-15"><a href="#cb37-15"></a>       <span class="st">'MALAS_ACESSORIOS'</span>, <span class="st">'MARKET_PLACE'</span>, <span class="st">'MIDIA_MUSICA'</span>, <span class="st">'MOVEIS'</span>,</span>
<span id="cb37-16"><a href="#cb37-16"></a>       <span class="st">'PAPELARIA'</span>, <span class="st">'PC'</span>, <span class="st">'PERFUMARIA'</span>, <span class="st">'PET_SHOP'</span>, <span class="st">'PORTATEIS'</span>,</span>
<span id="cb37-17"><a href="#cb37-17"></a>       <span class="st">'RELOGIOS_PRESENTES'</span>, <span class="st">'SEGURANCA'</span>, <span class="st">'TELEFONIA'</span>]</span>
<span id="cb37-18"><a href="#cb37-18"></a></span>
<span id="cb37-19"><a href="#cb37-19"></a><span class="co"># Imputando dados faltantes - df_pca[colunas_pca].isnull().sum()</span></span>
<span id="cb37-20"><a href="#cb37-20"></a>df_pca.loc[:, [<span class="st">'product_weight_g'</span>, <span class="st">'product_length_cm'</span>,<span class="st">'product_height_cm'</span>,<span class="st">'product_width_cm'</span>]] <span class="op">=</span> (</span>
<span id="cb37-21"><a href="#cb37-21"></a>  inpute.fit_transform(df_pca[[<span class="st">'product_weight_g'</span>,<span class="st">'product_length_cm'</span>,<span class="st">'product_height_cm'</span>,<span class="st">'product_width_cm'</span>]])</span>
<span id="cb37-22"><a href="#cb37-22"></a>  )</span>
<span id="cb37-23"><a href="#cb37-23"></a></span>
<span id="cb37-24"><a href="#cb37-24"></a></span>
<span id="cb37-25"><a href="#cb37-25"></a><span class="co">#df_final.customer_unique_id </span></span>
<span id="cb37-26"><a href="#cb37-26"></a>x_treino <span class="op">=</span> df_pca[colunas_pca]</span>
<span id="cb37-27"><a href="#cb37-27"></a></span>
<span id="cb37-28"><a href="#cb37-28"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb37-29"><a href="#cb37-29"></a></span>
<span id="cb37-30"><a href="#cb37-30"></a>pca <span class="op">=</span> PCA()</span>
<span id="cb37-31"><a href="#cb37-31"></a>X_train_pca <span class="op">=</span> pca.fit_transform(</span>
<span id="cb37-32"><a href="#cb37-32"></a>  scaler.fit_transform(x_treino) <span class="co"># dados reescalados</span></span>
<span id="cb37-33"><a href="#cb37-33"></a>  )</span>
<span id="cb37-34"><a href="#cb37-34"></a></span>
<span id="cb37-35"><a href="#cb37-35"></a>per_var <span class="op">=</span> np.<span class="bu">round</span>(pca.explained_variance_ratio_<span class="op">*</span><span class="dv">100</span>, decimals<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-36"><a href="#cb37-36"></a>labels <span class="op">=</span> [<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(per_var)<span class="op">+</span><span class="dv">1</span>)]</span>
<span id="cb37-37"><a href="#cb37-37"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb37-38"><a href="#cb37-38"></a><span class="co">#plot scree plot</span></span>
<span id="cb37-39"><a href="#cb37-39"></a>plt.bar(x<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(per_var)<span class="op">+</span><span class="dv">1</span>), height<span class="op">=</span>per_var)</span>
<span id="cb37-40"><a href="#cb37-40"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, which <span class="op">=</span> <span class="st">'both'</span>, bottom<span class="op">=</span><span class="va">False</span>, top<span class="op">=</span><span class="va">False</span>, labelbottom<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-41"><a href="#cb37-41"></a>plt.ylabel(<span class="st">"Explained variance (%)"</span>)</span>
<span id="cb37-42"><a href="#cb37-42"></a>plt.xlabel(<span class="st">'Principal Components'</span>)</span>
<span id="cb37-43"><a href="#cb37-43"></a>plt.title(<span class="st">'Scree Plot'</span>)</span>
<span id="cb37-44"><a href="#cb37-44"></a>plt.show()</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="script__python_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiada");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiada");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Código fonte</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb38" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb38-1"><a href="#cb38-1"></a><span class="co">---</span></span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="an">title:</span><span class="co"> "Case Olist"</span></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="an">author:</span><span class="co"> "Nathalia"</span></span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb38-6"><a href="#cb38-6"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb38-7"><a href="#cb38-7"></a><span class="an">number-sections:</span><span class="co"> true</span></span>
<span id="cb38-8"><a href="#cb38-8"></a><span class="an">date-format:</span><span class="co"> "DD/MM/YYYY"</span></span>
<span id="cb38-9"><a href="#cb38-9"></a><span class="an">toc-title:</span><span class="co"> "Tópicos" </span></span>
<span id="cb38-10"><a href="#cb38-10"></a><span class="an">lang:</span><span class="co"> "pt-BR"</span></span>
<span id="cb38-11"><a href="#cb38-11"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb38-12"><a href="#cb38-12"></a><span class="an">code-fold:</span><span class="co"> false</span></span>
<span id="cb38-13"><a href="#cb38-13"></a><span class="an">code-line-numbers:</span><span class="co"> true</span></span>
<span id="cb38-14"><a href="#cb38-14"></a><span class="an">resources:</span><span class="co"> </span></span>
<span id="cb38-15"><a href="#cb38-15"></a><span class="co">  - "_src/src.R"</span></span>
<span id="cb38-16"><a href="#cb38-16"></a><span class="an">code-summary:</span><span class="co"> 'CODE'</span></span>
<span id="cb38-17"><a href="#cb38-17"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb38-18"><a href="#cb38-18"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb38-19"><a href="#cb38-19"></a><span class="an">execute:</span></span>
<span id="cb38-20"><a href="#cb38-20"></a><span class="co">  warning: false</span></span>
<span id="cb38-21"><a href="#cb38-21"></a><span class="co">---</span></span>
<span id="cb38-22"><a href="#cb38-22"></a></span>
<span id="cb38-23"><a href="#cb38-23"></a><span class="fu"># Processamento e tratamento de dados</span></span>
<span id="cb38-26"><a href="#cb38-26"></a><span class="in">```{python}</span></span>
<span id="cb38-27"><a href="#cb38-27"></a><span class="co">#globals().clear() # limpa ambiente</span></span>
<span id="cb38-28"><a href="#cb38-28"></a></span>
<span id="cb38-29"><a href="#cb38-29"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb38-30"><a href="#cb38-30"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb38-31"><a href="#cb38-31"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb38-32"><a href="#cb38-32"></a><span class="im">from</span> plotnine <span class="im">import</span> ggplot, aes, geom_point, labs, geom_boxplot</span>
<span id="cb38-33"><a href="#cb38-33"></a></span>
<span id="cb38-34"><a href="#cb38-34"></a></span>
<span id="cb38-35"><a href="#cb38-35"></a><span class="co"># ANOVA</span></span>
<span id="cb38-36"><a href="#cb38-36"></a><span class="im">import</span> researchpy <span class="im">as</span> rp</span>
<span id="cb38-37"><a href="#cb38-37"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb38-38"><a href="#cb38-38"></a><span class="im">from</span> statsmodels.formula.api <span class="im">import</span> ols</span>
<span id="cb38-39"><a href="#cb38-39"></a></span>
<span id="cb38-40"><a href="#cb38-40"></a>pd.set_option(<span class="st">"display.max_columns"</span>, <span class="va">None</span>)</span>
<span id="cb38-41"><a href="#cb38-41"></a><span class="in">```</span></span>
<span id="cb38-42"><a href="#cb38-42"></a></span>
<span id="cb38-45"><a href="#cb38-45"></a><span class="in">```{r}</span></span>
<span id="cb38-46"><a href="#cb38-46"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb38-47"><a href="#cb38-47"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb38-48"><a href="#cb38-48"></a><span class="do">## carregando funções auxiliares</span></span>
<span id="cb38-49"><a href="#cb38-49"></a><span class="fu">source</span>(<span class="st">"_src/src.R"</span>)</span>
<span id="cb38-50"><a href="#cb38-50"></a><span class="in">```</span></span>
<span id="cb38-51"><a href="#cb38-51"></a></span>
<span id="cb38-54"><a href="#cb38-54"></a><span class="in">```{python}</span></span>
<span id="cb38-55"><a href="#cb38-55"></a><span class="co"># Leitura dos dados</span></span>
<span id="cb38-56"><a href="#cb38-56"></a>df_pagamentos <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_order_payments_dataset.csv"</span>)</span>
<span id="cb38-57"><a href="#cb38-57"></a>pag_menos_freq <span class="op">=</span> df_pagamentos[<span class="st">"payment_type"</span>].value_counts().idxmin()</span>
<span id="cb38-58"><a href="#cb38-58"></a>pag_mais_freq <span class="op">=</span> df_pagamentos[<span class="st">"payment_type"</span>].value_counts().idxmax()</span>
<span id="cb38-59"><a href="#cb38-59"></a>df_pagamentos[<span class="st">"payment_type"</span>] <span class="op">=</span> df_pagamentos[<span class="st">"payment_type"</span>].replace(pag_menos_freq, pag_mais_freq)</span>
<span id="cb38-60"><a href="#cb38-60"></a></span>
<span id="cb38-61"><a href="#cb38-61"></a><span class="co"># para descritiva</span></span>
<span id="cb38-62"><a href="#cb38-62"></a>df_tipo_pagamento <span class="op">=</span> (df_pagamentos</span>
<span id="cb38-63"><a href="#cb38-63"></a>    .groupby(<span class="st">"payment_type"</span>)</span>
<span id="cb38-64"><a href="#cb38-64"></a>    .agg(</span>
<span id="cb38-65"><a href="#cb38-65"></a>        n<span class="op">=</span>(<span class="st">"payment_type"</span>,<span class="st">"count"</span>),</span>
<span id="cb38-66"><a href="#cb38-66"></a>        log_valor_pago<span class="op">=</span>(<span class="st">"payment_value"</span>, <span class="kw">lambda</span> x: np.log(x.<span class="bu">sum</span>()<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb38-67"><a href="#cb38-67"></a>    )</span>
<span id="cb38-68"><a href="#cb38-68"></a>    .reset_index()</span>
<span id="cb38-69"><a href="#cb38-69"></a>)</span>
<span id="cb38-70"><a href="#cb38-70"></a></span>
<span id="cb38-71"><a href="#cb38-71"></a></span>
<span id="cb38-72"><a href="#cb38-72"></a><span class="co"># Forma de pagamento</span></span>
<span id="cb38-73"><a href="#cb38-73"></a>df_forma_pag <span class="op">=</span> (df_pagamentos</span>
<span id="cb38-74"><a href="#cb38-74"></a>    .groupby([<span class="st">"order_id"</span>, <span class="st">"payment_type"</span>])</span>
<span id="cb38-75"><a href="#cb38-75"></a>    .size()</span>
<span id="cb38-76"><a href="#cb38-76"></a>    .reset_index(name<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb38-77"><a href="#cb38-77"></a>    .pivot(index<span class="op">=</span><span class="st">"order_id"</span>, columns<span class="op">=</span><span class="st">"payment_type"</span>, values<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb38-78"><a href="#cb38-78"></a>    .fillna(<span class="dv">0</span>)</span>
<span id="cb38-79"><a href="#cb38-79"></a>    .reset_index()</span>
<span id="cb38-80"><a href="#cb38-80"></a>    .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-81"><a href="#cb38-81"></a>)</span>
<span id="cb38-82"><a href="#cb38-82"></a>df_forma_pag[<span class="st">"soma_tipos_pagamentos"</span>] <span class="op">=</span> df_forma_pag.<span class="bu">filter</span>(like<span class="op">=</span><span class="st">"_card"</span>).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-83"><a href="#cb38-83"></a></span>
<span id="cb38-84"><a href="#cb38-84"></a><span class="co"># Registro de pagamento</span></span>
<span id="cb38-85"><a href="#cb38-85"></a>df_registro <span class="op">=</span> (df_pagamentos</span>
<span id="cb38-86"><a href="#cb38-86"></a>    .groupby(<span class="st">"order_id"</span>)</span>
<span id="cb38-87"><a href="#cb38-87"></a>    .agg(</span>
<span id="cb38-88"><a href="#cb38-88"></a>        ex_pago_escala_original<span class="op">=</span>(<span class="st">"payment_value"</span>,<span class="st">"sum"</span>),</span>
<span id="cb38-89"><a href="#cb38-89"></a>        log_valor_pago<span class="op">=</span>(<span class="st">"payment_value"</span>, <span class="kw">lambda</span> x: np.log(x.<span class="bu">sum</span>()<span class="op">+</span><span class="dv">1</span>)),</span>
<span id="cb38-90"><a href="#cb38-90"></a>        pago_a_vista<span class="op">=</span>(<span class="st">"payment_sequential"</span>, <span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x.<span class="bu">max</span>() <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span>),</span>
<span id="cb38-91"><a href="#cb38-91"></a>        log_valor_medio_parcela<span class="op">=</span>(<span class="st">"payment_value"</span>, <span class="kw">lambda</span> x: np.log(x.mean()<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb38-92"><a href="#cb38-92"></a>    )</span>
<span id="cb38-93"><a href="#cb38-93"></a>    .reset_index()</span>
<span id="cb38-94"><a href="#cb38-94"></a>)</span>
<span id="cb38-95"><a href="#cb38-95"></a></span>
<span id="cb38-96"><a href="#cb38-96"></a>df_log_exemplo <span class="op">=</span> df_registro[[<span class="st">'order_id'</span>,<span class="st">'ex_pago_escala_original'</span>, <span class="st">'log_valor_pago'</span>]] <span class="co"># auxiliar</span></span>
<span id="cb38-97"><a href="#cb38-97"></a>df_log <span class="op">=</span> df_log_exemplo.melt(id_vars<span class="op">=</span>[<span class="st">'order_id'</span>], var_name<span class="op">=</span><span class="st">'variavel'</span>, value_name<span class="op">=</span><span class="st">'valor'</span>)</span>
<span id="cb38-98"><a href="#cb38-98"></a></span>
<span id="cb38-99"><a href="#cb38-99"></a><span class="co"># Dados dos pedidos</span></span>
<span id="cb38-100"><a href="#cb38-100"></a>df_pedidos <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_orders_dataset.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">"order_purchase_timestamp"</span>, <span class="st">"order_approved_at"</span>, <span class="st">"order_delivered_customer_date"</span>, <span class="st">"order_estimated_delivery_date"</span>])</span>
<span id="cb38-101"><a href="#cb38-101"></a>data_atual <span class="op">=</span> pd.to_datetime(<span class="st">"2018-05-31"</span>)</span>
<span id="cb38-102"><a href="#cb38-102"></a></span>
<span id="cb38-103"><a href="#cb38-103"></a>df_pedidos[<span class="st">"dia_pedido"</span>] <span class="op">=</span> df_pedidos[<span class="st">"order_purchase_timestamp"</span>].dt.day_name()</span>
<span id="cb38-104"><a href="#cb38-104"></a>df_pedidos[<span class="st">"tempo_conf_pedido"</span>] <span class="op">=</span> np.where(</span>
<span id="cb38-105"><a href="#cb38-105"></a>    df_pedidos[<span class="st">"order_approved_at"</span>].isna(),</span>
<span id="cb38-106"><a href="#cb38-106"></a>    (data_atual <span class="op">-</span> df_pedidos[<span class="st">"order_purchase_timestamp"</span>]).dt.days,</span>
<span id="cb38-107"><a href="#cb38-107"></a>    (df_pedidos[<span class="st">"order_approved_at"</span>] <span class="op">-</span> df_pedidos[<span class="st">"order_purchase_timestamp"</span>]).dt.days</span>
<span id="cb38-108"><a href="#cb38-108"></a>)</span>
<span id="cb38-109"><a href="#cb38-109"></a>df_pedidos[<span class="st">"atraso_prev_entrega"</span>] <span class="op">=</span> np.where(</span>
<span id="cb38-110"><a href="#cb38-110"></a>    (df_pedidos[<span class="st">"order_estimated_delivery_date"</span>].isna()) <span class="op">&amp;</span></span>
<span id="cb38-111"><a href="#cb38-111"></a>    ((data_atual <span class="op">-</span> df_pedidos[<span class="st">"order_delivered_customer_date"</span>]).dt.days <span class="op">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb38-112"><a href="#cb38-112"></a>    <span class="dv">1</span>,</span>
<span id="cb38-113"><a href="#cb38-113"></a>    np.where(</span>
<span id="cb38-114"><a href="#cb38-114"></a>        (<span class="op">~</span>df_pedidos[<span class="st">"order_estimated_delivery_date"</span>].isna()) <span class="op">&amp;</span></span>
<span id="cb38-115"><a href="#cb38-115"></a>        ((df_pedidos[<span class="st">"order_estimated_delivery_date"</span>] <span class="op">-</span> df_pedidos[<span class="st">"order_delivered_customer_date"</span>]).dt.days <span class="op">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb38-116"><a href="#cb38-116"></a>        <span class="dv">1</span>,</span>
<span id="cb38-117"><a href="#cb38-117"></a>        <span class="dv">0</span></span>
<span id="cb38-118"><a href="#cb38-118"></a>    )</span>
<span id="cb38-119"><a href="#cb38-119"></a>)</span>
<span id="cb38-120"><a href="#cb38-120"></a></span>
<span id="cb38-121"><a href="#cb38-121"></a><span class="co"># Dados dos clientes</span></span>
<span id="cb38-122"><a href="#cb38-122"></a>df_cliente <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_customers_dataset.csv"</span>)</span>
<span id="cb38-123"><a href="#cb38-123"></a>df_cliente[<span class="st">"regiao_cliente"</span>] <span class="op">=</span> np.select(</span>
<span id="cb38-124"><a href="#cb38-124"></a>    [</span>
<span id="cb38-125"><a href="#cb38-125"></a>        df_cliente[<span class="st">"customer_state"</span>].isin([<span class="st">"SP"</span>]),</span>
<span id="cb38-126"><a href="#cb38-126"></a>        df_cliente[<span class="st">"customer_state"</span>].isin([<span class="st">"MG"</span>, <span class="st">"RJ"</span>, <span class="st">"ES"</span>]),</span>
<span id="cb38-127"><a href="#cb38-127"></a>        df_cliente[<span class="st">"customer_state"</span>].isin([<span class="st">"PR"</span>, <span class="st">"RS"</span>, <span class="st">"MS"</span>]),</span>
<span id="cb38-128"><a href="#cb38-128"></a>        df_cliente[<span class="st">"customer_state"</span>].isin([<span class="st">"DF"</span>, <span class="st">"GO"</span>, <span class="st">"MT"</span>])</span>
<span id="cb38-129"><a href="#cb38-129"></a>    ],</span>
<span id="cb38-130"><a href="#cb38-130"></a>    [<span class="st">"SP"</span>, <span class="st">"Sudeste_SP"</span>, <span class="st">"Sul"</span>, <span class="st">"Centro_Oeste"</span>],</span>
<span id="cb38-131"><a href="#cb38-131"></a>    default<span class="op">=</span><span class="st">"NorteNordeste"</span></span>
<span id="cb38-132"><a href="#cb38-132"></a>)</span>
<span id="cb38-133"><a href="#cb38-133"></a></span>
<span id="cb38-134"><a href="#cb38-134"></a><span class="co"># Dados das avaliações</span></span>
<span id="cb38-135"><a href="#cb38-135"></a>df_avalia <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_order_reviews_dataset.csv"</span>)</span>
<span id="cb38-136"><a href="#cb38-136"></a>df_avalia[<span class="st">"len_titulo"</span>] <span class="op">=</span> df_avalia[<span class="st">"review_comment_title"</span>].<span class="bu">str</span>.<span class="bu">len</span>().fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb38-137"><a href="#cb38-137"></a>df_avalia[<span class="st">"len_comentario"</span>] <span class="op">=</span> df_avalia[<span class="st">"review_comment_message"</span>].<span class="bu">str</span>.<span class="bu">len</span>().fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb38-138"><a href="#cb38-138"></a>df_avalia[<span class="st">"comentario_exc"</span>] <span class="op">=</span> df_avalia[<span class="st">"review_comment_message"</span>].<span class="bu">str</span>.count(<span class="st">"!"</span>).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb38-139"><a href="#cb38-139"></a>df_avalia[<span class="st">"colocou_titulo"</span>] <span class="op">=</span> np.where(df_avalia[<span class="st">"len_titulo"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb38-140"><a href="#cb38-140"></a>df_avalia[<span class="st">"colocou_exc"</span>] <span class="op">=</span> np.where(df_avalia[<span class="st">"comentario_exc"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb38-141"><a href="#cb38-141"></a></span>
<span id="cb38-142"><a href="#cb38-142"></a><span class="co"># União das tabelas</span></span>
<span id="cb38-143"><a href="#cb38-143"></a>df_ordem_compra <span class="op">=</span> (</span>
<span id="cb38-144"><a href="#cb38-144"></a>    df_forma_pag</span>
<span id="cb38-145"><a href="#cb38-145"></a>    .merge(df_registro, on<span class="op">=</span><span class="st">"order_id"</span>)</span>
<span id="cb38-146"><a href="#cb38-146"></a>    .merge(df_pedidos, on<span class="op">=</span><span class="st">"order_id"</span>)</span>
<span id="cb38-147"><a href="#cb38-147"></a>    .merge(df_avalia, on<span class="op">=</span><span class="st">"order_id"</span>)</span>
<span id="cb38-148"><a href="#cb38-148"></a>    .merge(df_cliente, on<span class="op">=</span><span class="st">"customer_id"</span>)</span>
<span id="cb38-149"><a href="#cb38-149"></a>)</span>
<span id="cb38-150"><a href="#cb38-150"></a></span>
<span id="cb38-151"><a href="#cb38-151"></a><span class="co"># Análise da primeira compra</span></span>
<span id="cb38-152"><a href="#cb38-152"></a>df_ordem_primeira_compra <span class="op">=</span> (df_ordem_compra</span>
<span id="cb38-153"><a href="#cb38-153"></a>    .groupby(<span class="st">"customer_unique_id"</span>)</span>
<span id="cb38-154"><a href="#cb38-154"></a>    .agg(</span>
<span id="cb38-155"><a href="#cb38-155"></a>        data_prim_compra<span class="op">=</span>(<span class="st">"order_purchase_timestamp"</span>, <span class="st">"min"</span>),</span>
<span id="cb38-156"><a href="#cb38-156"></a>        data_ultima_compra<span class="op">=</span>(<span class="st">"order_purchase_timestamp"</span>, <span class="st">"max"</span>),</span>
<span id="cb38-157"><a href="#cb38-157"></a>        primeira_compra_cliente<span class="op">=</span>(<span class="st">"order_id"</span>, <span class="kw">lambda</span> x: <span class="dv">0</span> <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">1</span>)</span>
<span id="cb38-158"><a href="#cb38-158"></a>    )</span>
<span id="cb38-159"><a href="#cb38-159"></a>    .reset_index()</span>
<span id="cb38-160"><a href="#cb38-160"></a>)</span>
<span id="cb38-161"><a href="#cb38-161"></a></span>
<span id="cb38-162"><a href="#cb38-162"></a>df_ordem_compra_fim <span class="op">=</span> (</span>
<span id="cb38-163"><a href="#cb38-163"></a>    df_ordem_compra</span>
<span id="cb38-164"><a href="#cb38-164"></a>    .merge(df_ordem_primeira_compra, on<span class="op">=</span><span class="st">"customer_unique_id"</span>)</span>
<span id="cb38-165"><a href="#cb38-165"></a>    .assign(</span>
<span id="cb38-166"><a href="#cb38-166"></a>        primeira_ordem_por_cliente<span class="op">=</span><span class="kw">lambda</span> x: np.where(</span>
<span id="cb38-167"><a href="#cb38-167"></a>            x[<span class="st">"data_prim_compra"</span>] <span class="op">==</span> x[<span class="st">"order_purchase_timestamp"</span>],</span>
<span id="cb38-168"><a href="#cb38-168"></a>            <span class="st">"Primeira"</span>,</span>
<span id="cb38-169"><a href="#cb38-169"></a>            np.where(</span>
<span id="cb38-170"><a href="#cb38-170"></a>                x[<span class="st">"data_ultima_compra"</span>] <span class="op">==</span> x[<span class="st">"order_purchase_timestamp"</span>],</span>
<span id="cb38-171"><a href="#cb38-171"></a>                <span class="st">"Ultima"</span>,</span>
<span id="cb38-172"><a href="#cb38-172"></a>                <span class="st">"2oumais"</span></span>
<span id="cb38-173"><a href="#cb38-173"></a>            )</span>
<span id="cb38-174"><a href="#cb38-174"></a>        )</span>
<span id="cb38-175"><a href="#cb38-175"></a>    )</span>
<span id="cb38-176"><a href="#cb38-176"></a>)</span>
<span id="cb38-177"><a href="#cb38-177"></a><span class="in">```</span></span>
<span id="cb38-178"><a href="#cb38-178"></a></span>
<span id="cb38-179"><a href="#cb38-179"></a><span class="at">&gt; Comentários:</span></span>
<span id="cb38-180"><a href="#cb38-180"></a></span>
<span id="cb38-181"><a href="#cb38-181"></a><span class="ss">- </span>Deixei o formato comprido (wider) para conseguir representar informações categoricas como numeral de forma mais eficiente e para destrinchar informações das ordens para agrupar por cliente</span>
<span id="cb38-182"><a href="#cb38-182"></a><span class="ss">- </span>Tipo de pagamento indefinido foi usado o tipo mais frequente (Menos frequente: <span class="in">`r py$pag_menos_freq`</span> e Mais frquente: <span class="in">`r py$pag_mais_freq`</span>)</span>
<span id="cb38-183"><a href="#cb38-183"></a><span class="ss">- </span>Pedidos cancelados ou coisas do tipo foram mantidos pois guardam informação parcial de que o cliente 'estava disposto a comprar tal item'</span>
<span id="cb38-184"><a href="#cb38-184"></a><span class="ss">- </span>Tranformou-se os dados de precificação em log-escala para normalizar os dados: </span>
<span id="cb38-185"><a href="#cb38-185"></a></span>
<span id="cb38-188"><a href="#cb38-188"></a><span class="in">```{r}</span></span>
<span id="cb38-189"><a href="#cb38-189"></a><span class="co">#| fig-cap: 'Densidade por tipo de dado' </span></span>
<span id="cb38-190"><a href="#cb38-190"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_log</span>
<span id="cb38-191"><a href="#cb38-191"></a></span>
<span id="cb38-192"><a href="#cb38-192"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> valor, <span class="at">fill =</span> variavel)) <span class="sc">+</span></span>
<span id="cb38-193"><a href="#cb38-193"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span>  </span>
<span id="cb38-194"><a href="#cb38-194"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Valor"</span>, <span class="at">y =</span> <span class="st">"Densidade"</span>) <span class="sc">+</span></span>
<span id="cb38-195"><a href="#cb38-195"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"ex_pago_escala_original"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"log_valor_pago"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb38-196"><a href="#cb38-196"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">100</span>)) <span class="sc">+</span>  </span>
<span id="cb38-197"><a href="#cb38-197"></a>  <span class="fu">theme_minimal</span>() </span>
<span id="cb38-198"><a href="#cb38-198"></a><span class="in">```</span></span>
<span id="cb38-199"><a href="#cb38-199"></a></span>
<span id="cb38-200"><a href="#cb38-200"></a><span class="ss">- </span>Por haver poucos clientes que compraram mais de uma vez, e ainda menos que compraram mais de 2 vezes. Algumas vezes optei por tratar como binário: ter sido ou não primeira compra, por exemplo</span>
<span id="cb38-201"><a href="#cb38-201"></a></span>
<span id="cb38-204"><a href="#cb38-204"></a><span class="in">```{python}</span></span>
<span id="cb38-205"><a href="#cb38-205"></a><span class="co">#########################</span></span>
<span id="cb38-206"><a href="#cb38-206"></a><span class="co"># Itens e produtos</span></span>
<span id="cb38-207"><a href="#cb38-207"></a>df_items <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_order_items_dataset.csv"</span>)</span>
<span id="cb38-208"><a href="#cb38-208"></a>df_items[<span class="st">"log_price"</span>] <span class="op">=</span> np.log(df_items[<span class="st">"price"</span>])</span>
<span id="cb38-209"><a href="#cb38-209"></a>df_items[<span class="st">"log_frete"</span>] <span class="op">=</span> np.log(df_items[<span class="st">"freight_value"</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb38-210"><a href="#cb38-210"></a>df_items_agg <span class="op">=</span> (df_items</span>
<span id="cb38-211"><a href="#cb38-211"></a>    .groupby(<span class="st">"order_id"</span>)  </span>
<span id="cb38-212"><a href="#cb38-212"></a>    .agg(</span>
<span id="cb38-213"><a href="#cb38-213"></a>        produtos_por_pedido<span class="op">=</span>(<span class="st">"order_item_id"</span>, <span class="st">"count"</span>),  </span>
<span id="cb38-214"><a href="#cb38-214"></a>        log_price_pedido<span class="op">=</span>(<span class="st">"log_price"</span>, <span class="st">"sum"</span>),          </span>
<span id="cb38-215"><a href="#cb38-215"></a>        log_frete_pedido<span class="op">=</span>(<span class="st">"log_frete"</span>, <span class="st">"sum"</span>),          </span>
<span id="cb38-216"><a href="#cb38-216"></a>        log_price_medio_pedido<span class="op">=</span>(<span class="st">"log_price"</span>, <span class="st">"mean"</span>)    </span>
<span id="cb38-217"><a href="#cb38-217"></a>    )</span>
<span id="cb38-218"><a href="#cb38-218"></a>    .reset_index()</span>
<span id="cb38-219"><a href="#cb38-219"></a>)</span>
<span id="cb38-220"><a href="#cb38-220"></a></span>
<span id="cb38-221"><a href="#cb38-221"></a><span class="co"># Produtos</span></span>
<span id="cb38-222"><a href="#cb38-222"></a>df_prod <span class="op">=</span> pd.read_csv(<span class="st">"olist_dados/archive/olist_products_dataset.csv"</span>)</span>
<span id="cb38-223"><a href="#cb38-223"></a></span>
<span id="cb38-224"><a href="#cb38-224"></a>n_categoria_incial <span class="op">=</span> <span class="bu">len</span>(df_prod.product_category_name.unique()) <span class="co"># auxiliar tabela</span></span>
<span id="cb38-225"><a href="#cb38-225"></a>n_categoria_incial_nula <span class="op">=</span> df_prod.product_category_name.isnull().<span class="bu">sum</span>() <span class="co"># auxiliar tabela</span></span>
<span id="cb38-226"><a href="#cb38-226"></a></span>
<span id="cb38-227"><a href="#cb38-227"></a>df_prod[<span class="st">'categorias_novas_produtos'</span>] <span class="op">=</span> np.where(</span>
<span id="cb38-228"><a href="#cb38-228"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"ferramentas"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"CONSTRUCAO_FERRAMENTAS"</span>, </span>
<span id="cb38-229"><a href="#cb38-229"></a>    np.where(</span>
<span id="cb38-230"><a href="#cb38-230"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"fashion_"</span>, na<span class="op">=</span><span class="va">False</span>),<span class="st">"FASHION"</span>,</span>
<span id="cb38-231"><a href="#cb38-231"></a>    np.where(</span>
<span id="cb38-232"><a href="#cb38-232"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"moveis_"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"MOVEIS"</span>,</span>
<span id="cb38-233"><a href="#cb38-233"></a>    np.where(</span>
<span id="cb38-234"><a href="#cb38-234"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"eletrodomesticos"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"ELETRODOMESTICOS"</span>,</span>
<span id="cb38-235"><a href="#cb38-235"></a>    np.where(</span>
<span id="cb38-236"><a href="#cb38-236"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"dvd"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"MIDIA_MUSICA"</span>,</span>
<span id="cb38-237"><a href="#cb38-237"></a>    np.where(</span>
<span id="cb38-238"><a href="#cb38-238"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"pc"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"INFORMATICA_ACESSORIOS"</span>,</span>
<span id="cb38-239"><a href="#cb38-239"></a>    np.where(</span>
<span id="cb38-240"><a href="#cb38-240"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"industria"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"INDUSTRIA"</span>,</span>
<span id="cb38-241"><a href="#cb38-241"></a>    np.where(</span>
<span id="cb38-242"><a href="#cb38-242"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"musica"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"MIDIA_MUSICA"</span>,</span>
<span id="cb38-243"><a href="#cb38-243"></a>    np.where(</span>
<span id="cb38-244"><a href="#cb38-244"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"portateis"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"PORTATEIS"</span>,</span>
<span id="cb38-245"><a href="#cb38-245"></a>    np.where(</span>
<span id="cb38-246"><a href="#cb38-246"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"livros"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"PAPELARIA"</span>,</span>
<span id="cb38-247"><a href="#cb38-247"></a>    np.where(</span>
<span id="cb38-248"><a href="#cb38-248"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"telefonia"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"TELEFONIA"</span>,</span>
<span id="cb38-249"><a href="#cb38-249"></a>    np.where(</span>
<span id="cb38-250"><a href="#cb38-250"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"artigo"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"EVENTO"</span>,</span>
<span id="cb38-251"><a href="#cb38-251"></a>    np.where(</span>
<span id="cb38-252"><a href="#cb38-252"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"casa"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"CASA"</span>,</span>
<span id="cb38-253"><a href="#cb38-253"></a>    np.where(</span>
<span id="cb38-254"><a href="#cb38-254"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"artes"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"ARTESANATO_LEGAL"</span>,</span>
<span id="cb38-255"><a href="#cb38-255"></a>    np.where(</span>
<span id="cb38-256"><a href="#cb38-256"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"segur"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"SEGURANCA"</span>,</span>
<span id="cb38-257"><a href="#cb38-257"></a>    np.where(</span>
<span id="cb38-258"><a href="#cb38-258"></a>      df_prod[<span class="st">'product_category_name'</span>].<span class="bu">str</span>.contains(<span class="st">"bebida"</span>, na<span class="op">=</span><span class="va">False</span>), <span class="st">"ALIMENTO"</span>,</span>
<span id="cb38-259"><a href="#cb38-259"></a>    df_prod[<span class="st">'product_category_name'</span>]</span>
<span id="cb38-260"><a href="#cb38-260"></a>))))))))))))))))</span>
<span id="cb38-261"><a href="#cb38-261"></a></span>
<span id="cb38-262"><a href="#cb38-262"></a>df_prod[<span class="st">'categorias_novas_produtos'</span>] <span class="op">=</span> df_prod[<span class="st">'categorias_novas_produtos'</span>].replace(</span>
<span id="cb38-263"><a href="#cb38-263"></a>  {<span class="st">"papelaria"</span>: <span class="st">'PAPELARIA'</span></span>
<span id="cb38-264"><a href="#cb38-264"></a>  ,<span class="st">'cine_foto'</span>: <span class="st">"MIDIA_MUSICA"</span></span>
<span id="cb38-265"><a href="#cb38-265"></a>  ,<span class="st">'fraldas_higiene'</span>: <span class="st">'bebes'</span></span>
<span id="cb38-266"><a href="#cb38-266"></a>  ,<span class="st">'audio'</span>: <span class="st">"MIDIA_MUSICA"</span></span>
<span id="cb38-267"><a href="#cb38-267"></a>  ,<span class="st">'consoles_games'</span>: <span class="st">"PC"</span></span>
<span id="cb38-268"><a href="#cb38-268"></a>  ,<span class="st">'alimentos'</span>: <span class="st">"ALIMENTO"</span></span>
<span id="cb38-269"><a href="#cb38-269"></a>  ,<span class="st">'flores'</span>: <span class="st">"ALIMENTO"</span></span>
<span id="cb38-270"><a href="#cb38-270"></a>  ,<span class="st">'casa_construcao'</span>: <span class="st">"CONSTRUCAO_FERRAMENTAS"</span></span>
<span id="cb38-271"><a href="#cb38-271"></a>  ,<span class="st">'eletroportateis'</span>: <span class="st">"PORTATEIS"</span></span>
<span id="cb38-272"><a href="#cb38-272"></a>  ,<span class="st">'utilidades_domesticas'</span>: <span class="st">"CASA"</span></span>
<span id="cb38-273"><a href="#cb38-273"></a>  ,<span class="st">'cama_mesa_banho'</span>: <span class="st">"CASA"</span></span>
<span id="cb38-274"><a href="#cb38-274"></a>  ,<span class="st">'climatizacao'</span>: <span class="st">"CASA"</span></span>
<span id="cb38-275"><a href="#cb38-275"></a>  ,<span class="st">'la_cuisine'</span>: <span class="st">"CASA"</span></span>
<span id="cb38-276"><a href="#cb38-276"></a>  ,<span class="st">'eletronicos'</span>: <span class="st">"INFORMATICA_ACESSORIOS"</span></span>
<span id="cb38-277"><a href="#cb38-277"></a>  ,<span class="st">'tablets_impressao_imagem'</span>: <span class="st">"INFORMATICA_ACESSORIOS"</span></span>
<span id="cb38-278"><a href="#cb38-278"></a>  ,<span class="st">'cool_stuff'</span>: <span class="st">"ARTESANATO_LEGAL"</span>}</span>
<span id="cb38-279"><a href="#cb38-279"></a>)</span>
<span id="cb38-280"><a href="#cb38-280"></a></span>
<span id="cb38-281"><a href="#cb38-281"></a>df_prod.categorias_novas_produtos <span class="op">=</span> df_prod.categorias_novas_produtos.<span class="bu">str</span>.upper()</span>
<span id="cb38-282"><a href="#cb38-282"></a></span>
<span id="cb38-283"><a href="#cb38-283"></a><span class="co"># tabela auxiliar</span></span>
<span id="cb38-284"><a href="#cb38-284"></a>tab_freq_cat <span class="op">=</span> (df_prod.groupby(<span class="st">'categorias_novas_produtos'</span>).size()</span>
<span id="cb38-285"><a href="#cb38-285"></a>    .sort_values(ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>).reset_index())</span>
<span id="cb38-286"><a href="#cb38-286"></a>tab_freq_cat.columns <span class="op">=</span> [<span class="st">'categorias'</span>, <span class="st">'Antes'</span>]</span>
<span id="cb38-287"><a href="#cb38-287"></a></span>
<span id="cb38-288"><a href="#cb38-288"></a><span class="co">#--------- Tratamento categorias nulas</span></span>
<span id="cb38-289"><a href="#cb38-289"></a><span class="co"># uma linnha de bebe tinha medidas nulas. Vamos susbituir pela media</span></span>
<span id="cb38-290"><a href="#cb38-290"></a>df_bb_nulo <span class="op">=</span> df_prod[(df_prod[<span class="st">'product_weight_g'</span>].isnull()) <span class="op">&amp;</span> (df_prod[<span class="st">'categorias_novas_produtos'</span>] <span class="op">==</span> <span class="st">'BEBES'</span>)]</span>
<span id="cb38-291"><a href="#cb38-291"></a>indice <span class="op">=</span> df_bb_nulo.index</span>
<span id="cb38-292"><a href="#cb38-292"></a>tamanho <span class="op">=</span> df_bb_nulo.product_name_lenght.iloc[<span class="dv">0</span>]</span>
<span id="cb38-293"><a href="#cb38-293"></a>desc <span class="op">=</span> df_bb_nulo.product_description_lenght.iloc[<span class="dv">0</span>]</span>
<span id="cb38-294"><a href="#cb38-294"></a>quant <span class="op">=</span> df_bb_nulo.product_photos_qty.iloc[<span class="dv">0</span>]</span>
<span id="cb38-295"><a href="#cb38-295"></a></span>
<span id="cb38-296"><a href="#cb38-296"></a>df_prod_bb <span class="op">=</span> df_prod[</span>
<span id="cb38-297"><a href="#cb38-297"></a>  (df_prod[<span class="st">'categorias_novas_produtos'</span>] <span class="op">==</span> <span class="st">'BEBES'</span>) <span class="op">&amp;</span> </span>
<span id="cb38-298"><a href="#cb38-298"></a>  (df_prod[<span class="st">'product_name_lenght'</span>] <span class="op">&gt;=</span> tamanho) <span class="op">&amp;</span> </span>
<span id="cb38-299"><a href="#cb38-299"></a>  (df_prod[<span class="st">'product_description_lenght'</span>] <span class="op">&gt;=</span> desc) <span class="op">&amp;</span> </span>
<span id="cb38-300"><a href="#cb38-300"></a>  (df_prod[<span class="st">'product_photos_qty'</span>] <span class="op">&gt;=</span> quant)</span>
<span id="cb38-301"><a href="#cb38-301"></a>]</span>
<span id="cb38-302"><a href="#cb38-302"></a></span>
<span id="cb38-303"><a href="#cb38-303"></a>nomes_colunas_substituicao<span class="op">=</span>[<span class="st">'product_weight_g'</span>,<span class="st">'product_length_cm'</span>,<span class="st">'product_height_cm'</span>,<span class="st">'product_width_cm'</span>]</span>
<span id="cb38-304"><a href="#cb38-304"></a>valores_estimados <span class="op">=</span> df_prod_bb[nomes_colunas_substituicao].mean()</span>
<span id="cb38-305"><a href="#cb38-305"></a><span class="cf">for</span> coluna <span class="kw">in</span> nomes_colunas_substituicao:</span>
<span id="cb38-306"><a href="#cb38-306"></a>  df_prod.loc[indice,coluna] <span class="op">=</span> valores_estimados[coluna]</span>
<span id="cb38-307"><a href="#cb38-307"></a></span>
<span id="cb38-308"><a href="#cb38-308"></a><span class="co"># segundo tratamento ***</span></span>
<span id="cb38-309"><a href="#cb38-309"></a><span class="co">#df_prod[df_prod['product_weight_g'].isnull()]</span></span>
<span id="cb38-310"><a href="#cb38-310"></a></span>
<span id="cb38-311"><a href="#cb38-311"></a><span class="co"># terceiro tratamento - trazendo info de avaliacao (existe associacao entre avaliacao e num de carac)</span></span>
<span id="cb38-312"><a href="#cb38-312"></a>df_reg<span class="op">=</span> df_items.merge(df_prod, on<span class="op">=</span><span class="st">"product_id"</span>).merge(df_avalia, on<span class="op">=</span><span class="st">"order_id"</span>)</span>
<span id="cb38-313"><a href="#cb38-313"></a>colunas_reg <span class="op">=</span> [</span>
<span id="cb38-314"><a href="#cb38-314"></a>  <span class="st">"product_id"</span>,<span class="st">'categorias_novas_produtos'</span>,</span>
<span id="cb38-315"><a href="#cb38-315"></a>  <span class="co"># info produto</span></span>
<span id="cb38-316"><a href="#cb38-316"></a>  <span class="st">'product_name_lenght'</span>,<span class="st">'product_description_lenght'</span>, <span class="st">'product_photos_qty'</span>, <span class="st">'product_weight_g'</span>,<span class="st">'product_length_cm'</span>, <span class="st">'product_height_cm'</span>, <span class="st">'product_width_cm'</span>,</span>
<span id="cb38-317"><a href="#cb38-317"></a>  <span class="co"># info preco</span></span>
<span id="cb38-318"><a href="#cb38-318"></a>  <span class="st">'log_price'</span>,<span class="st">'log_frete'</span>,</span>
<span id="cb38-319"><a href="#cb38-319"></a>  <span class="co"># avalicao</span></span>
<span id="cb38-320"><a href="#cb38-320"></a>  <span class="st">'review_score'</span>,<span class="st">'len_titulo'</span>, <span class="st">'len_comentario'</span>,<span class="st">'comentario_exc'</span>, <span class="st">'colocou_titulo'</span>, <span class="st">'colocou_exc'</span></span>
<span id="cb38-321"><a href="#cb38-321"></a>  ]</span>
<span id="cb38-322"><a href="#cb38-322"></a></span>
<span id="cb38-323"><a href="#cb38-323"></a>df_reg <span class="op">=</span> df_reg[colunas_reg]</span>
<span id="cb38-324"><a href="#cb38-324"></a>df_reg_dummy <span class="op">=</span> pd.get_dummies(<span class="st">'nota'</span> <span class="op">+</span> df_reg[<span class="st">'review_score'</span>].astype(<span class="bu">str</span>), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb38-325"><a href="#cb38-325"></a>df_reg <span class="op">=</span> pd.concat([df_reg.drop(<span class="st">'review_score'</span>, axis<span class="op">=</span><span class="dv">1</span>), df_reg_dummy], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-326"><a href="#cb38-326"></a></span>
<span id="cb38-327"><a href="#cb38-327"></a><span class="co"># imputacao do restante das variaveis numericas quem nao tem categoria definida</span></span>
<span id="cb38-328"><a href="#cb38-328"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb38-329"><a href="#cb38-329"></a>inpute <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">'mean'</span>)</span>
<span id="cb38-330"><a href="#cb38-330"></a>df_reg.loc[:, [<span class="st">'product_name_lenght'</span>, <span class="st">'product_description_lenght'</span>,<span class="st">'product_photos_qty'</span>]] <span class="op">=</span> inpute.fit_transform(df_reg[[<span class="st">'product_name_lenght'</span>, <span class="st">'product_description_lenght'</span>,<span class="st">'product_photos_qty'</span>]])</span>
<span id="cb38-331"><a href="#cb38-331"></a></span>
<span id="cb38-332"><a href="#cb38-332"></a>df_class <span class="op">=</span> df_reg.dropna() <span class="co"># antes era df_prod</span></span>
<span id="cb38-333"><a href="#cb38-333"></a>df_faltante <span class="op">=</span> df_reg[df_reg.isnull().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb38-334"><a href="#cb38-334"></a></span>
<span id="cb38-335"><a href="#cb38-335"></a><span class="co"># Corrigindo o agrupamento e ordenação</span></span>
<span id="cb38-336"><a href="#cb38-336"></a>df_faltante <span class="op">=</span> (</span>
<span id="cb38-337"><a href="#cb38-337"></a>    df_faltante.groupby(<span class="st">'product_id'</span>).agg(</span>
<span id="cb38-338"><a href="#cb38-338"></a>        product_name_lenght<span class="op">=</span>(<span class="st">"product_name_lenght"</span>, <span class="st">"mean"</span>),  </span>
<span id="cb38-339"><a href="#cb38-339"></a>        product_description_lenght<span class="op">=</span>(<span class="st">"product_description_lenght"</span>, <span class="st">"mean"</span>),          </span>
<span id="cb38-340"><a href="#cb38-340"></a>        product_photos_qty<span class="op">=</span>(<span class="st">"product_photos_qty"</span>, <span class="st">"mean"</span>),          </span>
<span id="cb38-341"><a href="#cb38-341"></a>        product_weight_g<span class="op">=</span>(<span class="st">"product_weight_g"</span>, <span class="st">"mean"</span>),</span>
<span id="cb38-342"><a href="#cb38-342"></a>        product_length_cm<span class="op">=</span>(<span class="st">"product_length_cm"</span>, <span class="st">"mean"</span>),</span>
<span id="cb38-343"><a href="#cb38-343"></a>        product_height_cm<span class="op">=</span>(<span class="st">"product_height_cm"</span>, <span class="st">"mean"</span>),</span>
<span id="cb38-344"><a href="#cb38-344"></a>        product_width_cm<span class="op">=</span>(<span class="st">"product_width_cm"</span>, <span class="st">"mean"</span>),</span>
<span id="cb38-345"><a href="#cb38-345"></a>        log_price<span class="op">=</span>(<span class="st">"log_price"</span>, <span class="st">"mean"</span>),</span>
<span id="cb38-346"><a href="#cb38-346"></a>        log_frete<span class="op">=</span>(<span class="st">"log_frete"</span>, <span class="st">"mean"</span>),</span>
<span id="cb38-347"><a href="#cb38-347"></a>        len_titulo<span class="op">=</span>(<span class="st">"len_titulo"</span>, <span class="st">"mean"</span>),</span>
<span id="cb38-348"><a href="#cb38-348"></a>        len_comentario<span class="op">=</span>(<span class="st">"len_comentario"</span>, <span class="st">"mean"</span>),</span>
<span id="cb38-349"><a href="#cb38-349"></a>        comentario_exc<span class="op">=</span>(<span class="st">"comentario_exc"</span>, <span class="st">"max"</span>),</span>
<span id="cb38-350"><a href="#cb38-350"></a>        colocou_titulo<span class="op">=</span>(<span class="st">"colocou_titulo"</span>, <span class="st">"max"</span>),  <span class="co"># Binária: max captura se há algum 1</span></span>
<span id="cb38-351"><a href="#cb38-351"></a>        colocou_exc<span class="op">=</span>(<span class="st">"colocou_exc"</span>, <span class="st">"max"</span>),</span>
<span id="cb38-352"><a href="#cb38-352"></a>        nota1<span class="op">=</span>(<span class="st">"nota1"</span>, <span class="st">"max"</span>),  <span class="co"># Assumindo que as notas sejam binárias ou escalares</span></span>
<span id="cb38-353"><a href="#cb38-353"></a>        nota2<span class="op">=</span>(<span class="st">"nota2"</span>, <span class="st">"max"</span>),</span>
<span id="cb38-354"><a href="#cb38-354"></a>        nota3<span class="op">=</span>(<span class="st">"nota3"</span>, <span class="st">"max"</span>),</span>
<span id="cb38-355"><a href="#cb38-355"></a>        nota4<span class="op">=</span>(<span class="st">"nota4"</span>, <span class="st">"max"</span>),</span>
<span id="cb38-356"><a href="#cb38-356"></a>        nota5<span class="op">=</span>(<span class="st">"nota5"</span>, <span class="st">"max"</span>)</span>
<span id="cb38-357"><a href="#cb38-357"></a>    ).reset_index()  <span class="co"># Garante que 'product_id' volte como coluna</span></span>
<span id="cb38-358"><a href="#cb38-358"></a>)</span>
<span id="cb38-359"><a href="#cb38-359"></a><span class="in">```</span></span>
<span id="cb38-360"><a href="#cb38-360"></a><span class="ss">- </span>Foi usado imputação de dados em alguns momentos para não perder informação</span>
<span id="cb38-361"><a href="#cb38-361"></a></span>
<span id="cb38-364"><a href="#cb38-364"></a><span class="in">```{python}</span></span>
<span id="cb38-365"><a href="#cb38-365"></a><span class="co"># - imputacao categorica</span></span>
<span id="cb38-366"><a href="#cb38-366"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb38-367"><a href="#cb38-367"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb38-368"><a href="#cb38-368"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb38-369"><a href="#cb38-369"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split </span>
<span id="cb38-370"><a href="#cb38-370"></a><span class="im">from</span> sklearn <span class="im">import</span> metrics </span>
<span id="cb38-371"><a href="#cb38-371"></a></span>
<span id="cb38-372"><a href="#cb38-372"></a><span class="co"># Processo de Classificacao Dummy </span></span>
<span id="cb38-373"><a href="#cb38-373"></a>codigos <span class="op">=</span> pd.factorize(df_class.categorias_novas_produtos) <span class="co"># atribui indices as classes</span></span>
<span id="cb38-374"><a href="#cb38-374"></a>df_class[<span class="st">'numero_categorias_novas_produtos'</span>] <span class="op">=</span> codigos[<span class="dv">0</span>]</span>
<span id="cb38-375"><a href="#cb38-375"></a>categorias <span class="op">=</span> codigos[<span class="dv">1</span>]</span>
<span id="cb38-376"><a href="#cb38-376"></a></span>
<span id="cb38-377"><a href="#cb38-377"></a>y <span class="op">=</span> df_class[<span class="st">'numero_categorias_novas_produtos'</span>]</span>
<span id="cb38-378"><a href="#cb38-378"></a>x <span class="op">=</span> df_class.drop([<span class="st">'numero_categorias_novas_produtos'</span>,<span class="st">'categorias_novas_produtos'</span>,<span class="st">'product_id'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-379"><a href="#cb38-379"></a></span>
<span id="cb38-380"><a href="#cb38-380"></a>x_treino, x_teste, y_treino, y_teste <span class="op">=</span> train_test_split(x, y, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-381"><a href="#cb38-381"></a></span>
<span id="cb38-382"><a href="#cb38-382"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb38-383"><a href="#cb38-383"></a>x_treino <span class="op">=</span> scaler.fit_transform(x_treino)</span>
<span id="cb38-384"><a href="#cb38-384"></a>x_teste <span class="op">=</span> scaler.transform(x_teste)</span>
<span id="cb38-385"><a href="#cb38-385"></a></span>
<span id="cb38-386"><a href="#cb38-386"></a>classificador_arvoredecisao <span class="op">=</span> RandomForestClassifier(n_estimators <span class="op">=</span> <span class="dv">10</span>, criterion <span class="op">=</span> <span class="st">'entropy'</span>, random_state <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb38-387"><a href="#cb38-387"></a>classificador_arvoredecisao.fit(x_treino, y_treino)</span>
<span id="cb38-388"><a href="#cb38-388"></a></span>
<span id="cb38-389"><a href="#cb38-389"></a>y_pred <span class="op">=</span> classificador_arvoredecisao.predict(x_teste)</span>
<span id="cb38-390"><a href="#cb38-390"></a>categoria_nominal_prevista <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(<span class="bu">range</span>(<span class="bu">len</span>(categorias)<span class="op">+</span><span class="dv">1</span>),categorias))</span>
<span id="cb38-391"><a href="#cb38-391"></a></span>
<span id="cb38-392"><a href="#cb38-392"></a><span class="co"># Matriz de confusao</span></span>
<span id="cb38-393"><a href="#cb38-393"></a>y_teste_resposta <span class="op">=</span> np.vectorize(categoria_nominal_prevista.get)(y_teste)</span>
<span id="cb38-394"><a href="#cb38-394"></a>y_pred <span class="op">=</span> np.vectorize(categoria_nominal_prevista.get)(y_pred)</span>
<span id="cb38-395"><a href="#cb38-395"></a>matriz <span class="op">=</span> pd.crosstab(y_teste_resposta, y_pred, rownames<span class="op">=</span>[<span class="st">'Real'</span>], colnames<span class="op">=</span>[<span class="st">'Predito'</span>])</span>
<span id="cb38-396"><a href="#cb38-396"></a>acuracia <span class="op">=</span> np.trace(matriz) <span class="op">/</span> np.<span class="bu">sum</span>(matriz.values)</span>
<span id="cb38-397"><a href="#cb38-397"></a></span>
<span id="cb38-398"><a href="#cb38-398"></a><span class="co"># Substituicao</span></span>
<span id="cb38-399"><a href="#cb38-399"></a>new_x <span class="op">=</span> df_faltante.drop(<span class="st">'product_id'</span>, axis<span class="op">=</span><span class="dv">1</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb38-400"><a href="#cb38-400"></a>new_y_pred <span class="op">=</span> classificador_arvoredecisao.predict(</span>
<span id="cb38-401"><a href="#cb38-401"></a>  scaler.fit_transform(new_x)</span>
<span id="cb38-402"><a href="#cb38-402"></a>)</span>
<span id="cb38-403"><a href="#cb38-403"></a></span>
<span id="cb38-404"><a href="#cb38-404"></a>df_faltante[<span class="st">'categorias_novas_produtos'</span>] <span class="op">=</span> np.vectorize(categoria_nominal_prevista.get)(new_y_pred)</span>
<span id="cb38-405"><a href="#cb38-405"></a></span>
<span id="cb38-406"><a href="#cb38-406"></a>df_prod_final <span class="op">=</span> pd.concat(</span>
<span id="cb38-407"><a href="#cb38-407"></a>    [df_prod[df_prod.isnull().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>].drop(<span class="st">'product_category_name'</span>,axis<span class="op">=</span><span class="dv">1</span>), </span>
<span id="cb38-408"><a href="#cb38-408"></a>     df_faltante[df_prod.drop(<span class="st">'product_category_name'</span>,axis<span class="op">=</span><span class="dv">1</span>).columns]],  <span class="co"># Dado nulo estimado</span></span>
<span id="cb38-409"><a href="#cb38-409"></a>    ignore_index<span class="op">=</span><span class="va">True</span>  </span>
<span id="cb38-410"><a href="#cb38-410"></a>)</span>
<span id="cb38-411"><a href="#cb38-411"></a></span>
<span id="cb38-412"><a href="#cb38-412"></a>df_prod_final[<span class="st">'volume_prod'</span>] <span class="op">=</span> (</span>
<span id="cb38-413"><a href="#cb38-413"></a>    df_prod_final.product_length_cm.fillna(<span class="dv">0</span>) <span class="op">*</span> </span>
<span id="cb38-414"><a href="#cb38-414"></a>    df_prod_final.product_height_cm.fillna(<span class="dv">0</span>) <span class="op">*</span> </span>
<span id="cb38-415"><a href="#cb38-415"></a>    df_prod_final.product_width_cm.fillna(<span class="dv">0</span>)</span>
<span id="cb38-416"><a href="#cb38-416"></a>)</span>
<span id="cb38-417"><a href="#cb38-417"></a></span>
<span id="cb38-418"><a href="#cb38-418"></a></span>
<span id="cb38-419"><a href="#cb38-419"></a>df_compra <span class="op">=</span> df_items.merge(df_prod_final, on<span class="op">=</span><span class="st">"product_id"</span>).drop(</span>
<span id="cb38-420"><a href="#cb38-420"></a>  [<span class="st">'product_id'</span>,<span class="st">'seller_id'</span>,<span class="st">'shipping_limit_date'</span>,<span class="st">'price'</span>,<span class="st">'freight_value'</span>],axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-421"><a href="#cb38-421"></a>  </span>
<span id="cb38-422"><a href="#cb38-422"></a>df_dummy_compra <span class="op">=</span> pd.get_dummies(df_compra.categorias_novas_produtos, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb38-423"><a href="#cb38-423"></a>df_compra_final <span class="op">=</span> pd.concat([df_compra, df_dummy_compra], axis<span class="op">=</span><span class="dv">1</span>).drop(<span class="st">'categorias_novas_produtos'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-424"><a href="#cb38-424"></a></span>
<span id="cb38-425"><a href="#cb38-425"></a></span>
<span id="cb38-426"><a href="#cb38-426"></a><span class="co">## compras e ordens</span></span>
<span id="cb38-427"><a href="#cb38-427"></a>df_compra_ordem <span class="op">=</span> df_compra.merge(df_ordem_compra_fim, on <span class="op">=</span> <span class="st">'order_id'</span>)</span>
<span id="cb38-428"><a href="#cb38-428"></a></span>
<span id="cb38-429"><a href="#cb38-429"></a><span class="co"># Valores auxiliares</span></span>
<span id="cb38-430"><a href="#cb38-430"></a>n_categoria_final <span class="op">=</span> <span class="bu">len</span>(df_prod_final.categorias_novas_produtos.unique())</span>
<span id="cb38-431"><a href="#cb38-431"></a>n_categoria_final_nula <span class="op">=</span> df_prod_final.categorias_novas_produtos.isnull().<span class="bu">sum</span>() <span class="co"># auxiliar tabela</span></span>
<span id="cb38-432"><a href="#cb38-432"></a><span class="co"># tabela auxiliar</span></span>
<span id="cb38-433"><a href="#cb38-433"></a>tab_freq_cat_dp <span class="op">=</span> (df_prod_final.groupby(<span class="st">'categorias_novas_produtos'</span>).size()</span>
<span id="cb38-434"><a href="#cb38-434"></a>    .sort_values(ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>).reset_index())</span>
<span id="cb38-435"><a href="#cb38-435"></a>tab_freq_cat_dp.columns <span class="op">=</span> [<span class="st">'categorias'</span>, <span class="st">'Depois'</span>]</span>
<span id="cb38-436"><a href="#cb38-436"></a><span class="in">```</span></span>
<span id="cb38-437"><a href="#cb38-437"></a></span>
<span id="cb38-438"><a href="#cb38-438"></a>|Descrição |Antes | Depois |</span>
<span id="cb38-439"><a href="#cb38-439"></a>|----------|------|--------|</span>
<span id="cb38-440"><a href="#cb38-440"></a>| Categorias de produtos|<span class="in">`{python} n_categoria_incial`</span> |<span class="in">`{python} n_categoria_final`</span> |</span>
<span id="cb38-441"><a href="#cb38-441"></a>| Categorias de produtos nulas|<span class="in">`{python} n_categoria_incial_nula`</span> |<span class="in">`{python} n_categoria_final_nula`</span> </span>
<span id="cb38-442"><a href="#cb38-442"></a></span>
<span id="cb38-443"><a href="#cb38-443"></a><span class="at">&gt; Resumo do que foi usado aqui para prever as classes:</span></span>
<span id="cb38-444"><a href="#cb38-444"></a></span>
<span id="cb38-445"><a href="#cb38-445"></a><span class="ss">- </span>Método: Floresta Aleatória para classificação</span>
<span id="cb38-446"><a href="#cb38-446"></a><span class="ss">- </span>Acurácia: <span class="in">`{ round(acuracia*100, 2) }`</span>%</span>
<span id="cb38-447"><a href="#cb38-447"></a><span class="ss">- </span>Ideia aqui foi usar os dados de avaliação dos produtos para ajudar a melhorar a categorização de qual categoria pertenceria o valores de dimensão do produto (peso, altura, comprimento...)</span>
<span id="cb38-448"><a href="#cb38-448"></a><span class="ss">- </span>Para os dados numéricos que faltavam de informações do anúncio do produto (tamanho do título, quantidade de fotos e tamanho da descrição), usou-se a média. Esses dados entraram na Árvore </span>
<span id="cb38-449"><a href="#cb38-449"></a></span>
<span id="cb38-452"><a href="#cb38-452"></a><span class="in">```{python}</span></span>
<span id="cb38-453"><a href="#cb38-453"></a><span class="co"># União final - quase modelo</span></span>
<span id="cb38-454"><a href="#cb38-454"></a>df <span class="op">=</span> df_ordem_compra_fim.merge(df_compra_final, on<span class="op">=</span><span class="st">"order_id"</span>).drop(</span>
<span id="cb38-455"><a href="#cb38-455"></a>  [<span class="st">'review_comment_title'</span>, <span class="st">'review_comment_message'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-456"><a href="#cb38-456"></a></span>
<span id="cb38-457"><a href="#cb38-457"></a></span>
<span id="cb38-458"><a href="#cb38-458"></a>colunas_finais <span class="op">=</span> [<span class="st">'order_id'</span>, <span class="st">'boleto'</span>, <span class="st">'credit_card'</span>, <span class="st">'debit_card'</span>, <span class="st">'voucher'</span>,</span>
<span id="cb38-459"><a href="#cb38-459"></a>       <span class="st">'soma_tipos_pagamentos'</span>, <span class="st">'log_valor_pago'</span>, <span class="st">'pago_a_vista'</span>,</span>
<span id="cb38-460"><a href="#cb38-460"></a>       <span class="st">'log_valor_medio_parcela'</span>, <span class="st">'customer_id'</span>,</span>
<span id="cb38-461"><a href="#cb38-461"></a>       <span class="st">'order_purchase_timestamp'</span>, </span>
<span id="cb38-462"><a href="#cb38-462"></a>       <span class="st">'dia_pedido'</span>, <span class="st">'tempo_conf_pedido'</span>,</span>
<span id="cb38-463"><a href="#cb38-463"></a>       <span class="st">'atraso_prev_entrega'</span>, <span class="st">'review_score'</span>,</span>
<span id="cb38-464"><a href="#cb38-464"></a>       <span class="st">'review_creation_date'</span>, <span class="st">'len_titulo'</span>,</span>
<span id="cb38-465"><a href="#cb38-465"></a>       <span class="st">'len_comentario'</span>, <span class="st">'comentario_exc'</span>, <span class="st">'colocou_titulo'</span>, <span class="st">'colocou_exc'</span>,</span>
<span id="cb38-466"><a href="#cb38-466"></a>       <span class="st">'customer_unique_id'</span>, <span class="st">'customer_city'</span>,</span>
<span id="cb38-467"><a href="#cb38-467"></a>       <span class="st">'customer_state'</span>, <span class="st">'regiao_cliente'</span>, <span class="st">'data_prim_compra'</span>,</span>
<span id="cb38-468"><a href="#cb38-468"></a>       <span class="st">'data_ultima_compra'</span>, <span class="st">'primeira_compra_cliente'</span>,</span>
<span id="cb38-469"><a href="#cb38-469"></a>       <span class="st">'primeira_ordem_por_cliente'</span>, <span class="st">'log_price'</span>, <span class="st">'log_frete'</span>,</span>
<span id="cb38-470"><a href="#cb38-470"></a>       <span class="st">'product_name_lenght'</span>, <span class="st">'product_description_lenght'</span>,</span>
<span id="cb38-471"><a href="#cb38-471"></a>       <span class="st">'product_photos_qty'</span>, <span class="st">'product_weight_g'</span>, <span class="st">'product_length_cm'</span>,</span>
<span id="cb38-472"><a href="#cb38-472"></a>       <span class="st">'product_height_cm'</span>, <span class="st">'product_width_cm'</span>, <span class="st">'volume_prod'</span>, <span class="st">'ALIMENTO'</span>,</span>
<span id="cb38-473"><a href="#cb38-473"></a>       <span class="st">'ARTESANATO_LEGAL'</span>, <span class="st">'AUTOMOTIVO'</span>, <span class="st">'BEBES'</span>, <span class="st">'BELEZA_SAUDE'</span>, <span class="st">'BRINQUEDOS'</span>,</span>
<span id="cb38-474"><a href="#cb38-474"></a>       <span class="st">'CASA'</span>, <span class="st">'CONSTRUCAO_FERRAMENTAS'</span>, <span class="st">'ELETRODOMESTICOS'</span>, <span class="st">'ESPORTE_LAZER'</span>,</span>
<span id="cb38-475"><a href="#cb38-475"></a>       <span class="st">'EVENTO'</span>, <span class="st">'FASHION'</span>, <span class="st">'INDUSTRIA'</span>, <span class="st">'INFORMATICA_ACESSORIOS'</span>,</span>
<span id="cb38-476"><a href="#cb38-476"></a>       <span class="st">'MALAS_ACESSORIOS'</span>, <span class="st">'MARKET_PLACE'</span>, <span class="st">'MIDIA_MUSICA'</span>, <span class="st">'MOVEIS'</span>,</span>
<span id="cb38-477"><a href="#cb38-477"></a>       <span class="st">'PAPELARIA'</span>, <span class="st">'PC'</span>, <span class="st">'PERFUMARIA'</span>, <span class="st">'PET_SHOP'</span>, <span class="st">'PORTATEIS'</span>,</span>
<span id="cb38-478"><a href="#cb38-478"></a>       <span class="st">'RELOGIOS_PRESENTES'</span>, <span class="st">'SEGURANCA'</span>, <span class="st">'TELEFONIA'</span>]</span>
<span id="cb38-479"><a href="#cb38-479"></a></span>
<span id="cb38-480"><a href="#cb38-480"></a>df_final <span class="op">=</span> df[colunas_finais]</span>
<span id="cb38-481"><a href="#cb38-481"></a><span class="in">```</span></span>
<span id="cb38-482"><a href="#cb38-482"></a></span>
<span id="cb38-483"><a href="#cb38-483"></a><span class="fu">## Resumo dados nulos</span></span>
<span id="cb38-484"><a href="#cb38-484"></a></span>
<span id="cb38-487"><a href="#cb38-487"></a><span class="in">```{python}</span></span>
<span id="cb38-488"><a href="#cb38-488"></a>df_nulo_fim <span class="op">=</span> pd.DataFrame(</span>
<span id="cb38-489"><a href="#cb38-489"></a>  df_final.isnull().<span class="bu">sum</span>()[df_final.isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb38-490"><a href="#cb38-490"></a>  )</span>
<span id="cb38-491"><a href="#cb38-491"></a>df_nulo_fim.columns <span class="op">=</span> [<span class="st">'nome_coluna_quantidade_nula'</span>]</span>
<span id="cb38-492"><a href="#cb38-492"></a><span class="in">```</span></span>
<span id="cb38-493"><a href="#cb38-493"></a></span>
<span id="cb38-494"><a href="#cb38-494"></a></span>
<span id="cb38-495"><a href="#cb38-495"></a></span>
<span id="cb38-498"><a href="#cb38-498"></a><span class="in">```{r}</span></span>
<span id="cb38-499"><a href="#cb38-499"></a><span class="co"># data = py$tab_freq_cat_final</span></span>
<span id="cb38-500"><a href="#cb38-500"></a><span class="co"># </span></span>
<span id="cb38-501"><a href="#cb38-501"></a><span class="co"># ggplot(data = data) +</span></span>
<span id="cb38-502"><a href="#cb38-502"></a><span class="co">#   geom_histogram(aes(x = n, fill = categorias)) + </span></span>
<span id="cb38-503"><a href="#cb38-503"></a><span class="co">#   facet_wrap(~ tipo)</span></span>
<span id="cb38-504"><a href="#cb38-504"></a><span class="in">```</span></span>
<span id="cb38-505"><a href="#cb38-505"></a></span>
<span id="cb38-506"><a href="#cb38-506"></a></span>
<span id="cb38-507"><a href="#cb38-507"></a></span>
<span id="cb38-508"><a href="#cb38-508"></a><span class="fu"># Descritiva</span></span>
<span id="cb38-509"><a href="#cb38-509"></a></span>
<span id="cb38-512"><a href="#cb38-512"></a><span class="in">```{python}</span></span>
<span id="cb38-513"><a href="#cb38-513"></a>pd.DataFrame(df_final.describe().<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb38-514"><a href="#cb38-514"></a></span>
<span id="cb38-515"><a href="#cb38-515"></a><span class="in">```</span></span>
<span id="cb38-516"><a href="#cb38-516"></a></span>
<span id="cb38-517"><a href="#cb38-517"></a><span class="at">&gt; Pagamento do cliente:</span></span>
<span id="cb38-518"><a href="#cb38-518"></a></span>
<span id="cb38-521"><a href="#cb38-521"></a><span class="in">```{r}</span></span>
<span id="cb38-522"><a href="#cb38-522"></a><span class="co"># | fig-cap: "Número de Transações e Log do Valor Pago por Tipo de Pagamento"</span></span>
<span id="cb38-523"><a href="#cb38-523"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_tipo_pagamento</span>
<span id="cb38-524"><a href="#cb38-524"></a></span>
<span id="cb38-525"><a href="#cb38-525"></a>data<span class="sc">$</span>payment_type <span class="ot">&lt;-</span> <span class="fu">reorder</span>(data<span class="sc">$</span>payment_type, <span class="sc">-</span>data<span class="sc">$</span>n)</span>
<span id="cb38-526"><a href="#cb38-526"></a></span>
<span id="cb38-527"><a href="#cb38-527"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> payment_type)) <span class="sc">+</span></span>
<span id="cb38-528"><a href="#cb38-528"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">y =</span> n<span class="sc">/</span><span class="dv">1000</span>, <span class="at">fill =</span> payment_type), <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb38-529"><a href="#cb38-529"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_valor_pago, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb38-530"><a href="#cb38-530"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_valor_pago), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span>  </span>
<span id="cb38-531"><a href="#cb38-531"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">"Número de pagamentos (em milhares)"</span>, <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span>.<span class="sc">/</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">"Log do Valor Pago"</span>)) <span class="sc">+</span> </span>
<span id="cb38-532"><a href="#cb38-532"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Tipo de Pagamento"</span>) <span class="sc">+</span></span>
<span id="cb38-533"><a href="#cb38-533"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb38-534"><a href="#cb38-534"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb38-535"><a href="#cb38-535"></a><span class="in">```</span></span>
<span id="cb38-536"><a href="#cb38-536"></a></span>
<span id="cb38-537"><a href="#cb38-537"></a></span>
<span id="cb38-540"><a href="#cb38-540"></a><span class="in">```{r}</span></span>
<span id="cb38-541"><a href="#cb38-541"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_registro</span>
<span id="cb38-542"><a href="#cb38-542"></a><span class="fu">ggplot</span>(<span class="at">data=</span> data) <span class="sc">+</span> </span>
<span id="cb38-543"><a href="#cb38-543"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_valor_medio_parcela, <span class="at">fill =</span> <span class="fu">as.factor</span>(pago_a_vista))) <span class="sc">+</span></span>
<span id="cb38-544"><a href="#cb38-544"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">'log da parcela mensal'</span>, <span class="at">fill =</span> <span class="st">'Pagamento a vista'</span>) <span class="sc">+</span> </span>
<span id="cb38-545"><a href="#cb38-545"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb38-546"><a href="#cb38-546"></a></span>
<span id="cb38-547"><a href="#cb38-547"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_final</span>
<span id="cb38-548"><a href="#cb38-548"></a><span class="fu">ggplot</span>(<span class="at">data=</span>data)<span class="sc">+</span></span>
<span id="cb38-549"><a href="#cb38-549"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> soma_tipos_pagamentos)) <span class="sc">+</span> </span>
<span id="cb38-550"><a href="#cb38-550"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>primeira_compra_cliente)</span>
<span id="cb38-551"><a href="#cb38-551"></a><span class="in">```</span></span>
<span id="cb38-552"><a href="#cb38-552"></a></span>
<span id="cb38-553"><a href="#cb38-553"></a><span class="ss">* </span>Aqui parece haver uma possível mudança de comportamento do preço de compra entre a primeira e a segunda compra</span>
<span id="cb38-554"><a href="#cb38-554"></a></span>
<span id="cb38-557"><a href="#cb38-557"></a><span class="in">```{r}</span></span>
<span id="cb38-558"><a href="#cb38-558"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_compra_ordem</span>
<span id="cb38-559"><a href="#cb38-559"></a></span>
<span id="cb38-560"><a href="#cb38-560"></a><span class="fu">ggplot</span>(<span class="at">data=</span> data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="sc">-</span>log_price))<span class="sc">+</span></span>
<span id="cb38-561"><a href="#cb38-561"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_price, <span class="at">x =</span> categorias_novas_produtos)) <span class="sc">+</span></span>
<span id="cb38-562"><a href="#cb38-562"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">mean</span>(data<span class="sc">$</span>log_price), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb38-563"><a href="#cb38-563"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>primeira_compra_cliente) <span class="sc">+</span> </span>
<span id="cb38-564"><a href="#cb38-564"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb38-565"><a href="#cb38-565"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb38-566"><a href="#cb38-566"></a><span class="in">```</span></span>
<span id="cb38-567"><a href="#cb38-567"></a></span>
<span id="cb38-570"><a href="#cb38-570"></a><span class="in">```{r}</span></span>
<span id="cb38-571"><a href="#cb38-571"></a>interpreta_ANOVA <span class="ot">&lt;-</span> <span class="cf">function</span>(mod, <span class="at">alpha =</span> <span class="fl">0.05</span>){</span>
<span id="cb38-572"><a href="#cb38-572"></a>  <span class="fu">library</span>(flextable)</span>
<span id="cb38-573"><a href="#cb38-573"></a>  <span class="co"># Realiza a análise de variância e converte para tibble</span></span>
<span id="cb38-574"><a href="#cb38-574"></a>  tab <span class="ot">&lt;-</span> mod <span class="sc">%&gt;%</span> <span class="fu">anova</span>()</span>
<span id="cb38-575"><a href="#cb38-575"></a>  tabela <span class="ot">&lt;-</span> tab <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">3</span>)</span>
<span id="cb38-576"><a href="#cb38-576"></a>  </span>
<span id="cb38-577"><a href="#cb38-577"></a>  <span class="co"># Prepara a tabela</span></span>
<span id="cb38-578"><a href="#cb38-578"></a>  tabela <span class="ot">&lt;-</span> tabela <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb38-579"><a href="#cb38-579"></a>    <span class="st">`</span><span class="at">Covariável</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">row.names</span>(tab) <span class="sc">%&gt;%</span> </span>
<span id="cb38-580"><a href="#cb38-580"></a>      <span class="fu">str_replace_all</span>(<span class="st">"(?&lt;=[a-z])(?=[A-Z0-9])"</span>, <span class="st">" "</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-581"><a href="#cb38-581"></a>      <span class="fu">str_to_title</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb38-582"><a href="#cb38-582"></a>      <span class="fu">str_replace_all</span>(<span class="st">":"</span>, <span class="st">" : "</span>),</span>
<span id="cb38-583"><a href="#cb38-583"></a>    <span class="at">sig =</span> <span class="fu">case_when</span>(</span>
<span id="cb38-584"><a href="#cb38-584"></a>      <span class="fu">is.na</span>(<span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>) <span class="sc">~</span> <span class="st">" "</span>,</span>
<span id="cb38-585"><a href="#cb38-585"></a>      <span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.001</span> <span class="sc">~</span> <span class="st">"&lt;0.001*"</span>,</span>
<span id="cb38-586"><a href="#cb38-586"></a>      <span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span> <span class="sc">&lt;=</span> alpha <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"*"</span>),</span>
<span id="cb38-587"><a href="#cb38-587"></a>      <span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span> <span class="sc">&lt;=</span> (alpha <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"."</span>),</span>
<span id="cb38-588"><a href="#cb38-588"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>))</span>
<span id="cb38-589"><a href="#cb38-589"></a>    )</span>
<span id="cb38-590"><a href="#cb38-590"></a>  )</span>
<span id="cb38-591"><a href="#cb38-591"></a>  </span>
<span id="cb38-592"><a href="#cb38-592"></a>  tabela <span class="ot">&lt;-</span> tabela <span class="sc">%&gt;%</span></span>
<span id="cb38-593"><a href="#cb38-593"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="st">`</span><span class="at">Covariável</span><span class="st">`</span>, Df, <span class="st">`</span><span class="at">Sum Sq</span><span class="st">`</span>, <span class="st">`</span><span class="at">Mean Sq</span><span class="st">`</span>, <span class="st">`</span><span class="at">F value</span><span class="st">`</span>, sig) <span class="sc">%&gt;%</span></span>
<span id="cb38-594"><a href="#cb38-594"></a>    <span class="fu">rename</span>(</span>
<span id="cb38-595"><a href="#cb38-595"></a>      <span class="st">`</span><span class="at">gl</span><span class="st">`</span> <span class="ot">=</span> Df, <span class="at">SQ =</span> <span class="st">`</span><span class="at">Sum Sq</span><span class="st">`</span>, <span class="at">MQ =</span> <span class="st">`</span><span class="at">Mean Sq</span><span class="st">`</span>,</span>
<span id="cb38-596"><a href="#cb38-596"></a>      <span class="st">"F"</span> <span class="ot">=</span> <span class="st">`</span><span class="at">F value</span><span class="st">`</span>, <span class="st">"Pvalor"</span> <span class="ot">=</span> sig</span>
<span id="cb38-597"><a href="#cb38-597"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb38-598"><a href="#cb38-598"></a>    <span class="fu">mutate_all</span>(<span class="sc">~</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(.), <span class="st">""</span>, .)) <span class="co"># Tirando NA da saída</span></span>
<span id="cb38-599"><a href="#cb38-599"></a>  </span>
<span id="cb38-600"><a href="#cb38-600"></a>  <span class="co"># Criar um objeto flextable</span></span>
<span id="cb38-601"><a href="#cb38-601"></a>  ft <span class="ot">&lt;-</span> <span class="fu">flextable</span>(tabela)</span>
<span id="cb38-602"><a href="#cb38-602"></a>  </span>
<span id="cb38-603"><a href="#cb38-603"></a>  <span class="co"># Adicionar estilo</span></span>
<span id="cb38-604"><a href="#cb38-604"></a>  ft <span class="ot">&lt;-</span> <span class="fu">set_table_properties</span>(ft, <span class="at">layout =</span> <span class="st">"autofit"</span>)</span>
<span id="cb38-605"><a href="#cb38-605"></a></span>
<span id="cb38-606"><a href="#cb38-606"></a>  <span class="co"># Adicionar rodapé</span></span>
<span id="cb38-607"><a href="#cb38-607"></a>  ft <span class="ot">&lt;-</span> <span class="fu">add_footer_lines</span>(ft, <span class="at">values =</span> <span class="fu">paste0</span>(<span class="st">"Significativo a "</span>, (alpha <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb38-608"><a href="#cb38-608"></a>                                              <span class="st">"% de significância e '.' significativo a "</span>, (<span class="dv">2</span> <span class="sc">*</span> alpha <span class="sc">*</span> <span class="dv">100</span>), <span class="st">"%"</span>))</span>
<span id="cb38-609"><a href="#cb38-609"></a></span>
<span id="cb38-610"><a href="#cb38-610"></a>  <span class="co"># Destacar cabeçalhos e a primeira coluna</span></span>
<span id="cb38-611"><a href="#cb38-611"></a>  ft <span class="ot">&lt;-</span> <span class="fu">bold</span>(ft, <span class="at">bold =</span> <span class="cn">TRUE</span>, <span class="at">part =</span> <span class="st">"header"</span>)</span>
<span id="cb38-612"><a href="#cb38-612"></a>  ft <span class="ot">&lt;-</span> <span class="fu">bold</span>(ft, <span class="at">bold =</span> <span class="cn">TRUE</span>, <span class="at">j =</span> <span class="dv">1</span>)</span>
<span id="cb38-613"><a href="#cb38-613"></a></span>
<span id="cb38-614"><a href="#cb38-614"></a>  <span class="fu">return</span>(ft)</span>
<span id="cb38-615"><a href="#cb38-615"></a>}</span>
<span id="cb38-616"><a href="#cb38-616"></a></span>
<span id="cb38-617"><a href="#cb38-617"></a>Arruma_CompMult <span class="ot">&lt;-</span> <span class="cf">function</span>(comparacao){</span>
<span id="cb38-618"><a href="#cb38-618"></a>  <span class="co"># Funcao para interacaoes de Tukey de ordem ate ^2</span></span>
<span id="cb38-619"><a href="#cb38-619"></a>  </span>
<span id="cb38-620"><a href="#cb38-620"></a>  AjeitaLista <span class="ot">&lt;-</span> <span class="cf">function</span>(lista, <span class="at">alpha =</span> <span class="fl">0.05</span>){</span>
<span id="cb38-621"><a href="#cb38-621"></a>    tabela <span class="ot">&lt;-</span> lista <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-622"><a href="#cb38-622"></a>      <span class="fu">mutate</span>(<span class="at">Comparacoes =</span> <span class="fu">rownames</span>(lista)) <span class="sc">%&gt;%</span> <span class="co"># nomes das comparacoes</span></span>
<span id="cb38-623"><a href="#cb38-623"></a>      <span class="co"># pegando apenas significativas</span></span>
<span id="cb38-624"><a href="#cb38-624"></a>      <span class="fu">filter</span>(<span class="st">`</span><span class="at">p adj</span><span class="st">`</span> <span class="sc">&lt;=</span> alpha<span class="sc">*</span><span class="dv">2</span>)</span>
<span id="cb38-625"><a href="#cb38-625"></a>    <span class="cf">if</span>(tabela <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">!=</span> <span class="dv">0</span>){</span>
<span id="cb38-626"><a href="#cb38-626"></a>      tabela <span class="ot">&lt;-</span> tabela <span class="sc">%&gt;%</span> </span>
<span id="cb38-627"><a href="#cb38-627"></a>        <span class="co"># reagrupa num novo formato</span></span>
<span id="cb38-628"><a href="#cb38-628"></a>        <span class="fu">separate</span>(Comparacoes, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"G1"</span>, <span class="st">"G2"</span>), <span class="at">sep =</span> <span class="st">"-"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-629"><a href="#cb38-629"></a>        <span class="fu">separate</span>(G1, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"G1.1"</span>, <span class="st">"G1.2"</span>), <span class="at">sep =</span> <span class="st">":"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-630"><a href="#cb38-630"></a>        <span class="fu">separate</span>(G2, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"G2.1"</span>, <span class="st">"G2.2"</span>), <span class="at">sep =</span> <span class="st">":"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-631"><a href="#cb38-631"></a>        <span class="fu">unite</span>(<span class="at">col =</span> Fator1, G1<span class="fl">.1</span>,G2<span class="fl">.1</span>, <span class="at">sep =</span> <span class="st">" - "</span>, <span class="at">remove =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb38-632"><a href="#cb38-632"></a>        <span class="fu">unite</span>(<span class="at">col =</span> Fator2, G1<span class="fl">.2</span>,G2<span class="fl">.2</span>, <span class="at">sep =</span> <span class="st">" : "</span>, <span class="at">remove =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb38-633"><a href="#cb38-633"></a>        <span class="co"># mudando forma de mostrar pvalor</span></span>
<span id="cb38-634"><a href="#cb38-634"></a>        <span class="fu">mutate</span>(<span class="at">Pvalor =</span> <span class="fu">case_when</span>(</span>
<span id="cb38-635"><a href="#cb38-635"></a>        <span class="st">`</span><span class="at">p adj</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.001</span> <span class="sc">~</span> <span class="st">"&lt;0.001*"</span>,</span>
<span id="cb38-636"><a href="#cb38-636"></a>        <span class="st">`</span><span class="at">p adj</span><span class="st">`</span> <span class="sc">&lt;=</span> alpha <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">p adj</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"*"</span>),</span>
<span id="cb38-637"><a href="#cb38-637"></a>        <span class="st">`</span><span class="at">p adj</span><span class="st">`</span> <span class="sc">&lt;=</span> (alpha<span class="sc">*</span><span class="dv">2</span>) <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">p adj</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"."</span>),</span>
<span id="cb38-638"><a href="#cb38-638"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">" "</span>, <span class="fu">format</span>(<span class="st">`</span><span class="at">p adj</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">3</span>))) <span class="co"># Caso padrão</span></span>
<span id="cb38-639"><a href="#cb38-639"></a>          )<span class="sc">%&gt;%</span></span>
<span id="cb38-640"><a href="#cb38-640"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(Fator1, Fator2, <span class="fu">everything</span>(), <span class="sc">-</span>lwr, <span class="sc">-</span>upr, <span class="sc">-</span><span class="st">`</span><span class="at">p adj</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-641"><a href="#cb38-641"></a>        <span class="fu">rename</span>(<span class="st">`</span><span class="at">Diferença</span><span class="st">`</span><span class="ot">=</span> diff)</span>
<span id="cb38-642"><a href="#cb38-642"></a>      </span>
<span id="cb38-643"><a href="#cb38-643"></a>        <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">"NA"</span>, tabela<span class="sc">$</span>Fator2) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() ){</span>
<span id="cb38-644"><a href="#cb38-644"></a>        <span class="fu">return</span>(tabela <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Fator2)) <span class="co">#caso nao tenha fator 2</span></span>
<span id="cb38-645"><a href="#cb38-645"></a>        }<span class="cf">else</span>{<span class="fu">return</span>(tabela)}</span>
<span id="cb38-646"><a href="#cb38-646"></a>    }</span>
<span id="cb38-647"><a href="#cb38-647"></a>    }</span>
<span id="cb38-648"><a href="#cb38-648"></a>  </span>
<span id="cb38-649"><a href="#cb38-649"></a>  <span class="fu">return</span>( <span class="fu">lapply</span>(comparacao, AjeitaLista) )</span>
<span id="cb38-650"><a href="#cb38-650"></a>}</span>
<span id="cb38-651"><a href="#cb38-651"></a></span>
<span id="cb38-652"><a href="#cb38-652"></a>CompMult_visual <span class="ot">&lt;-</span> <span class="cf">function</span>(CompMultArrumado, <span class="at">alpha=</span><span class="fl">0.05</span>){</span>
<span id="cb38-653"><a href="#cb38-653"></a>  <span class="fu">library</span>(kableExtra)</span>
<span id="cb38-654"><a href="#cb38-654"></a>  nome_objeto <span class="ot">&lt;-</span> <span class="fu">deparse</span>(<span class="fu">substitute</span>(CompMultArrumado))</span>
<span id="cb38-655"><a href="#cb38-655"></a>  nome_obj_split <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(<span class="fu">gsub</span>(<span class="st">"[`]"</span>, <span class="st">""</span>, nome_objeto), <span class="st">":"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb38-656"><a href="#cb38-656"></a>  fator2_nome <span class="ot">&lt;-</span> nome_obj_split[<span class="dv">2</span>] <span class="co">#quando for 1 fator, isso sera NA</span></span>
<span id="cb38-657"><a href="#cb38-657"></a>  posicao_cifrao <span class="ot">&lt;-</span> <span class="fu">str_locate</span>(nome_obj_split, <span class="st">"</span><span class="sc">\\</span><span class="st">$"</span>)[<span class="dv">1</span>]</span>
<span id="cb38-658"><a href="#cb38-658"></a>  fator1_nome <span class="ot">&lt;-</span> <span class="fu">str_sub</span>(nome_obj_split[<span class="dv">1</span>], posicao_cifrao <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb38-659"><a href="#cb38-659"></a>    </span>
<span id="cb38-660"><a href="#cb38-660"></a>  <span class="cf">if</span>(<span class="sc">!</span>CompMultArrumado <span class="sc">%&gt;%</span> <span class="fu">is.null</span>()){</span>
<span id="cb38-661"><a href="#cb38-661"></a>    tabela <span class="ot">&lt;-</span> CompMultArrumado <span class="sc">%&gt;%</span> </span>
<span id="cb38-662"><a href="#cb38-662"></a>      <span class="fu">arrange</span>(Fator1) <span class="sc">%&gt;%</span> </span>
<span id="cb38-663"><a href="#cb38-663"></a>      <span class="fu">kbl</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">booktabs =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb38-664"><a href="#cb38-664"></a>      <span class="co"># estilo</span></span>
<span id="cb38-665"><a href="#cb38-665"></a>      <span class="fu">row_spec</span>(<span class="dv">0</span>, <span class="at">bold =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb38-666"><a href="#cb38-666"></a>      <span class="fu">kable_classic_2</span>(<span class="at">full_width =</span> F, <span class="at">html_font =</span> <span class="st">"Arial"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-667"><a href="#cb38-667"></a>      <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"responsive"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-668"><a href="#cb38-668"></a>      <span class="fu">kable_paper</span>(<span class="at">full_width =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb38-669"><a href="#cb38-669"></a>      <span class="co"># agrupar linhas</span></span>
<span id="cb38-670"><a href="#cb38-670"></a>      <span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">"middle"</span>) <span class="co"># isso tira o formato tabela bonito igual da anova</span></span>
<span id="cb38-671"><a href="#cb38-671"></a>    </span>
<span id="cb38-672"><a href="#cb38-672"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(fator2_nome)){ <span class="co"># implica que so tem um fator no ajuste</span></span>
<span id="cb38-673"><a href="#cb38-673"></a>      tabela <span class="sc">%&gt;%</span> </span>
<span id="cb38-674"><a href="#cb38-674"></a>        <span class="fu">footnote</span>( <span class="co"># rodape</span></span>
<span id="cb38-675"><a href="#cb38-675"></a>      <span class="at">symbol =</span> <span class="fu">paste0</span>(<span class="st">"significativo a "</span>, (alpha<span class="sc">*</span><span class="dv">100</span>),</span>
<span id="cb38-676"><a href="#cb38-676"></a>                      <span class="st">"% de significância e '.' significativo a "</span>, (<span class="dv">2</span><span class="sc">*</span>alpha<span class="sc">*</span><span class="dv">100</span>),<span class="st">"%"</span>),</span>
<span id="cb38-677"><a href="#cb38-677"></a>      <span class="at">general =</span> <span class="fu">paste0</span>(<span class="st">"Fator1 refere a "</span>, fator1_nome),</span>
<span id="cb38-678"><a href="#cb38-678"></a>      <span class="at">general_title =</span> <span class="st">"Nota: "</span>,<span class="at">footnote_as_chunk =</span> T,</span>
<span id="cb38-679"><a href="#cb38-679"></a>      )</span>
<span id="cb38-680"><a href="#cb38-680"></a>    }<span class="cf">else</span>{ <span class="co"># implica ter mais de um fator no ajuste</span></span>
<span id="cb38-681"><a href="#cb38-681"></a>      tabela <span class="sc">%&gt;%</span> </span>
<span id="cb38-682"><a href="#cb38-682"></a>        <span class="fu">footnote</span>(<span class="co"># rodape</span></span>
<span id="cb38-683"><a href="#cb38-683"></a>        <span class="at">symbol =</span> <span class="fu">paste0</span>(<span class="st">"significativo a "</span>, (alpha<span class="sc">*</span><span class="dv">100</span>),</span>
<span id="cb38-684"><a href="#cb38-684"></a>                        <span class="st">"% de significância e '.' significativo a "</span>, (<span class="dv">2</span><span class="sc">*</span>alpha<span class="sc">*</span><span class="dv">100</span>),<span class="st">"%"</span>),</span>
<span id="cb38-685"><a href="#cb38-685"></a>        <span class="at">general =</span> <span class="fu">paste0</span>(<span class="st">"Fator1 refere a "</span>, fator1_nome, <span class="st">" e Fator2 a "</span>, fator2_nome),</span>
<span id="cb38-686"><a href="#cb38-686"></a>        <span class="at">general_title =</span> <span class="st">"Nota: "</span>,<span class="at">footnote_as_chunk =</span> T,</span>
<span id="cb38-687"><a href="#cb38-687"></a>        )</span>
<span id="cb38-688"><a href="#cb38-688"></a>      }</span>
<span id="cb38-689"><a href="#cb38-689"></a>  }</span>
<span id="cb38-690"><a href="#cb38-690"></a>}</span>
<span id="cb38-691"><a href="#cb38-691"></a><span class="in">```</span></span>
<span id="cb38-692"><a href="#cb38-692"></a></span>
<span id="cb38-693"><a href="#cb38-693"></a></span>
<span id="cb38-696"><a href="#cb38-696"></a><span class="in">```{r}</span></span>
<span id="cb38-697"><a href="#cb38-697"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_compra_ordem</span>
<span id="cb38-698"><a href="#cb38-698"></a>data <span class="ot">=</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb38-699"><a href="#cb38-699"></a>  <span class="at">review_score =</span> <span class="fu">as.factor</span>(review_score)</span>
<span id="cb38-700"><a href="#cb38-700"></a>)</span>
<span id="cb38-701"><a href="#cb38-701"></a></span>
<span id="cb38-702"><a href="#cb38-702"></a><span class="fu">ggplot</span>(<span class="at">data=</span> data)<span class="sc">+</span></span>
<span id="cb38-703"><a href="#cb38-703"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_price, <span class="at">x =</span> review_score, <span class="at">fill =</span> <span class="fu">as.factor</span>(primeira_compra_cliente)))</span>
<span id="cb38-704"><a href="#cb38-704"></a><span class="in">```</span></span>
<span id="cb38-705"><a href="#cb38-705"></a></span>
<span id="cb38-706"><a href="#cb38-706"></a></span>
<span id="cb38-707"><a href="#cb38-707"></a></span>
<span id="cb38-710"><a href="#cb38-710"></a><span class="in">```{r}</span></span>
<span id="cb38-711"><a href="#cb38-711"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_compra</span>
<span id="cb38-712"><a href="#cb38-712"></a></span>
<span id="cb38-713"><a href="#cb38-713"></a><span class="fu">ggplot</span>(<span class="at">data=</span> data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="sc">-</span>log_price))<span class="sc">+</span></span>
<span id="cb38-714"><a href="#cb38-714"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_price, <span class="at">x =</span> categorias_novas_produtos)) <span class="sc">+</span></span>
<span id="cb38-715"><a href="#cb38-715"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">mean</span>(data<span class="sc">$</span>log_price), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb38-716"><a href="#cb38-716"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb38-717"><a href="#cb38-717"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb38-718"><a href="#cb38-718"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">'Log-Preço'</span>, <span class="at">x =</span> <span class="st">'categoria'</span>)</span>
<span id="cb38-719"><a href="#cb38-719"></a><span class="in">```</span></span>
<span id="cb38-720"><a href="#cb38-720"></a></span>
<span id="cb38-721"><a href="#cb38-721"></a></span>
<span id="cb38-724"><a href="#cb38-724"></a><span class="in">```{python}</span></span>
<span id="cb38-725"><a href="#cb38-725"></a><span class="co"># | fig-cap: 'Proporção de pedidos por dia da semana'</span></span>
<span id="cb38-726"><a href="#cb38-726"></a>tab_perc_dia <span class="op">=</span> (</span>
<span id="cb38-727"><a href="#cb38-727"></a>    df_ordem_compra_fim</span>
<span id="cb38-728"><a href="#cb38-728"></a>    .groupby([<span class="st">"dia_pedido"</span>, <span class="st">"primeira_compra_cliente"</span>])</span>
<span id="cb38-729"><a href="#cb38-729"></a>    .size()</span>
<span id="cb38-730"><a href="#cb38-730"></a>    .reset_index(name<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb38-731"><a href="#cb38-731"></a>    .pivot(index<span class="op">=</span><span class="st">"dia_pedido"</span>, columns<span class="op">=</span><span class="st">"primeira_compra_cliente"</span>, values<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb38-732"><a href="#cb38-732"></a>    .fillna(<span class="dv">0</span>)</span>
<span id="cb38-733"><a href="#cb38-733"></a>    .reset_index()</span>
<span id="cb38-734"><a href="#cb38-734"></a>    .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-735"><a href="#cb38-735"></a>)</span>
<span id="cb38-736"><a href="#cb38-736"></a></span>
<span id="cb38-737"><a href="#cb38-737"></a>total_dia <span class="op">=</span> tab_perc_dia.drop(columns<span class="op">=</span>[<span class="st">"dia_pedido"</span>]).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb38-738"><a href="#cb38-738"></a></span>
<span id="cb38-739"><a href="#cb38-739"></a><span class="cf">for</span> col <span class="kw">in</span> tab_perc_dia.columns[<span class="dv">1</span>:]:  <span class="co"># Ignora a coluna 'dia_pedido'</span></span>
<span id="cb38-740"><a href="#cb38-740"></a>    tab_perc_dia[col] <span class="op">=</span> <span class="bu">round</span>((tab_perc_dia[col] <span class="op">/</span> total_dia[col]) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>)</span>
<span id="cb38-741"><a href="#cb38-741"></a></span>
<span id="cb38-742"><a href="#cb38-742"></a>tab_perc_dia.columns <span class="op">=</span> [<span class="st">'Dia do Pedido'</span>, <span class="st">'Cliente Novo'</span>, <span class="st">'Cliente Recorrente'</span>]</span>
<span id="cb38-743"><a href="#cb38-743"></a>tab_perc_dia</span>
<span id="cb38-744"><a href="#cb38-744"></a><span class="in">```</span></span>
<span id="cb38-745"><a href="#cb38-745"></a></span>
<span id="cb38-748"><a href="#cb38-748"></a><span class="in">```{r}</span></span>
<span id="cb38-749"><a href="#cb38-749"></a>py<span class="sc">$</span>df_ordem_compra <span class="sc">%&gt;%</span> </span>
<span id="cb38-750"><a href="#cb38-750"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> len_comentario, <span class="at">x =</span> <span class="fu">as_factor</span>(review_score), <span class="at">fill =</span> colocou_titulo)) <span class="sc">+</span></span>
<span id="cb38-751"><a href="#cb38-751"></a>    <span class="fu">geom_boxplot</span>()</span>
<span id="cb38-752"><a href="#cb38-752"></a><span class="in">```</span></span>
<span id="cb38-753"><a href="#cb38-753"></a></span>
<span id="cb38-756"><a href="#cb38-756"></a><span class="in">```{python}</span></span>
<span id="cb38-757"><a href="#cb38-757"></a>df_resultado <span class="op">=</span> (df_compra.groupby([<span class="st">'order_id'</span>, <span class="st">'categorias_novas_produtos'</span>])</span>
<span id="cb38-758"><a href="#cb38-758"></a>  .size()</span>
<span id="cb38-759"><a href="#cb38-759"></a>  .reset_index(name<span class="op">=</span><span class="st">'n'</span>)</span>
<span id="cb38-760"><a href="#cb38-760"></a>  .pivot(index<span class="op">=</span><span class="st">"order_id"</span>, columns<span class="op">=</span><span class="st">"categorias_novas_produtos"</span>, values<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb38-761"><a href="#cb38-761"></a>  .fillna(<span class="dv">0</span>)</span>
<span id="cb38-762"><a href="#cb38-762"></a>  .reset_index()</span>
<span id="cb38-763"><a href="#cb38-763"></a>  .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-764"><a href="#cb38-764"></a>)</span>
<span id="cb38-765"><a href="#cb38-765"></a>df_resultado[<span class="st">'itens_por_ordem'</span>] <span class="op">=</span> df_resultado.drop({<span class="st">'order_id'</span>}, axis <span class="op">=</span> <span class="st">'columns'</span>).<span class="bu">sum</span>(axis <span class="op">=</span> <span class="st">'columns'</span>)</span>
<span id="cb38-766"><a href="#cb38-766"></a></span>
<span id="cb38-767"><a href="#cb38-767"></a><span class="in">```</span></span>
<span id="cb38-768"><a href="#cb38-768"></a></span>
<span id="cb38-769"><a href="#cb38-769"></a></span>
<span id="cb38-770"><a href="#cb38-770"></a></span>
<span id="cb38-771"><a href="#cb38-771"></a><span class="fu">## Teste de Hipótese</span></span>
<span id="cb38-772"><a href="#cb38-772"></a></span>
<span id="cb38-773"><a href="#cb38-773"></a>::: callout-important</span>
<span id="cb38-774"><a href="#cb38-774"></a><span class="fu">## Ponto alvo</span></span>
<span id="cb38-775"><a href="#cb38-775"></a></span>
<span id="cb38-776"><a href="#cb38-776"></a>Variáveis que contribuiem para o aumento do valor de compra dos clientes</span>
<span id="cb38-777"><a href="#cb38-777"></a>:::</span>
<span id="cb38-778"><a href="#cb38-778"></a></span>
<span id="cb38-779"><a href="#cb38-779"></a><span class="ss">* </span>Conclusão aqui é que oferecer voucher não gera efeito significativo no aumento do valor que o cliente gasta na **Olist**.</span>
<span id="cb38-782"><a href="#cb38-782"></a><span class="in">```{r}</span></span>
<span id="cb38-783"><a href="#cb38-783"></a>data <span class="ot">=</span> py<span class="sc">$</span>df_compra_ordem</span>
<span id="cb38-784"><a href="#cb38-784"></a>data <span class="ot">=</span> data <span class="sc">%&gt;%</span></span>
<span id="cb38-785"><a href="#cb38-785"></a>  <span class="fu">select</span>(log_price, log_frete, soma_tipos_pagamentos, boleto, credit_card, debit_card,</span>
<span id="cb38-786"><a href="#cb38-786"></a>         pago_a_vista, dia_pedido, regiao_cliente, len_titulo, volume_prod,</span>
<span id="cb38-787"><a href="#cb38-787"></a>         categorias_novas_produtos, review_score, primeira_compra_cliente, voucher) <span class="sc">%&gt;%</span></span>
<span id="cb38-788"><a href="#cb38-788"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb38-789"><a href="#cb38-789"></a>  <span class="fu">mutate</span>(</span>
<span id="cb38-790"><a href="#cb38-790"></a>    <span class="at">review_score =</span> <span class="fu">as.factor</span>(review_score),</span>
<span id="cb38-791"><a href="#cb38-791"></a>    <span class="at">boleto =</span> <span class="fu">as.factor</span>(boleto),</span>
<span id="cb38-792"><a href="#cb38-792"></a>    <span class="at">credit_card =</span> <span class="fu">as.factor</span>(credit_card),</span>
<span id="cb38-793"><a href="#cb38-793"></a>    <span class="at">debit_card =</span> <span class="fu">as.factor</span>(debit_card),</span>
<span id="cb38-794"><a href="#cb38-794"></a>    <span class="at">pago_a_vista =</span> <span class="fu">as.factor</span>(pago_a_vista),</span>
<span id="cb38-795"><a href="#cb38-795"></a>    <span class="at">primeira_compra_cliente =</span> <span class="fu">as.factor</span>(primeira_compra_cliente)</span>
<span id="cb38-796"><a href="#cb38-796"></a>  )</span>
<span id="cb38-797"><a href="#cb38-797"></a></span>
<span id="cb38-798"><a href="#cb38-798"></a>fit <span class="ot">=</span> <span class="fu">aov</span>(<span class="at">formula =</span> log_price <span class="sc">~</span> </span>
<span id="cb38-799"><a href="#cb38-799"></a>            log_frete <span class="sc">+</span> soma_tipos_pagamentos <span class="sc">+</span> boleto <span class="sc">+</span> credit_card <span class="sc">+</span> debit_card <span class="sc">+</span></span>
<span id="cb38-800"><a href="#cb38-800"></a>            pago_a_vista<span class="sc">+</span>dia_pedido<span class="sc">+</span>regiao_cliente<span class="sc">+</span>len_titulo<span class="sc">+</span>volume_prod <span class="sc">+</span></span>
<span id="cb38-801"><a href="#cb38-801"></a>            categorias_novas_produtos  <span class="sc">+</span> review_score <span class="sc">+</span></span>
<span id="cb38-802"><a href="#cb38-802"></a>            primeira_compra_cliente<span class="sc">*</span>categorias_novas_produtos <span class="sc">+</span>voucher, <span class="at">data =</span> data)</span>
<span id="cb38-803"><a href="#cb38-803"></a><span class="fu">interpreta_ANOVA</span>(fit)</span>
<span id="cb38-804"><a href="#cb38-804"></a></span>
<span id="cb38-805"><a href="#cb38-805"></a><span class="fu">anova</span>(fit, <span class="fu">update</span>(fit, <span class="sc">~</span>. <span class="sc">-</span>voucher))</span>
<span id="cb38-806"><a href="#cb38-806"></a><span class="in">```</span></span>
<span id="cb38-807"><a href="#cb38-807"></a></span>
<span id="cb38-808"><a href="#cb38-808"></a><span class="fu">### Qual categoria está contribuindo mais para o valor gasto do cliente?</span></span>
<span id="cb38-809"><a href="#cb38-809"></a></span>
<span id="cb38-810"><a href="#cb38-810"></a><span class="at">&gt; Quando compara-se **TER COMPRADO ANTERIORMENTO VS CATEGORIA DE PRODUTO** (fiz um recorte para *pet-shop*)</span></span>
<span id="cb38-811"><a href="#cb38-811"></a></span>
<span id="cb38-812"><a href="#cb38-812"></a><span class="in">```{=tex}</span></span>
<span id="cb38-813"><a href="#cb38-813"></a><span class="in">\documentclass{article}</span></span>
<span id="cb38-814"><a href="#cb38-814"></a><span class="in">\usepackage{amsmath}</span></span>
<span id="cb38-815"><a href="#cb38-815"></a></span>
<span id="cb38-816"><a href="#cb38-816"></a><span class="in">\begin{document}</span></span>
<span id="cb38-817"><a href="#cb38-817"></a></span>
<span id="cb38-818"><a href="#cb38-818"></a><span class="in">\begin{eqnarray}</span></span>
<span id="cb38-819"><a href="#cb38-819"></a><span class="in">    Fator_2: \left\{</span></span>
<span id="cb38-820"><a href="#cb38-820"></a><span class="in">    \begin{array}{ll}</span></span>
<span id="cb38-821"><a href="#cb38-821"></a><span class="in">        0 &amp; \text{se o cliente já fez compras anteriores (não é a primeira compra)} \\</span></span>
<span id="cb38-822"><a href="#cb38-822"></a><span class="in">        1 &amp; \text{se o cliente está realizando sua primeira compra}</span></span>
<span id="cb38-823"><a href="#cb38-823"></a><span class="in">    \end{array}</span></span>
<span id="cb38-824"><a href="#cb38-824"></a><span class="in">    \right.</span></span>
<span id="cb38-825"><a href="#cb38-825"></a><span class="in">    \nonumber</span></span>
<span id="cb38-826"><a href="#cb38-826"></a><span class="in">\end{eqnarray}</span></span>
<span id="cb38-827"><a href="#cb38-827"></a></span>
<span id="cb38-828"><a href="#cb38-828"></a><span class="in">\end{document}</span></span>
<span id="cb38-829"><a href="#cb38-829"></a></span>
<span id="cb38-830"><a href="#cb38-830"></a><span class="in">```</span></span>
<span id="cb38-831"><a href="#cb38-831"></a></span>
<span id="cb38-832"><a href="#cb38-832"></a></span>
<span id="cb38-833"><a href="#cb38-833"></a><span class="ss">- </span>Alimento e pet-shop, se a primeira compra gasta-se mais com pet-shop, a próxima será com alimentação e vice-versa. Caso ambas estejam na mesma compra, gasta-se mais com alimentação</span>
<span id="cb38-834"><a href="#cb38-834"></a><span class="ss">- </span>Artesanato supera pet-shop sempre, exceto quando ambos são comprados em compras futuras, aí são iguais na contribuição do gasto do cliente na loja </span>
<span id="cb38-835"><a href="#cb38-835"></a><span class="ss">- </span>Itens de casa se sobressaem dos itens de pet-shop na primeira compra. Quando se gasta mais em pet-shop, parece implicar que a pessoa passa a gastar menos com itens de casa. Algo similar é concluído para eletrodomésticos, acessórios de informática e PC's.</span>
<span id="cb38-836"><a href="#cb38-836"></a><span class="ss">- </span>Pet-shop supera itens de telefonia em todos os casos de compra</span>
<span id="cb38-837"><a href="#cb38-837"></a><span class="ss">- </span>Pet-shop perde para portáteis em todos os casos de compra, ou seja, o gasto com portáteis supera esse item tanto na primeira quanto na segunda compra. </span>
<span id="cb38-838"><a href="#cb38-838"></a></span>
<span id="cb38-839"><a href="#cb38-839"></a></span>
<span id="cb38-840"><a href="#cb38-840"></a><span class="ss">- </span>Pet-shop só se sobressai de itens de beleza e saúde quando já foi comprado anteriormente</span>
<span id="cb38-841"><a href="#cb38-841"></a><span class="ss">- </span>Pet-shop sempre perde para itens de fashion (roupas), exceto quando já se tenha comprado anteriormente</span>
<span id="cb38-842"><a href="#cb38-842"></a></span>
<span id="cb38-843"><a href="#cb38-843"></a></span>
<span id="cb38-844"><a href="#cb38-844"></a>::: callout-tip</span>
<span id="cb38-845"><a href="#cb38-845"></a>**Possíveis Estratégias para vender mais itens de Pet-Shop:**</span>
<span id="cb38-846"><a href="#cb38-846"></a></span>
<span id="cb38-847"><a href="#cb38-847"></a><span class="ss">- </span>Parece que o cliente alvo para os itens de pet-shop, gasta mais com esses itens depois que estão com seus itens básicos já adquiridos em suas primeiras compras. Depois de garantir seus itens básicos e gastar com seus pets, esse cliente está mais apto a gastar mais com artesanato, 'coisas legais' e itens de viagem, por exemplo.</span>
<span id="cb38-848"><a href="#cb38-848"></a>:::</span>
<span id="cb38-849"><a href="#cb38-849"></a></span>
<span id="cb38-850"><a href="#cb38-850"></a></span>
<span id="cb38-853"><a href="#cb38-853"></a><span class="in">```{r}</span></span>
<span id="cb38-854"><a href="#cb38-854"></a><span class="co"># So categoricas aqui</span></span>
<span id="cb38-855"><a href="#cb38-855"></a>data_aov <span class="ot">=</span>  data <span class="sc">%&gt;%</span></span>
<span id="cb38-856"><a href="#cb38-856"></a>  <span class="fu">select</span>(</span>
<span id="cb38-857"><a href="#cb38-857"></a>    log_price,  <span class="co"># Inclui log_price sempre</span></span>
<span id="cb38-858"><a href="#cb38-858"></a>    <span class="fu">where</span>(<span class="sc">~</span> <span class="fu">is.factor</span>(.) <span class="sc">|</span> <span class="fu">is.character</span>(.))  <span class="co"># Seleciona as colunas categóricas</span></span>
<span id="cb38-859"><a href="#cb38-859"></a>  )</span>
<span id="cb38-860"><a href="#cb38-860"></a></span>
<span id="cb38-861"><a href="#cb38-861"></a>fit_final <span class="ot">=</span> fit <span class="ot">=</span> <span class="fu">aov</span>(<span class="at">formula =</span> log_price <span class="sc">~</span> </span>
<span id="cb38-862"><a href="#cb38-862"></a>            boleto <span class="sc">+</span> credit_card <span class="sc">+</span> debit_card <span class="sc">+</span></span>
<span id="cb38-863"><a href="#cb38-863"></a>            pago_a_vista<span class="sc">+</span>dia_pedido<span class="sc">+</span>regiao_cliente<span class="sc">+</span></span>
<span id="cb38-864"><a href="#cb38-864"></a>            categorias_novas_produtos  <span class="sc">+</span> review_score <span class="sc">+</span></span>
<span id="cb38-865"><a href="#cb38-865"></a>            primeira_compra_cliente<span class="sc">*</span>categorias_novas_produtos, <span class="at">data =</span> data_aov)</span>
<span id="cb38-866"><a href="#cb38-866"></a></span>
<span id="cb38-867"><a href="#cb38-867"></a>tukey_result_teste <span class="ot">&lt;-</span> <span class="fu">TukeyHSD</span>(fit_final)</span>
<span id="cb38-868"><a href="#cb38-868"></a>tukey_result <span class="ot">&lt;-</span> <span class="fu">Arruma_CompMult</span>(tukey_result_teste)</span>
<span id="cb38-869"><a href="#cb38-869"></a></span>
<span id="cb38-870"><a href="#cb38-870"></a>tukey_amostra <span class="ot">&lt;-</span> tukey_result<span class="sc">$</span><span class="st">`</span><span class="at">categorias_novas_produtos:primeira_compra_cliente</span><span class="st">`</span> <span class="sc">%&gt;%</span></span>
<span id="cb38-871"><a href="#cb38-871"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"PET_SHOP"</span>, Fator1))</span>
<span id="cb38-872"><a href="#cb38-872"></a></span>
<span id="cb38-873"><a href="#cb38-873"></a><span class="fu">CompMult_visual</span>(tukey_amostra)</span>
<span id="cb38-874"><a href="#cb38-874"></a><span class="in">```</span></span>
<span id="cb38-875"><a href="#cb38-875"></a></span>
<span id="cb38-876"><a href="#cb38-876"></a>**Abaixo será feita uma análise marginal de pet-shop, ou seja, desconsiderando a ordem da compra:**</span>
<span id="cb38-877"><a href="#cb38-877"></a></span>
<span id="cb38-878"><a href="#cb38-878"></a>Aqui vemos uma análise mais direta do que já foi concluído acima: </span>
<span id="cb38-879"><a href="#cb38-879"></a></span>
<span id="cb38-880"><a href="#cb38-880"></a><span class="ss">- </span>Gasta-se mais com Pet-shop em relação a itens de consumo domésticos</span>
<span id="cb38-881"><a href="#cb38-881"></a><span class="ss">- </span>Gasta-se menos com Pet-shop em relação a itens de desejo, como artigos de viagem e artesanato</span>
<span id="cb38-882"><a href="#cb38-882"></a></span>
<span id="cb38-885"><a href="#cb38-885"></a><span class="in">```{r}</span></span>
<span id="cb38-886"><a href="#cb38-886"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb38-887"><a href="#cb38-887"></a>  tukey_result<span class="sc">$</span>categorias_novas_produtos<span class="sc">%&gt;%</span></span>
<span id="cb38-888"><a href="#cb38-888"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"PET_SHOP"</span>, Fator1))</span>
<span id="cb38-889"><a href="#cb38-889"></a>  )</span>
<span id="cb38-890"><a href="#cb38-890"></a><span class="in">```</span></span>
<span id="cb38-891"><a href="#cb38-891"></a></span>
<span id="cb38-892"><a href="#cb38-892"></a><span class="fu">## Outras análises mais diretas:</span></span>
<span id="cb38-893"><a href="#cb38-893"></a></span>
<span id="cb38-894"><a href="#cb38-894"></a><span class="fu">### Gasto vs Avaliação {#sec-gasto_ava}</span></span>
<span id="cb38-895"><a href="#cb38-895"></a></span>
<span id="cb38-896"><a href="#cb38-896"></a><span class="ss">- </span>Clientes que gastam mais ou em produtos mais caros tendem a gostar mais de sua experiência de compra</span>
<span id="cb38-897"><a href="#cb38-897"></a><span class="ss">- </span>**Clientes que avaliam em nota máxima e mínima gastam de forma igual. Isso pode ser indicativo que há outras variáveis que se associam ao gasto e a satisfação do cliente**</span>
<span id="cb38-900"><a href="#cb38-900"></a><span class="in">```{r}</span></span>
<span id="cb38-901"><a href="#cb38-901"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb38-902"><a href="#cb38-902"></a>  tukey_result<span class="sc">$</span>review_score</span>
<span id="cb38-903"><a href="#cb38-903"></a>  )</span>
<span id="cb38-904"><a href="#cb38-904"></a><span class="in">```</span></span>
<span id="cb38-905"><a href="#cb38-905"></a></span>
<span id="cb38-906"><a href="#cb38-906"></a><span class="fu">### Gasto vs Primeira compra </span></span>
<span id="cb38-907"><a href="#cb38-907"></a></span>
<span id="cb38-908"><a href="#cb38-908"></a><span class="ss">- </span>De fato, gasta-se mais na primeira compra. Como a @sec-gasto_ava mostrou que satisfação não está associada ao gasto, é importante garantir outros incentivos além da boa experiência para o cliente na sua compra.</span>
<span id="cb38-911"><a href="#cb38-911"></a><span class="in">```{r}</span></span>
<span id="cb38-912"><a href="#cb38-912"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb38-913"><a href="#cb38-913"></a>  tukey_result<span class="sc">$</span>primeira_compra_cliente</span>
<span id="cb38-914"><a href="#cb38-914"></a>  )</span>
<span id="cb38-915"><a href="#cb38-915"></a><span class="in">```</span></span>
<span id="cb38-916"><a href="#cb38-916"></a></span>
<span id="cb38-917"><a href="#cb38-917"></a><span class="fu">### Gasto vs Região</span></span>
<span id="cb38-918"><a href="#cb38-918"></a></span>
<span id="cb38-919"><a href="#cb38-919"></a>Em relação aos gastos:</span>
<span id="cb38-920"><a href="#cb38-920"></a></span>
<span id="cb38-921"><a href="#cb38-921"></a>$$NorteNordeste &gt;  Sudeste-SP = Centro-Oeste &gt; Sul &gt; SP$$</span>
<span id="cb38-922"><a href="#cb38-922"></a></span>
<span id="cb38-923"><a href="#cb38-923"></a><span class="ss">* </span>Nesse caso, também indicou que $Sudeste-SP = Sul$ mas $Centro-Oeste \neq Sul$ o que é um pouco contraintuitivo, mas talvez numa amostra maior, ou considerando interações, seria possível afirmar em quais condições faz com que Centro-Oeste e Sul se diferenciem.</span>
<span id="cb38-924"><a href="#cb38-924"></a></span>
<span id="cb38-927"><a href="#cb38-927"></a><span class="in">```{r}</span></span>
<span id="cb38-928"><a href="#cb38-928"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb38-929"><a href="#cb38-929"></a>  tukey_result<span class="sc">$</span>regiao_cliente</span>
<span id="cb38-930"><a href="#cb38-930"></a>  )</span>
<span id="cb38-931"><a href="#cb38-931"></a><span class="in">```</span></span>
<span id="cb38-932"><a href="#cb38-932"></a></span>
<span id="cb38-933"><a href="#cb38-933"></a><span class="fu">### Gasto vs Dia da compra</span></span>
<span id="cb38-934"><a href="#cb38-934"></a></span>
<span id="cb38-935"><a href="#cb38-935"></a>Domingo é o pior dia de compra, quando pensa-se em gasto médio, seguido por sábado.</span>
<span id="cb38-936"><a href="#cb38-936"></a></span>
<span id="cb38-939"><a href="#cb38-939"></a><span class="in">```{r}</span></span>
<span id="cb38-940"><a href="#cb38-940"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb38-941"><a href="#cb38-941"></a>  tukey_result<span class="sc">$</span>dia_pedido</span>
<span id="cb38-942"><a href="#cb38-942"></a>  )</span>
<span id="cb38-943"><a href="#cb38-943"></a><span class="in">```</span></span>
<span id="cb38-944"><a href="#cb38-944"></a></span>
<span id="cb38-945"><a href="#cb38-945"></a><span class="fu">### Gasto vs Forma de pagamento</span></span>
<span id="cb38-946"><a href="#cb38-946"></a></span>
<span id="cb38-947"><a href="#cb38-947"></a><span class="ss">* </span>Pessoas que optam por boleto, gastam menos</span>
<span id="cb38-948"><a href="#cb38-948"></a></span>
<span id="cb38-951"><a href="#cb38-951"></a><span class="in">```{r}</span></span>
<span id="cb38-952"><a href="#cb38-952"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb38-953"><a href="#cb38-953"></a>  tukey_result<span class="sc">$</span>boleto</span>
<span id="cb38-954"><a href="#cb38-954"></a>  )</span>
<span id="cb38-955"><a href="#cb38-955"></a><span class="in">```</span></span>
<span id="cb38-956"><a href="#cb38-956"></a></span>
<span id="cb38-957"><a href="#cb38-957"></a><span class="ss">* </span>Pessoas que optam por cartão de crédito e a usam em mais parcelas, gastam mais</span>
<span id="cb38-958"><a href="#cb38-958"></a></span>
<span id="cb38-961"><a href="#cb38-961"></a><span class="in">```{r}</span></span>
<span id="cb38-962"><a href="#cb38-962"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb38-963"><a href="#cb38-963"></a>  tukey_result<span class="sc">$</span>credit_card</span>
<span id="cb38-964"><a href="#cb38-964"></a>  )</span>
<span id="cb38-965"><a href="#cb38-965"></a><span class="in">```</span></span>
<span id="cb38-966"><a href="#cb38-966"></a></span>
<span id="cb38-967"><a href="#cb38-967"></a><span class="ss">* </span>Pessoas que optam por cartão de débito, gastam mais</span>
<span id="cb38-968"><a href="#cb38-968"></a></span>
<span id="cb38-971"><a href="#cb38-971"></a><span class="in">```{r}</span></span>
<span id="cb38-972"><a href="#cb38-972"></a><span class="fu">CompMult_visual</span>(</span>
<span id="cb38-973"><a href="#cb38-973"></a>  tukey_result<span class="sc">$</span>debit_card</span>
<span id="cb38-974"><a href="#cb38-974"></a>  )</span>
<span id="cb38-975"><a href="#cb38-975"></a><span class="in">```</span></span>
<span id="cb38-976"><a href="#cb38-976"></a></span>
<span id="cb38-977"><a href="#cb38-977"></a>::: callout-tip</span>
<span id="cb38-978"><a href="#cb38-978"></a>**Possíveis Estratégias para vender mais itens de Pet-Shop nas demais análises:**</span>
<span id="cb38-979"><a href="#cb38-979"></a></span>
<span id="cb38-980"><a href="#cb38-980"></a><span class="ss">- </span>Incentivar o uso do cartão de crédito e parcelado poderia gerar mais oportunidade do cliente gastar mais na loja. Promoções no meio de semana são igualmente eficazes para aumentar o ticket-médio do cliente. Aproveitar a primeira compra do cliente para arrecadar mais em sua compra, mas também garantir que ele volte para gastar com itens de desejo ao invés de apenas artigos de necessidade-imediata refletirão de forma positiva no gasto do cliente na loja. Por fim, aumentar a exposição no mercado Norte-Nordeste parece gerar um crescimento mais significativo que nas demais regiões.</span>
<span id="cb38-981"><a href="#cb38-981"></a></span>
<span id="cb38-982"><a href="#cb38-982"></a>:::</span>
<span id="cb38-983"><a href="#cb38-983"></a></span>
<span id="cb38-984"><a href="#cb38-984"></a></span>
<span id="cb38-987"><a href="#cb38-987"></a><span class="in">```{python}</span></span>
<span id="cb38-988"><a href="#cb38-988"></a><span class="co"># (df_prod_final</span></span>
<span id="cb38-989"><a href="#cb38-989"></a><span class="co">#     .groupby(["categorias_novas_produtos"])</span></span>
<span id="cb38-990"><a href="#cb38-990"></a><span class="co">#     .size()</span></span>
<span id="cb38-991"><a href="#cb38-991"></a><span class="co">#     .reset_index(name="n")</span></span>
<span id="cb38-992"><a href="#cb38-992"></a><span class="co">#     .pivot(index="product_id", columns="payment_type", values="n")</span></span>
<span id="cb38-993"><a href="#cb38-993"></a><span class="co">#     .fillna(0)</span></span>
<span id="cb38-994"><a href="#cb38-994"></a><span class="co">#     .reset_index()</span></span>
<span id="cb38-995"><a href="#cb38-995"></a><span class="co">#     .rename_axis(None, axis=1)</span></span>
<span id="cb38-996"><a href="#cb38-996"></a><span class="co"># )</span></span>
<span id="cb38-997"><a href="#cb38-997"></a><span class="in">```</span></span>
<span id="cb38-998"><a href="#cb38-998"></a></span>
<span id="cb38-999"><a href="#cb38-999"></a><span class="fu"># Componenentes Principais para o Cliente</span></span>
<span id="cb38-1000"><a href="#cb38-1000"></a></span>
<span id="cb38-1003"><a href="#cb38-1003"></a><span class="in">```{python}</span></span>
<span id="cb38-1004"><a href="#cb38-1004"></a>df_pca_dummy <span class="op">=</span> pd.get_dummies(df_final[<span class="st">'regiao_cliente'</span>], dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb38-1005"><a href="#cb38-1005"></a>df_pca <span class="op">=</span> pd.concat([df_final.drop(<span class="st">'regiao_cliente'</span>, axis<span class="op">=</span><span class="dv">1</span>), df_pca_dummy], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-1006"><a href="#cb38-1006"></a></span>
<span id="cb38-1007"><a href="#cb38-1007"></a>colunas_pca <span class="op">=</span> [<span class="st">'boleto'</span>, <span class="st">'credit_card'</span>, <span class="st">'debit_card'</span>, <span class="st">'voucher'</span>,</span>
<span id="cb38-1008"><a href="#cb38-1008"></a>       <span class="st">'soma_tipos_pagamentos'</span>, <span class="st">'log_valor_pago'</span>, <span class="st">'pago_a_vista'</span>,</span>
<span id="cb38-1009"><a href="#cb38-1009"></a>       <span class="st">'log_valor_medio_parcela'</span>,<span class="st">'tempo_conf_pedido'</span>, <span class="st">'atraso_prev_entrega'</span>,</span>
<span id="cb38-1010"><a href="#cb38-1010"></a>       <span class="st">'review_score'</span>, <span class="st">'len_titulo'</span>, <span class="st">'len_comentario'</span>,<span class="st">'comentario_exc'</span>, <span class="st">'colocou_titulo'</span>,</span>
<span id="cb38-1011"><a href="#cb38-1011"></a>       <span class="st">'colocou_exc'</span>,<span class="st">'primeira_compra_cliente'</span>,<span class="st">'log_price'</span>, <span class="st">'log_frete'</span>,</span>
<span id="cb38-1012"><a href="#cb38-1012"></a>       <span class="st">'product_name_lenght'</span>, <span class="st">'product_description_lenght'</span>,</span>
<span id="cb38-1013"><a href="#cb38-1013"></a>       <span class="st">'product_photos_qty'</span>, <span class="st">'product_weight_g'</span>, <span class="st">'product_length_cm'</span>,</span>
<span id="cb38-1014"><a href="#cb38-1014"></a>       <span class="st">'product_height_cm'</span>, <span class="st">'product_width_cm'</span>, <span class="st">'volume_prod'</span>, <span class="st">'ALIMENTO'</span>,</span>
<span id="cb38-1015"><a href="#cb38-1015"></a>       <span class="st">'ARTESANATO_LEGAL'</span>, <span class="st">'AUTOMOTIVO'</span>, <span class="st">'BEBES'</span>, <span class="st">'BELEZA_SAUDE'</span>, <span class="st">'BRINQUEDOS'</span>,</span>
<span id="cb38-1016"><a href="#cb38-1016"></a>       <span class="st">'CASA'</span>, <span class="st">'CONSTRUCAO_FERRAMENTAS'</span>, <span class="st">'ELETRODOMESTICOS'</span>, <span class="st">'ESPORTE_LAZER'</span>,</span>
<span id="cb38-1017"><a href="#cb38-1017"></a>       <span class="st">'EVENTO'</span>, <span class="st">'FASHION'</span>, <span class="st">'INDUSTRIA'</span>, <span class="st">'INFORMATICA_ACESSORIOS'</span>,</span>
<span id="cb38-1018"><a href="#cb38-1018"></a>       <span class="st">'MALAS_ACESSORIOS'</span>, <span class="st">'MARKET_PLACE'</span>, <span class="st">'MIDIA_MUSICA'</span>, <span class="st">'MOVEIS'</span>,</span>
<span id="cb38-1019"><a href="#cb38-1019"></a>       <span class="st">'PAPELARIA'</span>, <span class="st">'PC'</span>, <span class="st">'PERFUMARIA'</span>, <span class="st">'PET_SHOP'</span>, <span class="st">'PORTATEIS'</span>,</span>
<span id="cb38-1020"><a href="#cb38-1020"></a>       <span class="st">'RELOGIOS_PRESENTES'</span>, <span class="st">'SEGURANCA'</span>, <span class="st">'TELEFONIA'</span>]</span>
<span id="cb38-1021"><a href="#cb38-1021"></a></span>
<span id="cb38-1022"><a href="#cb38-1022"></a><span class="co"># Imputando dados faltantes - df_pca[colunas_pca].isnull().sum()</span></span>
<span id="cb38-1023"><a href="#cb38-1023"></a>df_pca.loc[:, [<span class="st">'product_weight_g'</span>, <span class="st">'product_length_cm'</span>,<span class="st">'product_height_cm'</span>,<span class="st">'product_width_cm'</span>]] <span class="op">=</span> (</span>
<span id="cb38-1024"><a href="#cb38-1024"></a>  inpute.fit_transform(df_pca[[<span class="st">'product_weight_g'</span>,<span class="st">'product_length_cm'</span>,<span class="st">'product_height_cm'</span>,<span class="st">'product_width_cm'</span>]])</span>
<span id="cb38-1025"><a href="#cb38-1025"></a>  )</span>
<span id="cb38-1026"><a href="#cb38-1026"></a></span>
<span id="cb38-1027"><a href="#cb38-1027"></a></span>
<span id="cb38-1028"><a href="#cb38-1028"></a><span class="co">#df_final.customer_unique_id </span></span>
<span id="cb38-1029"><a href="#cb38-1029"></a>x_treino <span class="op">=</span> df_pca[colunas_pca]</span>
<span id="cb38-1030"><a href="#cb38-1030"></a></span>
<span id="cb38-1031"><a href="#cb38-1031"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb38-1032"><a href="#cb38-1032"></a></span>
<span id="cb38-1033"><a href="#cb38-1033"></a>pca <span class="op">=</span> PCA()</span>
<span id="cb38-1034"><a href="#cb38-1034"></a>X_train_pca <span class="op">=</span> pca.fit_transform(</span>
<span id="cb38-1035"><a href="#cb38-1035"></a>  scaler.fit_transform(x_treino) <span class="co"># dados reescalados</span></span>
<span id="cb38-1036"><a href="#cb38-1036"></a>  )</span>
<span id="cb38-1037"><a href="#cb38-1037"></a></span>
<span id="cb38-1038"><a href="#cb38-1038"></a>per_var <span class="op">=</span> np.<span class="bu">round</span>(pca.explained_variance_ratio_<span class="op">*</span><span class="dv">100</span>, decimals<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-1039"><a href="#cb38-1039"></a>labels <span class="op">=</span> [<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(per_var)<span class="op">+</span><span class="dv">1</span>)]</span>
<span id="cb38-1040"><a href="#cb38-1040"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb38-1041"><a href="#cb38-1041"></a><span class="co">#plot scree plot</span></span>
<span id="cb38-1042"><a href="#cb38-1042"></a>plt.bar(x<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(per_var)<span class="op">+</span><span class="dv">1</span>), height<span class="op">=</span>per_var)</span>
<span id="cb38-1043"><a href="#cb38-1043"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, which <span class="op">=</span> <span class="st">'both'</span>, bottom<span class="op">=</span><span class="va">False</span>, top<span class="op">=</span><span class="va">False</span>, labelbottom<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb38-1044"><a href="#cb38-1044"></a>plt.ylabel(<span class="st">"Explained variance (%)"</span>)</span>
<span id="cb38-1045"><a href="#cb38-1045"></a>plt.xlabel(<span class="st">'Principal Components'</span>)</span>
<span id="cb38-1046"><a href="#cb38-1046"></a>plt.title(<span class="st">'Scree Plot'</span>)</span>
<span id="cb38-1047"><a href="#cb38-1047"></a>plt.show()</span>
<span id="cb38-1048"><a href="#cb38-1048"></a></span>
<span id="cb38-1049"><a href="#cb38-1049"></a></span>
<span id="cb38-1050"><a href="#cb38-1050"></a></span>
<span id="cb38-1051"><a href="#cb38-1051"></a><span class="in">```</span></span>
</code><button title="Copiar para a área de transferência" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>